<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Outpatient Chamber EMR - Doctor Module</title>
  
  <!-- Styling and Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Dexie.js for IndexedDB -->
  <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
  
  <!-- jsPDF for Prescription Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f4f8;
    }
    .glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .soft-shadow {
      box-shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.05);
    }
    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e40af;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #dbeafe;
    }
    .modal-overlay {
        animation: fadeIn 0.2s ease-out;
    }
    .modal-content {
        animation: fadeInScale 0.3s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes fadeInScale {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    .tab-btn.active {
        border-bottom-color: #1e40af;
        color: #1e40af;
        font-weight: 600;
    }
    .tab-btn {
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease-in-out;
    }
     .quick-pick-btn {
        padding: 0.5rem 0.75rem;
        background-color: #e2e8f0;
        color: #475569;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        transition: all 0.2s;
        cursor: pointer;
        user-select: none;
    }
    .quick-pick-btn:hover {
        background-color: #dbeafe;
        color: #1d4ed8;
    }
    .quick-pick-btn.selected {
        background-color: #2563eb;
        color: white;
        font-weight: 600;
        box-shadow: 0 0 0 2px #1d4ed8;
    }
    .prose-sm ul { padding-left: 1.25rem; }
    .label-text { 
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.25rem;
    }
    .input-field { 
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background-color: white;
    }


    /* Print-specific styles for prescription */
    @media print {
        body * {
            visibility: hidden;
        }
        #prescription-print-area, #prescription-print-area * {
            visibility: visible;
        }
        #prescription-print-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
    }
    
    /* Advanced Examination Styles */
    .temp-group, .bp-entry-row, .pulse-grid, .sided-grid {
        display: grid;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .temp-group {
        grid-template-columns: 1fr auto;
    }
    
    .bp-entry-row {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
    
    .pulse-grid {
        grid-template-columns: 1fr 1fr 1fr;
    }
    
    .sided-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .unit-toggle {
        display: flex;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        overflow: hidden;
    }
    
    .temp-unit {
        padding: 0.5rem 1rem;
        border: none;
        background: #f3f4f6;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .temp-unit.active {
        background: #3b82f6;
        color: white;
    }
    
    .finding-input, .finding-select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }
    
    .finding-label {
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.25rem;
        display: block;
    }
    
    .score-container {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .score-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .calculate-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    
    .calculate-btn:hover {
        background: #2563eb;
    }
    
    .score-result {
        background: #dbeafe;
        border: 1px solid #93c5fd;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-top: 1rem;
    }
    
    .lymph-item {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 0.5rem;
        align-items: center;
        padding: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .lymph-item:last-child {
        border-bottom: none;
    }
    
    .sub-finding-group {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 0.5rem;
    }
    
    .finding-input-wrapper.clone {
        position: relative;
        padding: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
    }
    
    .delete-clone-btn {
        position: absolute;
        right: -25px;
        top: 50%;
        transform: translateY(-50%);
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .add-finding-btn {
        background: #10b981;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .finding-label-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    /* Investigation Section Styles */
    .investigation-result {
        transition: all 0.2s ease-in-out;
    }
    
    .investigation-result:hover {
        background-color: #f1f5f9;
        transform: translateX(2px);
    }
    
    .investigation-result:last-child {
        border-bottom: none;
    }
    
    #search-results {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .remove-investigation-btn {
        transition: all 0.2s ease-in-out;
    }
    
    .remove-investigation-btn:hover {
        transform: scale(1.1);
    }
  </style>
</head>
<body class="antialiased text-slate-800">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Outpatient Chamber EMR - Doctor Module</title>
  
  <!-- Styling and Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Dexie.js for IndexedDB -->
  <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
  
  <!-- jsPDF for Prescription Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f4f8;
    }
    .glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .soft-shadow {
      box-shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.05);
    }
    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e40af;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #dbeafe;
    }
    .modal-overlay {
        animation: fadeIn 0.2s ease-out;
    }
    .modal-content {
        animation: fadeInScale 0.3s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes fadeInScale {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    .tab-btn.active {
        border-bottom-color: #1e40af;
        color: #1e40af;
        font-weight: 600;
    }
    .tab-btn {
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease-in-out;
    }
     .quick-pick-btn {
        padding: 0.5rem 0.75rem;
        background-color: #e2e8f0;
        color: #475569;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        transition: all 0.2s;
        cursor: pointer;
        user-select: none;
    }
    .quick-pick-btn:hover {
        background-color: #dbeafe;
        color: #1d4ed8;
    }
    .quick-pick-btn.selected {
        background-color: #2563eb;
        color: white;
        font-weight: 600;
        box-shadow: 0 0 0 2px #1d4ed8;
    }
    .prose-sm ul { padding-left: 1.25rem; }
    .label-text { 
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.25rem;
    }
    .input-field { 
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background-color: white;
    }


    /* Print-specific styles for prescription */
    @media print {
        body * {
            visibility: hidden;
        }
        #prescription-print-area, #prescription-print-area * {
            visibility: visible;
        }
        #prescription-print-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
    }
    
    /* Advanced Examination Styles */
    .temp-group, .bp-entry-row, .pulse-grid, .sided-grid {
        display: grid;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .temp-group {
        grid-template-columns: 1fr auto;
    }
    
    .bp-entry-row {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
    
    .pulse-grid {
        grid-template-columns: 1fr 1fr 1fr;
    }
    
    .sided-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .unit-toggle {
        display: flex;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        overflow: hidden;
    }
    
    .temp-unit {
        padding: 0.5rem 1rem;
        border: none;
        background: #f3f4f6;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .temp-unit.active {
        background: #3b82f6;
        color: white;
    }
    
    .finding-input, .finding-select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }
    
    .finding-label {
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.25rem;
        display: block;
    }
    
    .score-container {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .score-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .calculate-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    
    .calculate-btn:hover {
        background: #2563eb;
    }
    
    .score-result {
        background: #dbeafe;
        border: 1px solid #93c5fd;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-top: 1rem;
    }
    
    .lymph-item {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 0.5rem;
        align-items: center;
        padding: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .lymph-item:last-child {
        border-bottom: none;
    }
    
    .sub-finding-group {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 0.5rem;
    }
    
    .finding-input-wrapper.clone {
        position: relative;
        padding: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
    }
    
    .delete-clone-btn {
        position: absolute;
        right: -25px;
        top: 50%;
        transform: translateY(-50%);
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .add-finding-btn {
        background: #10b981;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .finding-label-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    /* Investigation Section Styles */
    .investigation-result {
        transition: all 0.2s ease-in-out;
    }
    
    .investigation-result:hover {
        background-color: #f1f5f9;
        transform: translateX(2px);
    }
    
    .investigation-result:last-child {
        border-bottom: none;
    }
    
    #search-results {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .remove-investigation-btn {
        transition: all 0.2s ease-in-out;
    }
    
    .remove-investigation-btn:hover {
        transform: scale(1.1);
    }
  </style>
</head>
<body class="antialiased text-slate-800">

  <!-- Main Application Container -->
  <div id="app-container">
    <!-- This will be dynamically populated by the router -->
  </div>

  <!-- Modal Container -->
  <div id="modal-container"></div>

  <!-- All JavaScript logic is contained here -->
  <script>
    // --- Auto-load medicine-data.json if present and merge into MOCK_DATA.MEDICINE_DATABASE ---
    async function loadExternalMedicineDatabase() {
      try {
        const response = await fetch('medicine-data.json');
        if (!response.ok) return null;
        const data = await response.json();
        if (data.generics && data.brandNames) {
          window.MOCK_DATA = window.MOCK_DATA || {};
          window.MOCK_DATA.MEDICINE_DATABASE = data;
        }
      } catch (e) {
        // File not found or invalid JSON
      }
    }
    // Call before app.init()
    (async () => {
      await loadExternalMedicineDatabase();
    // ===================================================================================
    //  DATABASE & MOCK DATA
    // ===================================================================================
    const db = new Dexie('DoctorModuleEMR_v8'); // Version bump for schema changes
    db.version(1).stores({
      doctors: '++id, &username, name, specialty',
      assistants: '++id, &username',
      patients: '++id, &uid, *name, gender, dob, phone',
      appointments: '++id, patientId, doctorId, date, timeSlot, status',
      consultations: '++id, appointmentId, patientId, doctorId, data',
    });

    const MOCK_DATA = {
        DOCTORS: [
            { id: 1, username: 'dr.rahman', password: 'password', name: 'Dr. Ashikur Rahman', specialty: 'Cardiology', bmdc: 'BMDC-12345', title: 'MBBS, FCPS (Cardiology)', contact: '+8801712345678' },
            { id: 2, username: 'dr.sultana', password: 'password', name: 'Dr. Fatima Sultana', specialty: 'Neurology', bmdc: 'BMDC-54321', title: 'MBBS, MD (Neurology)', contact: '+8801812345678' }
        ],
        ASSISTANTS: [
            { id: 1, username: 'assistant1', password: 'password' }
        ],
        INVESTIGATIONS: ['CBC', 'Serum Creatinine', 'ECG', 'Chest X-ray P/A View', 'MRI of Brain'],
        MEDICINES: ['Tab. Paracetamol 500mg', 'Cap. Amoxicillin 500mg', 'Tab. Atorvastatin 20mg', 'Tab. Metformin 500mg'],
        MEDICINE_DATABASE: {
            generics: {
                "Paracetamol": {
                    formulations: ["Tablet", "Syrup", "Suspension", "Suppository"],
                    strengths: ["500mg", "650mg", "1000mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Amoxicillin": {
                    formulations: ["Capsule", "Tablet", "Syrup", "Suspension"],
                    strengths: ["250mg", "500mg", "875mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Metformin": {
                    formulations: ["Tablet", "Sustained Release"],
                    strengths: ["500mg", "850mg", "1000mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Atorvastatin": {
                    formulations: ["Tablet"],
                    strengths: ["10mg", "20mg", "40mg", "80mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Omeprazole": {
                    formulations: ["Capsule", "Tablet"],
                    strengths: ["20mg", "40mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Amlodipine": {
                    formulations: ["Tablet"],
                    strengths: ["2.5mg", "5mg", "10mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Losartan": {
                    formulations: ["Tablet"],
                    strengths: ["25mg", "50mg", "100mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Gliclazide": {
                    formulations: ["Tablet"],
                    strengths: ["30mg", "60mg", "80mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Ciprofloxacin": {
                    formulations: ["Tablet", "Syrup"],
                    strengths: ["250mg", "500mg", "750mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Azithromycin": {
                    formulations: ["Tablet", "Suspension"],
                    strengths: ["250mg", "500mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Ibuprofen": {
                    formulations: ["Tablet", "Syrup", "Suspension"],
                    strengths: ["200mg", "400mg", "600mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Diclofenac": {
                    formulations: ["Tablet", "Gel", "Injection"],
                    strengths: ["25mg", "50mg", "75mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Cetirizine": {
                    formulations: ["Tablet", "Syrup"],
                    strengths: ["10mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Montelukast": {
                    formulations: ["Tablet", "Granules"],
                    strengths: ["4mg", "5mg", "10mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Salbutamol": {
                    formulations: ["Tablet", "Syrup", "Inhaler"],
                    strengths: ["2mg", "4mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Furosemide": {
                    formulations: ["Tablet", "Injection"],
                    strengths: ["20mg", "40mg", "80mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Spironolactone": {
                    formulations: ["Tablet"],
                    strengths: ["25mg", "50mg", "100mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Warfarin": {
                    formulations: ["Tablet"],
                    strengths: ["1mg", "2mg", "3mg", "5mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Aspirin": {
                    formulations: ["Tablet"],
                    strengths: ["75mg", "100mg", "300mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Clopidogrel": {
                    formulations: ["Tablet"],
                    strengths: ["75mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Lisinopril": {
                    formulations: ["Tablet"],
                    strengths: ["2.5mg", "5mg", "10mg", "20mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Bisoprolol": {
                    formulations: ["Tablet"],
                    strengths: ["2.5mg", "5mg", "10mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                // Additional Common Bangladeshi Medicines
                "Ranitidine": {
                    formulations: ["Tablet", "Syrup", "Injection"],
                    strengths: ["150mg", "300mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Pantoprazole": {
                    formulations: ["Tablet", "Injection"],
                    strengths: ["20mg", "40mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Domperidone": {
                    formulations: ["Tablet", "Syrup"],
                    strengths: ["10mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Ondansetron": {
                    formulations: ["Tablet", "Syrup", "Injection"],
                    strengths: ["4mg", "8mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Metronidazole": {
                    formulations: ["Tablet", "Syrup", "Injection"],
                    strengths: ["200mg", "400mg", "500mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Cefixime": {
                    formulations: ["Tablet", "Syrup"],
                    strengths: ["100mg", "200mg", "400mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Ceftriaxone": {
                    formulations: ["Injection"],
                    strengths: ["250mg", "500mg", "1g", "2g"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Gentamicin": {
                    formulations: ["Injection", "Eye/Ear Drops"],
                    strengths: ["40mg/ml", "80mg/2ml"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Dexamethasone": {
                    formulations: ["Tablet", "Injection", "Eye Drops"],
                    strengths: ["0.5mg", "1mg", "4mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Prednisolone": {
                    formulations: ["Tablet", "Syrup"],
                    strengths: ["5mg", "10mg", "20mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Levothyroxine": {
                    formulations: ["Tablet"],
                    strengths: ["25mcg", "50mcg", "75mcg", "100mcg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Carbamazepine": {
                    formulations: ["Tablet"],
                    strengths: ["100mg", "200mg", "400mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Phenytoin": {
                    formulations: ["Tablet", "Injection"],
                    strengths: ["50mg", "100mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Diazepam": {
                    formulations: ["Tablet", "Injection"],
                    strengths: ["2mg", "5mg", "10mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Alprazolam": {
                    formulations: ["Tablet"],
                    strengths: ["0.25mg", "0.5mg", "1mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Sertraline": {
                    formulations: ["Tablet"],
                    strengths: ["25mg", "50mg", "100mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Fluoxetine": {
                    formulations: ["Tablet", "Capsule"],
                    strengths: ["10mg", "20mg", "40mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Amitriptyline": {
                    formulations: ["Tablet"],
                    strengths: ["10mg", "25mg", "50mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Chlorpheniramine": {
                    formulations: ["Tablet", "Syrup"],
                    strengths: ["4mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Loratadine": {
                    formulations: ["Tablet", "Syrup"],
                    strengths: ["10mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Fexofenadine": {
                    formulations: ["Tablet"],
                    strengths: ["120mg", "180mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Budesonide": {
                    formulations: ["Inhaler", "Nebulizer"],
                    strengths: ["100mcg", "200mcg", "400mcg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Formoterol": {
                    formulations: ["Inhaler"],
                    strengths: ["6mcg", "12mcg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Tiotropium": {
                    formulations: ["Inhaler"],
                    strengths: ["18mcg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Theophylline": {
                    formulations: ["Tablet", "Syrup"],
                    strengths: ["100mg", "200mg", "300mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Nifedipine": {
                    formulations: ["Tablet", "Sustained Release"],
                    strengths: ["10mg", "20mg", "30mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Diltiazem": {
                    formulations: ["Tablet", "Sustained Release"],
                    strengths: ["30mg", "60mg", "90mg", "120mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Verapamil": {
                    formulations: ["Tablet", "Sustained Release"],
                    strengths: ["40mg", "80mg", "120mg", "240mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Digoxin": {
                    formulations: ["Tablet", "Injection"],
                    strengths: ["0.125mg", "0.25mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Nitroglycerin": {
                    formulations: ["Tablet", "Spray", "Ointment"],
                    strengths: ["0.4mg", "0.6mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Isosorbide": {
                    formulations: ["Tablet"],
                    strengths: ["5mg", "10mg", "20mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Simvastatin": {
                    formulations: ["Tablet"],
                    strengths: ["10mg", "20mg", "40mg", "80mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Rosuvastatin": {
                    formulations: ["Tablet"],
                    strengths: ["5mg", "10mg", "20mg", "40mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Fenofibrate": {
                    formulations: ["Tablet", "Capsule"],
                    strengths: ["67mg", "134mg", "200mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Glimepiride": {
                    formulations: ["Tablet"],
                    strengths: ["1mg", "2mg", "3mg", "4mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Pioglitazone": {
                    formulations: ["Tablet"],
                    strengths: ["15mg", "30mg", "45mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Sitagliptin": {
                    formulations: ["Tablet"],
                    strengths: ["25mg", "50mg", "100mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Vildagliptin": {
                    formulations: ["Tablet"],
                    strengths: ["50mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Linagliptin": {
                    formulations: ["Tablet"],
                    strengths: ["5mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Empagliflozin": {
                    formulations: ["Tablet"],
                    strengths: ["10mg", "25mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Dapagliflozin": {
                    formulations: ["Tablet"],
                    strengths: ["5mg", "10mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Canagliflozin": {
                    formulations: ["Tablet"],
                    strengths: ["100mg", "300mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Insulin Regular": {
                    formulations: ["Injection"],
                    strengths: ["100 units/ml"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Insulin NPH": {
                    formulations: ["Injection"],
                    strengths: ["100 units/ml"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Insulin Glargine": {
                    formulations: ["Injection"],
                    strengths: ["100 units/ml"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Insulin Lispro": {
                    formulations: ["Injection"],
                    strengths: ["100 units/ml"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Insulin Aspart": {
                    formulations: ["Injection"],
                    strengths: ["100 units/ml"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Calcium Carbonate": {
                    formulations: ["Tablet", "Syrup"],
                    strengths: ["500mg", "1000mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Vitamin D3": {
                    formulations: ["Tablet", "Capsule", "Syrup"],
                    strengths: ["400IU", "1000IU", "2000IU", "5000IU"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Folic Acid": {
                    formulations: ["Tablet"],
                    strengths: ["5mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Iron Sulfate": {
                    formulations: ["Tablet", "Syrup"],
                    strengths: ["200mg", "325mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Zinc Sulfate": {
                    formulations: ["Tablet", "Syrup"],
                    strengths: ["20mg", "50mg"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                },
                "Multivitamin": {
                    formulations: ["Tablet", "Syrup", "Capsule"],
                    strengths: ["Standard", "Plus Minerals"],
                    companies: ["Square Pharmaceuticals", "Beximco Pharmaceuticals", "Incepta Pharmaceuticals", "ACI Limited", "Generic"]
                }
            },
            brandNames: {
                // Paracetamol
                "Napa": { generic: "Paracetamol", strength: "500mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Ace": { generic: "Paracetamol", strength: "500mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Napa Extra": { generic: "Paracetamol", strength: "650mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Ace Plus": { generic: "Paracetamol", strength: "650mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Napa Syrup": { generic: "Paracetamol", strength: "120mg/5ml", formulation: "Syrup", company: "Beximco Pharmaceuticals" },
                
                // Amoxicillin
                "Amoxicap": { generic: "Amoxicillin", strength: "500mg", formulation: "Capsule", company: "Square Pharmaceuticals" },
                "Amoxicillin": { generic: "Amoxicillin", strength: "500mg", formulation: "Capsule", company: "Beximco Pharmaceuticals" },
                "Amoxil": { generic: "Amoxicillin", strength: "500mg", formulation: "Capsule", company: "Incepta Pharmaceuticals" },
                "Augmentin": { generic: "Amoxicillin + Clavulanic Acid", strength: "625mg", formulation: "Tablet", company: "GlaxoSmithKline" },
                "Co-Amoxiclav": { generic: "Amoxicillin + Clavulanic Acid", strength: "625mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                
                // Metformin
                "Glucophage": { generic: "Metformin", strength: "500mg", formulation: "Tablet", company: "Merck" },
                "Metformin": { generic: "Metformin", strength: "500mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Metformin SR": { generic: "Metformin", strength: "500mg", formulation: "Sustained Release", company: "Beximco Pharmaceuticals" },
                "Glycomet": { generic: "Metformin", strength: "500mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Atorvastatin
                "Lipitor": { generic: "Atorvastatin", strength: "20mg", formulation: "Tablet", company: "Pfizer" },
                "Atorva": { generic: "Atorvastatin", strength: "20mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Atorvastatin": { generic: "Atorvastatin", strength: "20mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Atorlip": { generic: "Atorvastatin", strength: "20mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Omeprazole
                "Losec": { generic: "Omeprazole", strength: "20mg", formulation: "Capsule", company: "AstraZeneca" },
                "Omez": { generic: "Omeprazole", strength: "20mg", formulation: "Capsule", company: "Square Pharmaceuticals" },
                "Omeprazole": { generic: "Omeprazole", strength: "20mg", formulation: "Capsule", company: "Beximco Pharmaceuticals" },
                "Ocid": { generic: "Omeprazole", strength: "20mg", formulation: "Capsule", company: "Incepta Pharmaceuticals" },
                
                // Amlodipine
                "Norvasc": { generic: "Amlodipine", strength: "5mg", formulation: "Tablet", company: "Pfizer" },
                "Amlong": { generic: "Amlodipine", strength: "5mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Amlodipine": { generic: "Amlodipine", strength: "5mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Amlosafe": { generic: "Amlodipine", strength: "5mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Losartan
                "Cozaar": { generic: "Losartan", strength: "50mg", formulation: "Tablet", company: "Merck" },
                "Losartan": { generic: "Losartan", strength: "50mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Losartan Plus": { generic: "Losartan", strength: "50mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Losart": { generic: "Losartan", strength: "50mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Gliclazide
                "Diamicron": { generic: "Gliclazide", strength: "80mg", formulation: "Tablet", company: "Servier" },
                "Gliclazide": { generic: "Gliclazide", strength: "80mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Gliclazide MR": { generic: "Gliclazide", strength: "30mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Diamicron MR": { generic: "Gliclazide", strength: "30mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Ciprofloxacin
                "Ciproxin": { generic: "Ciprofloxacin", strength: "500mg", formulation: "Tablet", company: "Bayer" },
                "Cipro": { generic: "Ciprofloxacin", strength: "500mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Ciprofloxacin": { generic: "Ciprofloxacin", strength: "500mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Ciprocin": { generic: "Ciprofloxacin", strength: "500mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Azithromycin
                "Zithromax": { generic: "Azithromycin", strength: "500mg", formulation: "Tablet", company: "Pfizer" },
                "Azithromycin": { generic: "Azithromycin", strength: "500mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Azithro": { generic: "Azithromycin", strength: "500mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Azitral": { generic: "Azithromycin", strength: "500mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Ibuprofen
                "Brufen": { generic: "Ibuprofen", strength: "400mg", formulation: "Tablet", company: "Abbott" },
                "Ibuprofen": { generic: "Ibuprofen", strength: "400mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Brufen Plus": { generic: "Ibuprofen", strength: "400mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Ibupro": { generic: "Ibuprofen", strength: "400mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Diclofenac
                "Voltaren": { generic: "Diclofenac", strength: "50mg", formulation: "Tablet", company: "Novartis" },
                "Diclofenac": { generic: "Diclofenac", strength: "50mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Diclofenac Plus": { generic: "Diclofenac", strength: "50mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Diclof": { generic: "Diclofenac", strength: "50mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Cetirizine
                "Zyrtec": { generic: "Cetirizine", strength: "10mg", formulation: "Tablet", company: "UCB" },
                "Cetirizine": { generic: "Cetirizine", strength: "10mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Alatrol": { generic: "Cetirizine", strength: "10mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Cetriz": { generic: "Cetirizine", strength: "10mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Montelukast
                "Singulair": { generic: "Montelukast", strength: "10mg", formulation: "Tablet", company: "Merck" },
                "Montelukast": { generic: "Montelukast", strength: "10mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Montair": { generic: "Montelukast", strength: "10mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Montel": { generic: "Montelukast", strength: "10mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Salbutamol
                "Ventolin": { generic: "Salbutamol", strength: "4mg", formulation: "Tablet", company: "GlaxoSmithKline" },
                "Salbutamol": { generic: "Salbutamol", strength: "4mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Salbutamol Inhaler": { generic: "Salbutamol", strength: "100mcg", formulation: "Inhaler", company: "Beximco Pharmaceuticals" },
                "Salbu": { generic: "Salbutamol", strength: "4mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Furosemide
                "Lasix": { generic: "Furosemide", strength: "40mg", formulation: "Tablet", company: "Sanofi" },
                "Furosemide": { generic: "Furosemide", strength: "40mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Lasix Plus": { generic: "Furosemide", strength: "40mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Furo": { generic: "Furosemide", strength: "40mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Spironolactone
                "Aldactone": { generic: "Spironolactone", strength: "25mg", formulation: "Tablet", company: "Pfizer" },
                "Spironolactone": { generic: "Spironolactone", strength: "25mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Aldactone Plus": { generic: "Spironolactone", strength: "25mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Spiro": { generic: "Spironolactone", strength: "25mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Warfarin
                "Coumadin": { generic: "Warfarin", strength: "5mg", formulation: "Tablet", company: "Bristol-Myers Squibb" },
                "Warfarin": { generic: "Warfarin", strength: "5mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Warfarin Plus": { generic: "Warfarin", strength: "5mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Warf": { generic: "Warfarin", strength: "5mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Aspirin
                "Ecotrin": { generic: "Aspirin", strength: "81mg", formulation: "Tablet", company: "Bayer" },
                "Aspirin": { generic: "Aspirin", strength: "75mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Aspirin Plus": { generic: "Aspirin", strength: "75mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Aspi": { generic: "Aspirin", strength: "75mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Clopidogrel
                "Plavix": { generic: "Clopidogrel", strength: "75mg", formulation: "Tablet", company: "Sanofi" },
                "Clopidogrel": { generic: "Clopidogrel", strength: "75mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Clopidogrel Plus": { generic: "Clopidogrel", strength: "75mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Clopi": { generic: "Clopidogrel", strength: "75mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Lisinopril
                "Zestril": { generic: "Lisinopril", strength: "10mg", formulation: "Tablet", company: "AstraZeneca" },
                "Lisinopril": { generic: "Lisinopril", strength: "10mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Lisinopril Plus": { generic: "Lisinopril", strength: "10mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Lisi": { generic: "Lisinopril", strength: "10mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" },
                
                // Bisoprolol
                "Zebeta": { generic: "Bisoprolol", strength: "5mg", formulation: "Tablet", company: "Merck" },
                "Bisoprolol": { generic: "Bisoprolol", strength: "5mg", formulation: "Tablet", company: "Square Pharmaceuticals" },
                "Bisoprolol Plus": { generic: "Bisoprolol", strength: "5mg", formulation: "Tablet", company: "Beximco Pharmaceuticals" },
                "Biso": { generic: "Bisoprolol", strength: "5mg", formulation: "Tablet", company: "Incepta Pharmaceuticals" }
            }
        },
        PAST_MEDICAL_HISTORY: ['Hypertension', 'Diabetes Mellitus', 'Heart Disease', 'Asthma/COPD', 'Thyroid Disorder', 'Kidney Disease', 'Liver Disease', 'Cancer', 'Tuberculosis', 'Stroke', 'Epilepsy', 'Mental Health Issues', 'Surgery History', 'Allergies', 'Blood Disorders'],
        DRUG_HISTORY: ['Antihypertensives', 'Antidiabetics', 'Anticoagulants', 'Steroids', 'NSAIDs', 'Antibiotics', 'Thyroid Medications', 'Psychiatric Medications', 'Contraceptives', 'Herbal Supplements', 'Over-the-counter medications', 'No regular medications'],
        FAMILY_HISTORY: ['Hypertension', 'Diabetes', 'Heart Disease', 'Cancer', 'Asthma', 'Thyroid Disease', 'Mental Health Issues', 'Blood Disorders', 'Kidney Disease', 'Liver Disease', 'Obesity', 'Stroke', 'Epilepsy', 'No significant family history'],
        MENSTRUAL_HISTORY: ['Regular cycles', 'Irregular cycles', 'Heavy bleeding', 'Light bleeding', 'Painful periods', 'Amenorrhea', 'Menorrhagia', 'Dysmenorrhea', 'Intermenstrual bleeding', 'Post-coital bleeding', 'Menopause', 'Not applicable'],
        OBS_GYNAE_HISTORY: ['Pregnancy history', 'Miscarriages', 'Abortions', 'Ectopic pregnancy', 'Cesarean section', 'Vaginal deliveries', 'Gynecological surgeries', 'Fibroids', 'Endometriosis', 'PCOS', 'Cervical cancer screening', 'Breast examination', 'Not applicable'],
        PERSONAL_HISTORY: ['Smoking', 'Alcohol consumption', 'Drug use', 'Exercise routine', 'Diet habits', 'Sleep pattern', 'Stress levels', 'Sexual activity', 'Travel history', 'Pets', 'Hobbies', 'No significant personal history'],
        SOCIOECONOMIC_HISTORY: ['Education level', 'Occupation', 'Income level', 'Housing situation', 'Marital status', 'Children', 'Social support', 'Financial stress', 'Access to healthcare', 'Transportation', 'Food security', 'No significant socioeconomic issues'],
        OCCUPATIONAL_HISTORY: ['Current job', 'Work environment', 'Occupational hazards', 'Work-related stress', 'Work hours', 'Physical demands', 'Chemical exposure', 'Radiation exposure', 'Repetitive strain', 'Work-related injuries', 'Unemployment', 'Retired'],
        IMMUNIZATION_HISTORY: ['BCG', 'DPT', 'MMR', 'Hepatitis B', 'Hepatitis A', 'Varicella', 'Influenza', 'Pneumococcal', 'COVID-19', 'HPV', 'Tetanus', 'Polio', 'Complete immunization record', 'Incomplete immunization', 'No immunization record'],
        INVESTIGATIONS: {
            categories: {
                "General Laboratory": {
                    "Complete Blood Count (CBC)": {
                        components: ["Hemoglobin", "White Blood Cell Count", "Platelet Count", "Red Blood Cell Count", "Hematocrit", "MCV", "MCH", "MCHC", "RDW"],
                        timing: ["Fasting", "Non-fasting"],
                        special_instructions: "8-12 hour fast recommended"
                    },
                    "Comprehensive Metabolic Panel (CMP)": {
                        components: ["Glucose", "BUN", "Creatinine", "Sodium", "Potassium", "Chloride", "CO2", "Calcium", "Total Protein", "Albumin", "Total Bilirubin", "Alkaline Phosphatase", "AST", "ALT"],
                        timing: ["Fasting", "Non-fasting"],
                        special_instructions: "8-12 hour fast recommended"
                    },
                    "Basic Metabolic Panel (BMP)": {
                        components: ["Glucose", "BUN", "Creatinine", "Sodium", "Potassium", "Chloride", "CO2", "Calcium"],
                        timing: ["Fasting", "Non-fasting"],
                        special_instructions: "8-12 hour fast recommended"
                    },
                    "Lipid Profile": {
                        components: ["Total Cholesterol", "HDL Cholesterol", "LDL Cholesterol", "Triglycerides"],
                        timing: ["Fasting"],
                        special_instructions: "12-14 hour fast required"
                    },
                    "Thyroid Function Tests": {
                        components: ["TSH", "Free T4", "Free T3", "Total T4", "Total T3", "Anti-TPO", "Anti-TG"],
                        timing: ["Non-fasting"],
                        special_instructions: "Morning sample preferred"
                    },
                    "Urinalysis": {
                        components: ["Color", "Appearance", "Specific Gravity", "pH", "Protein", "Glucose", "Ketones", "Blood", "Leukocytes", "Nitrites", "Microscopic Examination"],
                        timing: ["First morning", "Random"],
                        special_instructions: "Clean catch midstream urine"
                    },
                    "ESR (Erythrocyte Sedimentation Rate)": {
                        components: ["ESR"],
                        timing: ["Non-fasting"],
                        special_instructions: "Non-specific marker of inflammation"
                    },
                    "CRP (C-Reactive Protein)": {
                        components: ["CRP", "High-sensitivity CRP"],
                        timing: ["Non-fasting"],
                        special_instructions: "More specific than ESR"
                    },
                    "Blood Group & Crossmatch": {
                        components: ["ABO Group", "Rh Type", "Antibody Screen", "Crossmatch"],
                        timing: ["Non-fasting"],
                        special_instructions: "Required for blood transfusion"
                    },
                    "Pregnancy Test": {
                        components: ["Beta-HCG", "Qualitative", "Quantitative"],
                        timing: ["Non-fasting"],
                        special_instructions: "First morning urine preferred"
                    },
                    "Drug Level Monitoring": {
                        components: ["Digoxin", "Phenytoin", "Carbamazepine", "Valproic Acid", "Lithium", "Vancomycin", "Aminoglycosides"],
                        timing: ["Trough level", "Peak level"],
                        special_instructions: "Timing critical for interpretation"
                    }
                },
                "Cardiology": {
                    "Electrocardiogram (ECG/EKG)": {
                        components: ["12-lead ECG", "Rhythm strip", "QT interval", "ST segment analysis"],
                        timing: ["Immediate", "Scheduled"],
                        special_instructions: "Resting ECG, may need stress ECG"
                    },
                    "Echocardiogram": {
                        components: ["2D Echo", "Doppler", "Color Flow", "Tissue Doppler", "Strain Imaging"],
                        timing: ["Scheduled"],
                        special_instructions: "Transthoracic or Transesophageal"
                    },
                    "Stress Test": {
                        components: ["Exercise Stress Test", "Pharmacological Stress Test", "Stress Echo", "Nuclear Stress Test"],
                        timing: ["Scheduled"],
                        special_instructions: "Exercise or pharmacological stress"
                    },
                    "Holter Monitor": {
                        components: ["24-hour ECG", "48-hour ECG", "7-day ECG"],
                        timing: ["Continuous monitoring"],
                        special_instructions: "Ambulatory ECG monitoring"
                    },
                    "Cardiac CT": {
                        components: ["Coronary Calcium Score", "Coronary CTA", "Cardiac CT"],
                        timing: ["Scheduled"],
                        special_instructions: "May require beta-blocker for heart rate control"
                    },
                    "Cardiac MRI": {
                        components: ["Cardiac Structure", "Function", "Perfusion", "Viability", "Flow Analysis"],
                        timing: ["Scheduled"],
                        special_instructions: "Contraindicated with certain implants"
                    },
                    "Coronary Angiography": {
                        components: ["Left Heart Catheterization", "Right Heart Catheterization", "Coronary Angiography"],
                        timing: ["Scheduled"],
                        special_instructions: "Invasive procedure, requires consent"
                    },
                    "Cardiac Biomarkers": {
                        components: ["Troponin I", "Troponin T", "CK-MB", "BNP", "NT-proBNP"],
                        timing: ["Immediate", "Serial"],
                        special_instructions: "Serial measurements for ACS"
                    },
                    "Ambulatory Blood Pressure Monitoring": {
                        components: ["24-hour BP", "Day/Night BP", "BP Variability"],
                        timing: ["24-hour monitoring"],
                        special_instructions: "Wear for 24 hours, avoid showering"
                    }
                },
                "Respiratory": {
                    "Chest X-ray": {
                        components: ["PA View", "Lateral View", "AP View", "Decubitus Views"],
                        timing: ["Immediate", "Scheduled"],
                        special_instructions: "PA view preferred when possible"
                    },
                    "Chest CT": {
                        components: ["Non-contrast", "Contrast-enhanced", "High-resolution CT", "CT Angiography"],
                        timing: ["Scheduled"],
                        special_instructions: "May require contrast allergy screening"
                    },
                    "Pulmonary Function Tests (PFT)": {
                        components: ["Spirometry", "Lung Volumes", "Diffusion Capacity", "Bronchodilator Response"],
                        timing: ["Scheduled"],
                        special_instructions: "Avoid bronchodilators 4-6 hours before"
                    },
                    "Arterial Blood Gas (ABG)": {
                        components: ["pH", "PaCO2", "PaO2", "HCO3", "SaO2", "Base Excess"],
                        timing: ["Immediate"],
                        special_instructions: "Arterial puncture required"
                    },
                    "Sleep Study (Polysomnography)": {
                        components: ["Overnight Study", "Split-night Study", "Home Sleep Study"],
                        timing: ["Overnight"],
                        special_instructions: "Overnight monitoring in sleep lab"
                    },
                    "Bronchoscopy": {
                        components: ["Flexible Bronchoscopy", "Rigid Bronchoscopy", "Bronchoalveolar Lavage", "Transbronchial Biopsy"],
                        timing: ["Scheduled"],
                        special_instructions: "Invasive procedure, requires consent"
                    },
                    "Sputum Analysis": {
                        components: ["Gram Stain", "Culture & Sensitivity", "AFB", "Cytology"],
                        timing: ["Morning sample"],
                        special_instructions: "Deep cough specimen, avoid saliva"
                    },
                    "Pleural Fluid Analysis": {
                        components: ["Cell Count", "Protein", "LDH", "Glucose", "pH", "Culture", "Cytology"],
                        timing: ["Immediate"],
                        special_instructions: "Thoracentesis required"
                    }
                },
                "Gastroenterology": {
                    "Upper Endoscopy (EGD)": {
                        components: ["Esophagogastroduodenoscopy", "Biopsy", "pH Monitoring"],
                        timing: ["Scheduled"],
                        special_instructions: "NPO 6-8 hours before procedure"
                    },
                    "Colonoscopy": {
                        components: ["Colonoscopy", "Biopsy", "Polypectomy"],
                        timing: ["Scheduled"],
                        special_instructions: "Bowel preparation required"
                    },
                    "Flexible Sigmoidoscopy": {
                        components: ["Sigmoidoscopy", "Biopsy"],
                        timing: ["Scheduled"],
                        special_instructions: "Limited bowel preparation"
                    },
                    "Capsule Endoscopy": {
                        components: ["Small Bowel Capsule", "Colon Capsule"],
                        timing: ["Scheduled"],
                        special_instructions: "Capsule swallowed, images transmitted"
                    },
                    "ERCP": {
                        components: ["Endoscopic Retrograde Cholangiopancreatography", "Sphincterotomy", "Stent Placement"],
                        timing: ["Scheduled"],
                        special_instructions: "Invasive procedure, requires consent"
                    },
                    "Liver Function Tests": {
                        components: ["AST", "ALT", "Alkaline Phosphatase", "GGT", "Total Bilirubin", "Direct Bilirubin", "Albumin", "Prothrombin Time"],
                        timing: ["Fasting", "Non-fasting"],
                        special_instructions: "Fasting preferred"
                    },
                    "Hepatitis Serology": {
                        components: ["Hepatitis A IgM/IgG", "Hepatitis B Surface Antigen", "Hepatitis B Core Antibody", "Hepatitis B Surface Antibody", "Hepatitis C Antibody", "Hepatitis C RNA"],
                        timing: ["Non-fasting"],
                        special_instructions: "May need confirmatory testing"
                    },
                    "Stool Analysis": {
                        components: ["Occult Blood", "Culture", "Ova & Parasites", "C. difficile", "Calprotectin"],
                        timing: ["Fresh sample"],
                        special_instructions: "Avoid contamination with urine"
                    },
                    "H. pylori Testing": {
                        components: ["Urea Breath Test", "Stool Antigen", "Serology", "Rapid Urease Test"],
                        timing: ["Fasting", "Non-fasting"],
                        special_instructions: "Avoid PPIs and antibiotics for 2 weeks"
                    }
                },
                "Endocrinology": {
                    "HbA1c": {
                        components: ["Glycated Hemoglobin"],
                        timing: ["Non-fasting"],
                        special_instructions: "Reflects 3-month glucose control"
                    },
                    "Oral Glucose Tolerance Test": {
                        components: ["Fasting Glucose", "2-hour Post-prandial Glucose"],
                        timing: ["Fasting then 2-hour test"],
                        special_instructions: "75g glucose load, 2-hour monitoring"
                    },
                    "Insulin Levels": {
                        components: ["Fasting Insulin", "C-peptide", "Insulin Antibodies"],
                        timing: ["Fasting"],
                        special_instructions: "Fasting required"
                    },
                    "Cortisol": {
                        components: ["Morning Cortisol", "Evening Cortisol", "24-hour Urine Cortisol", "ACTH"],
                        timing: ["Morning (8 AM)", "Evening (4 PM)", "24-hour collection"],
                        special_instructions: "Diurnal variation important"
                    },
                    "Pituitary Function Tests": {
                        components: ["Growth Hormone", "IGF-1", "Prolactin", "FSH", "LH", "ACTH"],
                        timing: ["Fasting", "Non-fasting"],
                        special_instructions: "Some require stimulation tests"
                    },
                    "Parathyroid Function": {
                        components: ["PTH", "Vitamin D (25-OH)", "Vitamin D (1,25-OH)", "Calcium", "Phosphorus"],
                        timing: ["Fasting"],
                        special_instructions: "Fasting preferred"
                    },
                    "Adrenal Function Tests": {
                        components: ["Cortisol", "ACTH", "Aldosterone", "Renin", "DHEA-S", "17-OH Progesterone"],
                        timing: ["Morning (8 AM)", "Evening (4 PM)"],
                        special_instructions: "Diurnal variation important"
                    },
                    "Growth Hormone Tests": {
                        components: ["IGF-1", "Growth Hormone", "GHRH", "Insulin-like Growth Factor Binding Protein-3"],
                        timing: ["Fasting"],
                        special_instructions: "May require stimulation tests"
                    }
                },
                "Nephrology": {
                    "Renal Function Tests": {
                        components: ["Creatinine", "BUN", "eGFR", "Cystatin C", "Creatinine Clearance"],
                        timing: ["Fasting", "Non-fasting"],
                        special_instructions: "24-hour urine collection for clearance"
                    },
                    "Urine Protein": {
                        components: ["Urine Protein/Creatinine Ratio", "24-hour Urine Protein", "Microalbuminuria"],
                        timing: ["First morning", "24-hour collection"],
                        special_instructions: "24-hour collection most accurate"
                    },
                    "Renal Ultrasound": {
                        components: ["Kidney Size", "Echogenicity", "Hydronephrosis", "Renal Artery Doppler"],
                        timing: ["Scheduled"],
                        special_instructions: "Non-invasive imaging"
                    },
                    "CT Urogram": {
                        components: ["CT without contrast", "CT with contrast", "Delayed phase"],
                        timing: ["Scheduled"],
                        special_instructions: "May require contrast allergy screening"
                    },
                    "Renal Biopsy": {
                        components: ["Percutaneous Biopsy", "Transjugular Biopsy"],
                        timing: ["Scheduled"],
                        special_instructions: "Invasive procedure, requires consent"
                    }
                },
                "Hematology": {
                    "Complete Blood Count with Differential": {
                        components: ["WBC with Differential", "RBC Indices", "Platelet Count", "Reticulocyte Count"],
                        timing: ["Non-fasting"],
                        special_instructions: "Peripheral smear if abnormal"
                    },
                    "Iron Studies": {
                        components: ["Iron", "TIBC", "Ferritin", "Transferrin Saturation"],
                        timing: ["Fasting"],
                        special_instructions: "Fasting preferred"
                    },
                    "Vitamin B12 and Folate": {
                        components: ["Vitamin B12", "Folate", "Methylmalonic Acid", "Homocysteine"],
                        timing: ["Fasting"],
                        special_instructions: "Fasting preferred"
                    },
                    "Coagulation Studies": {
                        components: ["PT", "INR", "aPTT", "Fibrinogen", "D-dimer"],
                        timing: ["Non-fasting"],
                        special_instructions: "Avoid anticoagulants if possible"
                    },
                    "Bone Marrow Aspiration/Biopsy": {
                        components: ["Aspiration", "Biopsy", "Flow Cytometry", "Cytogenetics"],
                        timing: ["Scheduled"],
                        special_instructions: "Invasive procedure, requires consent"
                    }
                },
                "Rheumatology": {
                    "Rheumatoid Factor": {
                        components: ["RF IgM", "RF IgG", "RF IgA"],
                        timing: ["Non-fasting"],
                        special_instructions: "Non-specific marker"
                    },
                    "Anti-CCP": {
                        components: ["Anti-Cyclic Citrullinated Peptide"],
                        timing: ["Non-fasting"],
                        special_instructions: "More specific for RA"
                    },
                    "ANA (Antinuclear Antibody)": {
                        components: ["ANA Screen", "ANA Pattern", "ENA Panel"],
                        timing: ["Non-fasting"],
                        special_instructions: "Pattern important for interpretation"
                    },
                    "ANCA": {
                        components: ["c-ANCA", "p-ANCA", "MPO", "PR3"],
                        timing: ["Non-fasting"],
                        special_instructions: "Vasculitis workup"
                    },
                    "HLA-B27": {
                        components: ["HLA-B27"],
                        timing: ["Non-fasting"],
                        special_instructions: "Spondyloarthropathy workup"
                    },
                    "Uric Acid": {
                        components: ["Uric Acid"],
                        timing: ["Fasting"],
                        special_instructions: "Fasting preferred"
                    }
                },
                "Infectious Disease": {
                    "Blood Cultures": {
                        components: ["Aerobic", "Anaerobic", "Fungal"],
                        timing: ["Immediate"],
                        special_instructions: "Multiple sets, before antibiotics"
                    },
                    "HIV Testing": {
                        components: ["HIV Antibody", "HIV Antigen", "HIV RNA", "CD4 Count", "Viral Load"],
                        timing: ["Non-fasting"],
                        special_instructions: "Consent required"
                    },
                    "Tuberculosis Testing": {
                        components: ["PPD", "Quantiferon", "T-Spot", "Sputum AFB", "TB Culture"],
                        timing: ["Scheduled"],
                        special_instructions: "PPD read at 48-72 hours"
                    },
                    "Syphilis Testing": {
                        components: ["RPR", "VDRL", "FTA-ABS", "TP-PA"],
                        timing: ["Non-fasting"],
                        special_instructions: "Confirmatory testing required"
                    },
                    "Lyme Disease Testing": {
                        components: ["Lyme Antibody", "Western Blot"],
                        timing: ["Non-fasting"],
                        special_instructions: "Two-tier testing recommended"
                    }
                },
                "Neurology": {
                    "Brain MRI": {
                        components: ["T1", "T2", "FLAIR", "DWI", "Gadolinium-enhanced"],
                        timing: ["Scheduled"],
                        special_instructions: "Contraindicated with certain implants"
                    },
                    "Brain CT": {
                        components: ["Non-contrast", "Contrast-enhanced"],
                        timing: ["Immediate", "Scheduled"],
                        special_instructions: "Rapid assessment for acute conditions"
                    },
                    "EEG": {
                        components: ["Routine EEG", "Sleep-deprived EEG", "Ambulatory EEG", "Video EEG"],
                        timing: ["Scheduled"],
                        special_instructions: "Sleep deprivation may increase yield"
                    },
                    "EMG/NCS": {
                        components: ["Nerve Conduction Studies", "Electromyography"],
                        timing: ["Scheduled"],
                        special_instructions: "Avoid anticoagulants"
                    },
                    "Lumbar Puncture": {
                        components: ["Opening Pressure", "Cell Count", "Protein", "Glucose", "Culture", "Cytology"],
                        timing: ["Scheduled"],
                        special_instructions: "Invasive procedure, requires consent"
                    },
                    "Nerve Conduction Studies": {
                        components: ["Motor NCS", "Sensory NCS", "F-wave", "H-reflex"],
                        timing: ["Scheduled"],
                        special_instructions: "Avoid lotions, avoid anticoagulants"
                    },
                    "Carotid Doppler": {
                        components: ["Carotid Artery Stenosis", "Plaque Assessment", "Flow Velocity"],
                        timing: ["Scheduled"],
                        special_instructions: "Non-invasive vascular study"
                    }
                },
                "Oncology": {
                    "Tumor Markers": {
                        components: ["PSA", "CEA", "AFP", "CA-125", "CA-19-9", "CA-15-3", "Beta-HCG"],
                        timing: ["Non-fasting"],
                        special_instructions: "Not diagnostic, monitor trends"
                    },
                    "PET Scan": {
                        components: ["FDG-PET", "PET-CT", "PET-MRI"],
                        timing: ["Scheduled"],
                        special_instructions: "Fasting required, glucose control important"
                    },
                    "Bone Scan": {
                        components: ["Technetium-99m Bone Scan"],
                        timing: ["Scheduled"],
                        special_instructions: "Nuclear medicine study"
                    },
                    "Mammography": {
                        components: ["Screening Mammogram", "Diagnostic Mammogram", "3D Tomosynthesis"],
                        timing: ["Scheduled"],
                        special_instructions: "Avoid deodorant, jewelry"
                    },
                    "Colonoscopy": {
                        components: ["Screening", "Diagnostic", "Surveillance"],
                        timing: ["Scheduled"],
                        special_instructions: "Bowel preparation required"
                    },
                    "PSA (Prostate Specific Antigen)": {
                        components: ["Total PSA", "Free PSA", "Free/Total Ratio"],
                        timing: ["Non-fasting"],
                        special_instructions: "Avoid DRE for 48 hours before"
                    },
                    "Mammography": {
                        components: ["Screening Mammogram", "Diagnostic Mammogram", "3D Tomosynthesis"],
                        timing: ["Scheduled"],
                        special_instructions: "Avoid deodorant, jewelry"
                    },
                    "Pap Smear": {
                        components: ["Cervical Cytology", "HPV Testing", "Liquid-based Cytology"],
                        timing: ["Scheduled"],
                        special_instructions: "Avoid intercourse 24-48 hours before"
                    }
                },
                "Emergency Medicine": {
                    "Troponin": {
                        components: ["Troponin I", "Troponin T", "High-sensitivity Troponin"],
                        timing: ["Immediate", "Serial"],
                        special_instructions: "Serial measurements for ACS"
                    },
                    "D-dimer": {
                        components: ["D-dimer"],
                        timing: ["Immediate"],
                        special_instructions: "Screening for VTE"
                    },
                    "Lactate": {
                        components: ["Lactate"],
                        timing: ["Immediate"],
                        special_instructions: "Marker of tissue perfusion"
                    },
                    "Toxicology Screen": {
                        components: ["Urine Drug Screen", "Blood Alcohol", "Acetaminophen", "Salicylate"],
                        timing: ["Immediate"],
                        special_instructions: "Urine and blood samples"
                    }
                }
            }
        },
        SYMPTOMS_BY_SYSTEM: [
            { system: 'Constitutional', symptoms: ['Weight loss', 'Day sweats', 'Fatigue', 'Malaise', 'Lethargy', 'Sleeping pattern change', 'Appetite change', 'Fever', 'Itch', 'Rash', 'Recent trauma', 'Lumps/Bumps/Masses'] },
            { system: 'Eyes', symptoms: ['Visual changes', 'Eye pain', 'Double vision', 'Scotomas (blind spots)', 'Floaters'] },
            { system: 'ENT', symptoms: ['Runny nose', 'Epistaxis (nose bleeds)', 'Sinus pain', 'Stuffy ears', 'Ear pain', 'Tinnitus', 'Gingival bleeding', 'Toothache', 'Sore throat', 'Odynophagia (pain with swallowing)'] },
            { system: 'Cardiovascular', symptoms: ['Chest Pain', 'Shortness of Breath on exertion', 'Paroxysmal Nocturnal Dyspnea (PND)', 'Orthopnea', 'Edema', 'Palpitations', 'Faintness', 'Loss of consciousness', 'Claudication'] },
            { system: 'Respiratory', symptoms: ['Cough', 'Sputum', 'Wheeze', 'Hemoptysis', 'Shortness of Breath at rest'] },
            { system: 'Gastrointestinal', symptoms: ['Abdominal Pain', 'Difficulty swallowing', 'Indigestion', 'Bloating', 'Cramping', 'Loss of appetite', 'Nausea/Vomiting', 'Diarrhea', 'Constipation', 'Obstipation', 'Hematemesis', 'Hematochezia (BRBPR)', 'Melena', 'Tenesmus'] },
            { system: 'Genitourinary', symptoms: ['Incontinence', 'Dysuria', 'Hematuria', 'Nocturia', 'Polyuria', 'Hesitancy', 'Terminal dribbling', 'Decreased force of stream', 'Vaginal discharge', 'Vaginal pain', 'Menstrual changes', 'Contraception concern', 'Libido changes', 'Erectile dysfunction'] },
            { system: 'Musculoskeletal', symptoms: ['Joint Pain', 'Back Pain', 'Stiffness', 'Joint swelling', 'Decreased range of motion', 'Crepitus', 'Functional deficit'] },
            { system: 'Integumentary/Breast', symptoms: ['Pruritus', 'Rashes', 'Lesions', 'Wounds', 'Acanthosis nigricans', 'Nodules', 'Excessive dryness', 'Discoloration', 'Breast pain', 'Breast lumps', 'Breast discharge'] },
            { system: 'Neurological', symptoms: ['Headache', 'Dizziness', 'Seizures', 'Faints', 'Paraesthesiae (pins and needles)', 'Numbness', 'Limb weakness', 'Poor balance', 'Speech problems', 'Sphincter disturbance', 'Cognitive changes'] },
            { system: 'Psychiatric', symptoms: ['Depression', 'Anxiety', 'Difficulty concentrating', 'Body image concerns', 'Paranoia', 'Anhedonia', 'Lack of energy', 'Mania episodes', 'Personality change'] },
            { system: 'Endocrine', symptoms: ['Heat/Cold intolerance', 'Sweating changes', 'Mood swings', 'Tremor', 'Polydipsia', 'Polyuria', 'Polyphagia', 'Hypoglycemia symptoms'] },
            { system: 'Hematologic/Lymphatic', symptoms: ['Easy bruising (purpura/petechia)', 'Prolonged bleeding', 'History of anemia', 'Swollen lymph nodes'] },
            { system: 'Allergic/Immunologic', symptoms: ['Anaphylaxis history', 'Allergic rhinitis symptoms', 'Known food/drug/environmental allergies'] }
        ],
        SYMPTOM_PROTOCOLS: {}, // Will be populated dynamically
        EXAMINATION_DATA: {
            "General Examination": {
                id: "general_examination",
                sections: [
                    {
                        title: "A. General Survey", id: "general_survey",
                        findings: [
                            { label: "Level of Consciousness/Sensorium", type: "custom_select", id: "consciousness", options: ["Alert and Oriented (x4)", "Confused", "Drowsy/Lethargic", "Obtunded", "Stuporous", "Comatose"], custom_placeholder: "e.g., Oriented to person/place only" },
                            { label: "Body Habitus & Build", type: "custom_select", id: "habitus", options: ["Normal/Average", "Slender/Ectomorphic", "Muscular/Mesomorphic", "Obese (state degree)", "Frail", "Cachectic"], custom_placeholder: "Describe specific build or distribution of fat..." },
                            { label: "Posture & Gait", type: "custom_select", id: "posture_gait", options: ["Erect posture, steady gait", "Slumped posture", "Kyphotic/Lordotic/Scoliotic", "Antalgic (limping) gait", "Ataxic gait", "Shuffling gait", "Waddling gait"], custom_placeholder: "Describe use of assistive devices (cane, walker)..." },
                            { label: "Signs of Distress", type: "custom_select", id: "distress", options: ["No acute distress (NAD)", "Mild/Moderate/Severe respiratory distress", "In obvious pain (grimacing, guarding)", "Anxious or agitated"], custom_placeholder: "Describe specific signs like stridor, moaning..." },
                            { label: "Hygiene, Grooming & Odors", type: "custom_select", id: "hygiene", options: ["Good hygiene, well-kempt", "Fair hygiene", "Poor hygiene, unkempt"], custom_placeholder: "Describe odors (alcohol, uremia, ketoacidosis)..." },
                        ]
                    },
                    {
                        title: "C. Vital Signs", id: "vital_signs",
                        findings: [
                            { label: "Temperature", type: "temperature_group", id: "temperature" },
                            { label: "Pulse", type: "custom_select", id: "pulse", options: ["Normal rate & rhythm", "Tachycardia (>100)", "Bradycardia (<60)", "Irregularly irregular (e.g., AF)", "Regularly irregular", "Collapsing/Water-hammer pulse", "Pulsus alternans", "Pulsus paradoxus"], custom_placeholder: "Enter rate and character (e.g., 88 bpm, bounding)" },
                            { label: "Respiratory Rate", type: "custom_select", id: "respiratory_rate", options: ["Eupnea (Normal rate & effort)", "Tachypnea (>20/min)", "Bradypnea (<12/min)", "Labored (use of accessory muscles)", "Cheyne-Stokes", "Kussmaul", "Biot's"], custom_placeholder: "Enter rate and depth (shallow, deep)..." },
                            { label: "Blood Pressure", type: "bp_group", id: "blood_pressure" },
                            { label: "Oxygen Saturation (SpO)", type: "custom_select", id: "spo2", options: ["Normal on room air (>94%)", "Hypoxic (<94% on RA)"], custom_placeholder: "Value and condition, e.g., 99% on RA, 92% on 2L NC" }
                        ]
                    }
                ]
            },
            "Integumentary System": {
                id: "integumentary_system",
                sections: [
                    {
                        title: "A. Clinical Examination Procedures",
                        id: "integ_exam_procedures",
                        findings: [
                            { label: "Skin - Color & Lesions", type: "custom_select", id: "integ_skin_color", options: ["Normal color", "Pallor", "Cyanosis", "Jaundice", "Erythema", "Hyperpigmentation", "Hypopigmentation", "No lesions", "Macule/Patch", "Papule/Plaque", "Nodule/Tumor", "Vesicle/Bulla", "Pustule", "Wheal", "Cyst", "Crust", "Scale", "Excoriation", "Fissure", "Ulcer"], custom_placeholder: "Describe lesion shape, size, distribution (ABCDE)..." },
                            { label: "Skin - Palpation", type: "custom_select", id: "integ_skin_palpation", options: ["Normal temperature", "Warm", "Cool", "Normal moisture", "Diaphoretic", "Dry (xerosis)", "Normal texture", "Rough/scaly", "Normal turgor", "Tenting (dehydration)"], custom_placeholder: "Describe localized temp changes, etc." },
                            { label: "Pressure Areas & Edema", type: "custom_select", id: "integ_pressure", options: ["No pressure area erythema", "Blanchable erythema", "Non-blanchable erythema (Stage 1)", "No edema", "Pitting edema", "Non-pitting edema"], custom_placeholder: "Grade pitting edema (1-4+), note location..." },
                            { label: "Hair", type: "custom_select", id: "integ_hair", options: ["Normal distribution & texture", "Alopecia (diffuse/patchy)", "Hirsutism", "Brittle/coarse hair", "Scalp scaling/lesions"], custom_placeholder: "Describe findings..." },
                            { label: "Nails", type: "custom_select", id: "integ_nails", options: ["Normal color & shape", "Cyanosis", "Pallor", "Splinter hemorrhages", "Clubbing", "Koilonychia (spooning)", "Pitting", "Beau's lines", "Onycholysis", "Normal capillary refill (<3s)", "Delayed capillary refill"], custom_placeholder: "Describe specific nail changes..." }
                        ]
                    }
                ]
            },
            "Cardiovascular System": {
                id: "cardiovascular_system",
                sections: [
                    {
                        title: "A. Clinical Examination Procedures",
                        id: "cvs_exam_procedures",
                        findings: [
                            { label: "Inspection", type: "custom_select", clonable: true, id: "cvs_inspection", options: ["No visible scars or deformities", "Median sternotomy scar", "Thoracotomy scar (L/R)", "Subclavicular scar (pacemaker)", "Pectus excavatum", "Pectus carinatum", "Visible apical impulse", "Visible parasternal heave"], custom_placeholder: "Describe other findings (e.g., venous distension)..." },
                            { label: "Peripheral Pulses", type: "peripheral_pulse_group", id: "cvs_pulses"},
                            { label: "Jugular Venous Pressure (JVP)", type: "custom_select", id: "cvs_jvp", options: ["Normal (<4cm above sternal angle)", "Elevated", "Cannon 'a' waves present", "Large 'v' waves present", "Kussmaul's sign positive", "Hepatojugular reflux positive"], custom_placeholder: "Enter measured height in cm H2O..." },
                            { label: "Precordial Palpation", type: "palpation_group", id: "cvs_palpation" },
                            { label: "Auscultation - Heart Sounds", type: "custom_select", clonable: true, id: "cvs_sounds", options: ["S1, S2 normal", "Physiological S2 splitting", "Fixed S2 splitting", "Wide S2 splitting", "Paradoxical S2 splitting", "S3 gallop present", "S4 gallop present", "Summation gallop", "Aortic ejection click", "Pulmonic ejection click", "Mid-systolic click (MVP)", "Pericardial friction rub", "Prosthetic valve sounds"], custom_placeholder: "Note location and timing..." },
                            { label: "Auscultation - Murmurs", type: "murmur_group", clonable: true, id: "cvs_murmurs" },
                        ]
                    },
                    {
                        title: "B. Advanced Examination & Maneuvers",
                        id: "cvs_advanced_exam",
                        findings: [
                             { label: "Dynamic Auscultation", type: "dynamic_maneuver_group", clonable: true, id: "cvs_dynamic_auscultation" },
                             { label: "Peripheral Vascular Tests", type: "peripheral_vascular_tests", id: "cvs_pv_tests" },
                             { label: "Ankle-Brachial Index (ABI)", type: "abi_calculator", id: "cvs_abi" },
                             { label: "Shunt Calculation (Qp/Qs)", type: "shunt_calculator", id: "cvs_shunt" },
                             { label: "Angiographic / Echo Findings", type: "vessel_stenosis_group", clonable: true, id: "cvs_vessel_stenosis" },
                        ]
                    },
                    {
                        title: "C. Clinical Scoring Systems",
                        id: "cvs_scoring_systems",
                        findings: [
                            { label: "Framingham Risk Score (FRS) for 10-year CVD", type: "framingham_score", id: "framingham" },
                            { label: "TIMI Risk Score for UA/NSTEMI", type: "timi_score", id: "timi" },
                            { label: "Coronary Artery Calcium (CAC) Score", type: "calcium_score", id: "cac" },
                            { label: "SYNTAX Score I & II", type: "syntax_score", id: "syntax" },
                            { label: "HEART Score for Chest Pain", type: "heart_score", id: "heart" },
                            { label: "CHADS-VASc Score for Stroke Risk", type: "chads_vasc_score", id: "chads_vasc" },
                            { label: "HAS-BLED Score for Bleeding Risk", type: "has_bled_score", id: "has_bled" },
                            { label: "NYHA Functional Classification", type: "nyha_score", id: "nyha" },
                        ]
                    }
                ]
            },
            "Respiratory System": {
                id: "respiratory_system",
                sections: [
                    {
                        title: "A. Clinical Examination Procedures",
                        id: "resp_exam_procedures",
                        findings: [
                            { label: "Inspection", type: "custom_select", clonable: true, id: "resp_inspection", options: ["No distress, normal chest shape", "Increased work of breathing", "Use of accessory muscles", "Pursed-lip breathing", "Cyanosis", "Barrel chest", "Tracheal deviation"], custom_placeholder: "Describe specifics..." },
                            { label: "Palpation", type: "custom_select", id: "resp_palpation", options: ["Symmetrical chest expansion", "Asymmetrical chest expansion", "Normal tactile fremitus", "Increased tactile fremitus", "Decreased/absent tactile fremitus", "Subcutaneous crepitus"], custom_placeholder: "Specify location of abnormalities..." },
                            { label: "Percussion", type: "custom_select", clonable: true, id: "resp_percussion", options: ["Resonant throughout", "Dullness to percussion", "Hyperresonance"], custom_placeholder: "Specify location..." },
                            { label: "Auscultation", type: "custom_select", clonable: true, id: "resp_auscultation", options: ["Vesicular breath sounds clear", "Bronchial breath sounds", "Decreased/absent breath sounds", "Crackles (rales)", "Wheezes", "Rhonchi", "Pleural friction rub", "Egophony", "Whispered pectoriloquy"], custom_placeholder: "Specify location and timing (insp/exp)..." }
                        ]
                    },
                    {
                        title: "B. Clinical Scoring Systems",
                        id: "resp_scoring_systems",
                        findings: [
                            { label: "CURB-65 Score for Pneumonia Severity", type: "curb65_score", id: "curb65" },
                            { label: "Pneumonia Severity Index (PSI/PORT)", type: "psi_score", id: "psi" },
                            { label: "BAP-65 Score for COPD Exacerbation", type: "bap65_score", id: "bap65" },
                            { label: "Wells Score for PE", type: "wells_pe_score", id: "wells_pe" },
                            { label: "Geneva Score (Revised) for PE", type: "geneva_score", id: "geneva" },
                            { label: "COPD Assessment Test (CAT)", type: "cat_score", id: "cat" },
                            { label: "Asthma Control Test (ACT)", type: "act_score", id: "act" },
                            { label: "mMRC Dyspnoea Scale", type: "mmrc_scale", id: "mmrc" }
                        ]
                    }
                ]
            },
            "Gastrointestinal System": {
                id: "gastrointestinal_system",
                sections: [
                    {
                        title: "Peripheral & General Inspection",
                        id: "gi_general_inspection",
                        findings: [
                            { label: "Hands", type: "custom_select", clonable: true, id: "gi_hands", options: ["Normal", "Pallor (anemia)", "Jaundice", "Palmar erythema", "Dupuytren's contracture", "Clubbing", "Koilonychia", "Leukonychia", "Asterixis absent", "Asterixis present"], custom_placeholder: "Describe specifics..." },
                            { label: "Face & Neck", type: "custom_select", clonable: true, id: "gi_face_neck", options: ["Normal", "Scleral icterus", "Conjunctival pallor", "Kayser-Fleischer rings", "Xanthelasma", "Angular cheilitis", "Oral ulcers", "Glossitis", "Fetor hepaticus present", "Virchow's node not palpable", "Virchow's node palpable"], custom_placeholder: "Describe specifics..." },
                            { label: "Chest", type: "custom_select", id: "gi_chest", options: ["Normal", "Spider naevi", "Gynaecomastia"], custom_placeholder: "Note number and distribution..." }
                        ]
                    },
                    {
                        title: "Abdominal Examination",
                        id: "gi_abdominal_exam",
                        findings: [
                            { label: "Inspection", type: "custom_select", clonable: true, id: "gi_inspection", options: ["Contour: Flat", "Contour: Rounded", "Contour: Scaphoid", "Contour: Protuberant", "Symmetrical", "Asymmetrical", "No scars or striae", "Scars present", "Striae present (pink/purple)", "Dilated veins (caput medusae)", "Cullen's sign", "Grey Turner's sign", "Umbilicus: Inverted", "Umbilicus: Everted", "No visible masses or pulsations", "Visible mass", "Visible aortic pulsation", "Visible peristalsis"], custom_placeholder: "Describe location of scars, masses etc..." },
                            { label: "Auscultation - Bowel Sounds", type: "custom_select", id: "gi_bowel_sounds", options: ["Normoactive (5-34/min)", "Hyperactive (borborygmi)", "Hypoactive", "Absent (after 2-5 mins)", "High-pitched tinkling"], custom_placeholder: "Describe character..." },
                            { label: "Auscultation - Bruits", type: "custom_select", id: "gi_bruits", options: ["No bruits heard", "Aortic bruit", "Renal artery bruit", "Iliac artery bruit"], custom_placeholder: "Describe character..." },
                            { label: "Percussion", type: "custom_select", clonable: true, id: "gi_percussion", options: ["Generally tympanitic", "Generalized dullness (ascites?)", "Localized dullness", "Liver span normal (6-12cm)", "Liver span increased", "Traube's space tympanitic", "Traube's space dull (splenomegaly?)", "Shifting dullness negative", "Shifting dullness positive", "Bladder not palpable"], custom_placeholder: "Enter liver span in cm, describe findings..." },
                            { label: "Palpation", type: "custom_select", clonable: true, id: "gi_palpation", options: ["Soft, non-tender", "Superficial tenderness", "Deep tenderness", "Guarding (voluntary)", "Rigidity (involuntary)", "No masses palpated", "Mass palpated", "Liver not palpable", "Liver edge palpable (smooth/nodular, sharp/rounded)", "Spleen not palpable", "Splenic tip palpable", "Kidneys not palpable", "Aorta non-expansile (<3cm)", "Aorta expansile (>3cm)"], custom_placeholder: "Describe location of tenderness, mass characteristics..." },
                            { label: "Specific Signs", type: "custom_select", id: "gi_specific_signs", options: ["Murphy's sign negative", "Murphy's sign positive", "Rebound tenderness negative", "Rebound tenderness positive", "Rovsing's sign negative", "Rovsing's sign positive"], custom_placeholder: "Describe other signs..." },
                            { label: "Digital Rectal Exam (DRE)", type: "custom_select", id: "gi_dre", options: ["Not performed", "Normal tone, no masses", "Decreased tone", "Mass palpated", "Hemorrhoids", "Fissure noted"], custom_placeholder: "Describe findings, stool color..." }
                        ]
                    },
                    {
                        title: "Clinical Scoring Systems",
                        id: "gi_scoring_systems",
                        findings: [
                            { label: "Rockall Score for Upper GI Bleeding", type: "rockall_score", id: "rockall" },
                            { label: "Glasgow-Blatchford Bleeding Score (GBS)", type: "gbs_score", id: "gbs" },
                            { label: "Child-Pugh Score for Cirrhosis", type: "child_pugh_score", id: "child_pugh" },
                            { label: "MELD Score", type: "meld_score", id: "meld" },
                            { label: "Crohn's Disease Activity Index (CDAI)", type: "cdai_score", id: "cdai" },
                            { label: "Harvey-Bradshaw Index (HBI)", type: "hbi_score", id: "hbi" }
                        ]
                    }
                ]
            },
            "Neurological System": {
                id: "neurological_system",
                sections: [
                    {
                        title: "Higher Mental Functions, Consciousness & Speech",
                        id: "neuro_hmf",
                        findings: [
                            { label: "Level of Consciousness", type: "custom_select", id: "neuro_loc", options: ["Alert", "Drowsy but arousable to voice", "Stuporous (arousable to pain)", "Comatose (unresponsive)"]},
                            { label: "Cognitive Screening", type: "sub_group", id: "neuro_cognition", sub_findings: [
                                { label: "Orientation (AMTS - 3 points)", type: "checkbox_group", id: "neuro_orientation", options: ["Time (Year, Month, Time)", "Place (Hospital, Town)", "Person (Age, DOB, Name)"]},
                                { label: "Memory (MMSE)", type: "custom_select", id: "neuro_memory", options: ["Registration: 3/3", "Recall: 3/3", "Recall: 2/3", "Recall: 1/3", "Recall: 0/3"], custom_placeholder: "e.g., Recalls 'Apple', 'Table'"},
                                { label: "Attention & Calculation (MMSE)", type: "custom_select", id: "neuro_attention", options: ["Serial 7s: 5/5", "Serial 7s: 4/5", "Serial 7s: 3/5", "Serial 7s: <3/5", "Spells WORLD backwards correctly"], custom_placeholder: "e.g., 93, 86, 79..."},
                                { label: "Overall Score", type: "custom_select", id: "neuro_dementia_score", options: ["MMSE Score...", "MoCA Score...", "AMTS Score..."], custom_placeholder: "Enter score, e.g., MMSE 24/30"},
                            ]},
                            { label: "Speech & Language", type: "sub_group", id: "neuro_speech", sub_findings: [
                                { label: "Fluency", type: "custom_select", id: "speech_fluency", options: ["Normal", "Non-fluent (Broca's-like)", "Fluent (Wernicke's-like)", "Mute"]},
                                { label: "Comprehension", type: "custom_select", id: "speech_comp", options: ["Intact", "Impaired for complex commands", "Impaired for simple commands"]},
                                { label: "Repetition", type: "custom_select", id: "speech_rep", options: ["Intact", "Impaired"]},
                                { label: "Naming", type: "custom_select", id: "speech_name", options: ["Intact", "Anomia (word-finding difficulty)"]},
                                { label: "Dysarthria", type: "custom_select", id: "speech_dysarthria", options: ["None", "Spastic", "Flaccid", "Ataxic", "Hypokinetic (PD)", "Hyperkinetic"]},
                            ]},
                        ]
                    },
                    {
                        title: "Cranial Nerves Examination",
                        id: "neuro_cn",
                        findings: [
                            { label: "CN II: Vision & Fundoscopy", type: "sub_group", id: "cn2_group", sub_findings: [
                                { label: "Visual Acuity", type: "sided_clonable", id: "cn2_acuity", options: ["6/6", "6/9", "6/12", "6/18", "6/24", "6/36", "6/60", "Counting Fingers (CF)", "Hand Movements (HM)", "Perception of Light (PL)", "No Perception of Light (NPL)"], sub_options: ["Unaided", "With Glasses/Pinhole"]},
                                { label: "Pupils", type: "sided_input", id: "cn2_pupils", options: ["PERRLA", "Dilated", "Constricted", "Holmes-Adie", "Argyll Robertson", "RAPD present"]},
                                { label: "Visual Fields", type: "sided_input", id: "cn2_fields", options: ["Full to confrontation", "Superior quadrantanopia", "Inferior quadrantanopia", "Homonymous hemianopia", "Bitemporal hemianopia", "Central scotoma"]},
                                { label: "Color Vision (Ishihara)", type: "sided_input", id: "cn2_color", options: ["Normal", "Red-Green deficiency", "Not Tested"]},
                                { label: "Fundoscopy", type: "sided_clonable", id: "cn2_fundoscopy", options: [
                                    "Normal Fundus", "Diabetic: Background Changes", "Diabetic: Pre-proliferative", "Diabetic: Proliferative", "Diabetic: Maculopathy",
                                    "Hypertensive: AV nipping", "Hypertensive: Silver/Copper wiring", "Hypertensive: Flame hemorrhages", "Hypertensive: Cotton wool spots",
                                    "Papilledema", "Optic Atrophy (e.g., MS)", "Drusen", "Retinitis Pigmentosa", "CRVO (Stormy sunset)", "CRAO (Cherry red spot)"
                                ]},
                            ]},
                            { label: "CN III, IV, VI: Eye Movements", type: "sided_input", id: "cn346", options: ["Full, no nystagmus", "Gaze-evoked nystagmus", "Complete CN III Palsy", "CN IV Palsy", "CN VI Palsy", "Internuclear Ophthalmoplegia (INO)"]},
                            { label: "CN V, VII, VIII, IX, X, XI, XII", type: "custom_select", id: "cn_other", options: ["All Intact"], custom_placeholder: "Specify deficits, e.g., Left LMN CNVII palsy, Weber lateralises to Right..."},
                        ]
                    },
                    {
                        title: "Motor System Examination",
                        id: "neuro_motor",
                        findings: [
                            { label: "Inspection (Bulk, Tone, Movements)", type: "sub_group", id: "motor_inspection_group", sub_findings: [
                                { label: "Bulk", type: "custom_select", id: "motor_bulk", options: ["Normal", "Wasting (specify)", "Hypertrophy"], custom_placeholder: "e.g., Wasting of small muscles of hand"},
                                { label: "Tone", type: "custom_select", id: "motor_tone", options: ["Normal", "Spasticity", "Rigidity (Cogwheel/Lead-pipe)", "Hypotonia"], custom_placeholder: "e.g., Spasticity greater in flexors of UL, extensors of LL"},
                                { label: "Involuntary Movements", type: "custom_select", id: "motor_im", options: ["None", "Rest Tremor (PD)", "Postural Tremor", "Intention Tremor", "Chorea", "Athetosis", "Myoclonus", "Fasciculations"], custom_placeholder: "Specify location and character"},
                            ]},
                            { label: "Power - Upper Limb", type: "power_chart", id: "motor_power_ul", muscle_groups: [
                                { name: "Shoulder Abduction (C5)", muscle: "Deltoid" }, { name: "Elbow Flexion (C5, C6)", muscle: "Biceps" },
                                { name: "Elbow Extension (C7)", muscle: "Triceps" }, { name: "Wrist Extension (C6)", muscle: "ECRL/B" },
                                { name: "Finger Flexion (C8)", muscle: "FDP/S" }, { name: "Finger Abduction (T1)", muscle: "Interossei" }
                            ]},
                            { label: "Power - Lower Limb", type: "power_chart", id: "motor_power_ll", muscle_groups: [
                                { name: "Hip Flexion (L2, L3)", muscle: "Iliopsoas" }, { name: "Knee Extension (L3, L4)", muscle: "Quadriceps" },
                                { name: "Ankle Dorsiflexion (L4, L5)", muscle: "Tibialis Ant." }, { name: "Great Toe Extension (L5)", muscle: "EHL" },
                                { name: "Ankle Plantarflexion (S1)", muscle: "Gastrocnemius" }
                            ]},
                        ]
                    },
                    {
                        title: "Reflexes & Sensation",
                        id: "neuro_reflex_sensory",
                        findings: [
                            { label: "Deep Tendon Reflexes", type: "reflex_chart", id: "reflex_dtr", reflexes: [
                                { name: "Biceps (C5, C6)"}, { name: "Triceps (C7)"}, { name: "Supinator (C5, C6)"},
                                { name: "Knee (L3, L4)"}, { name: "Ankle (S1)"}
                            ]},
                            { label: "Plantar Response (Babinski)", type: "sided_input", id: "reflex_plantar", options: ["Flexor (Downgoing)", "Extensor (Upgoing)", "Equivocal"]},
                            { label: "Sensation - Spinothalamic (Pain, Temp)", type: "sensory_chart", id: "sensation_spinothalamic", dermatomes: ["C5", "C6", "C7", "C8", "T1", "T4", "T10", "L2", "L3", "L4", "L5", "S1"]},
                            { label: "Sensation - Dorsal Column (Vibration, Proprioception)", type: "sensory_chart", id: "sensation_dorsal", dermatomes: ["C5", "C6", "C7", "C8", "T1", "T4", "T10", "L2", "L3", "L4", "L5", "S1"]},
                        ]
                    },
                    {
                        title: "Neurological Scoring Systems",
                        id: "neuro_scoring_systems",
                        findings: [
                            { label: "Glasgow Coma Scale (GCS)", type: "gcs_score", id: "gcs" },
                            { label: "Modified Rankin Scale (mRS)", type: "mrs_score", id: "mrs" },
                            { label: "NIH Stroke Scale (NIHSS)", type: "nihss_score", id: "nihss" },
                            { label: "ICH Volume Calculation (ABC/2)", type: "ich_volume_score", id: "ich_volume"},
                            { label: "Subarachnoid Hemorrhage Scores", type: "sah_scores", id: "sah_scores"}
                        ]
                    }
                ]
            },
            "Musculoskeletal System": {
                id: "musculoskeletal_system",
                sections: [
                    {
                        title: "A. Clinical Examination Procedures",
                        id: "msk_exam_procedures",
                        findings: [
                            { label: "Gait", type: "custom_select", id: "msk_gait", options: ["Normal: Symmetrical, smooth, balanced", "Abnormal: Asymmetrical", "Abnormal: Unbalanced", "Abnormal: Reduced arm swing", "Abnormal: Unable to walk on tiptoes/heels"], custom_placeholder: "Describe pattern (antalgic, Trendelenburg, ataxic, etc.)..." },
                            { label: "General Posture and Alignment", type: "custom_select", clonable: true, id: "msk_alignment", options: ["Symmetrical muscle bulk", "Asymmetrical muscle bulk (atrophy)", "Normal limb alignment", "Varus deformity", "Valgus deformity", "Normal spinal alignment", "Scoliosis", "Kyphosis", "Lost/exaggerated lordosis", "Level iliac crests", "Pelvic tilt", "Full elbow/knee extension", "Fixed flexion deformity", "Popliteal swelling", "Normal foot arches", "Pes planus (flat feet)", "Pes cavus (high arches)", "Toe deformities (e.g., hallux valgus)"], custom_placeholder: "Specify location and severity..." },
                            { label: "Skin and Soft Tissues", type: "custom_select", clonable: true, id: "msk_skin", options: ["Normal: No scars or rashes", "Abnormal: Scars", "Abnormal: Rashes", "Abnormal: Bruising", "Abnormal: Swelling", "Abnormal: Nodules", "Abnormal: Erythema", "Abnormal: Muscle atrophy"], custom_placeholder: "Specify location..." },
                            { label: "Palpation", type: "custom_select", clonable: true, id: "msk_palpation", options: ["Normal: No warmth or tenderness", "Abnormal: Warmth", "Abnormal: Tenderness", "Abnormal: Swelling/effusion", "Abnormal: Synovial thickening", "Abnormal: Crepitus", "Abnormal: Mass palpated", "Abnormal: Positive MCPJ/MTPJ squeeze test", "Abnormal: Patellar tap positive"], custom_placeholder: "Specify joint/location..." },
                            { label: "Range of Motion (ROM)", type: "custom_select", clonable: true, id: "msk_rom", options: ["Full and painless active & passive ROM", "Limited active ROM", "Limited passive ROM", "Pain on movement", "Crepitus on movement"], custom_placeholder: "Specify joint, motion, and degrees (e.g., R shoulder flexion 90)..." },
                            { label: "Muscle Strength (MRC Scale)", type: "custom_select", clonable: true, id: "msk_strength", options: ["5/5: Normal power", "4/5: Active movement against some resistance", "3/5: Active movement against gravity", "2/5: Active movement with gravity eliminated", "1/5: Flicker of contraction", "0/5: No contraction"], custom_placeholder: "Specify muscle group and side (e.g., R Quadriceps 4/5)..." },
                            { label: "Special Tests", type: "custom_select", clonable: true, id: "msk_special_tests", options: ["Not performed"], custom_placeholder: "e.g., Lachman test positive (R knee)..." }
                        ]
                    },
                    {
                        title: "C. Clinical Scoring Systems",
                        id: "msk_scoring_systems",
                        findings: [
                            { label: "WOMAC Osteoarthritis Index", type: "womac_score", id: "womac" },
                            { label: "Disabilities of the Arm, Shoulder and Hand (QuickDASH)", type: "dash_score", id: "dash" },
                            { label: "Fracture Risk Assessment Tool (FRAX)", type: "frax_score", id: "frax" },
                            { label: "Musculoskeletal Health Questionnaire (MSK-HQ)", type: "mskhq_score", id: "mskhq" }
                        ]
                    }
                ]
            }
        }
    };
    
    // Dynamically create base protocols and then override with specific ones
    (function createProtocols() {
        MOCK_DATA.SYMPTOMS_BY_SYSTEM.forEach(system => {
            system.symptoms.forEach(symptom => {
                const idPrefix = symptom.replace(/[^a-zA-Z0-9]/g, '').substring(0, 3).toLowerCase();
                
                // Define symptom-specific associated symptoms and cultural context
                let associatedSymptoms = ['Fever', 'Chills', 'Nausea', 'Fatigue', 'Headache'];
                let culturalContext = ['Stress at work', 'Family problems', 'Financial worries', 'Sleep disturbance', 'Diet changes', 'Travel history', 'Social isolation', 'Religious concerns', 'Traditional medicine use', 'Alternative therapy', 'Cultural beliefs about illness', 'Language barriers', 'Healthcare access issues'];
                
                // Customize based on symptom type
                if (symptom.includes('Pain')) {
                    associatedSymptoms = ['Nausea', 'Vomiting', 'Sweating', 'Dizziness', 'Anxiety', 'Depression', 'Sleep problems', 'Reduced appetite'];
                    culturalContext = ['Work-related stress', 'Family responsibilities', 'Financial pressure', 'Cultural pain tolerance', 'Traditional pain remedies', 'Religious coping', 'Social support', 'Healthcare beliefs'];
                } else if (symptom.includes('Fever')) {
                    associatedSymptoms = ['Chills', 'Sweating', 'Body aches', 'Fatigue', 'Loss of appetite', 'Dehydration', 'Cough', 'Sore throat'];
                    culturalContext = ['Recent travel', 'Contact with sick people', 'Cultural fever management', 'Traditional remedies', 'Religious practices', 'Dietary restrictions', 'Healthcare access', 'Language barriers'];
                } else if (symptom.includes('Cough')) {
                    associatedSymptoms = ['Sputum', 'Chest pain', 'Shortness of breath', 'Fever', 'Fatigue', 'Night sweats', 'Weight loss', 'Hoarseness'];
                    culturalContext = ['Smoking habits', 'Environmental exposure', 'Work environment', 'Cultural smoking practices', 'Traditional cough remedies', 'Religious practices', 'Social stigma', 'Healthcare access'];
                } else if (symptom.includes('Headache')) {
                    associatedSymptoms = ['Nausea', 'Vomiting', 'Light sensitivity', 'Sound sensitivity', 'Vision changes', 'Dizziness', 'Fatigue', 'Stress'];
                    culturalContext = ['Work stress', 'Family pressure', 'Financial worries', 'Cultural headache beliefs', 'Traditional remedies', 'Religious practices', 'Sleep patterns', 'Dietary factors'];
                } else if (symptom.includes('Abdominal')) {
                    associatedSymptoms = ['Nausea', 'Vomiting', 'Diarrhea', 'Constipation', 'Bloating', 'Loss of appetite', 'Fever', 'Weight loss'];
                    culturalContext = ['Dietary habits', 'Food preparation', 'Cultural food practices', 'Traditional remedies', 'Religious dietary restrictions', 'Work stress', 'Family dynamics', 'Healthcare beliefs'];
                }
                
                MOCK_DATA.SYMPTOM_PROTOCOLS[symptom] = {
                    verbatimOptions: [ `'it just started'`, `'it's been bothering me for a while'`, `'it comes and goes'`, `'it's getting worse'`, `'it's affecting my daily life'` ],
                    tabs: ["Core Inquiry", "Associated", "Cultural Context"],
                    content: {
                        "Core Inquiry": [ 
                            { id: `${idPrefix}-onset`, label: 'Onset', type: 'quick-pick', options: [ 'Today', 'Yesterday', 'A few days ago', 'Last week', 'Gradual', 'Sudden'] }, 
                            { id: `${idPrefix}-duration`, label: 'Duration', type: 'quick-pick', options: [ 'Seconds', 'Minutes', 'Hours', 'Days', 'Weeks', 'Months', 'Constant'] }, 
                            { id: `${idPrefix}-severity`, label: 'Severity (0-10)', type: 'number' },
                            { id: `${idPrefix}-frequency`, label: 'Frequency', type: 'quick-pick', options: [ 'Constant', 'Intermittent', 'Occasional', 'Daily', 'Weekly', 'Monthly'] }
                        ],
                        "Associated": [ 
                            { id: `${idPrefix}-associated`, label: 'Associated Symptoms', type: 'quick-pick', options: associatedSymptoms } 
                        ],
                        "Cultural Context": [ 
                            { id: `${idPrefix}-cultural`, label: 'Cultural & Social Context', type: 'quick-pick', options: culturalContext } 
                        ]
                    }
                };
            });
        });
    })();


    // ===================================================================================
    //  SERVICES (DATA ABSTRACTION LAYER)
    // ===================================================================================
    const dataService = {
        async seedDatabase() {
            const doctorCount = await db.doctors.count();
            if (doctorCount > 0) return;
            console.log("Seeding database...");
            await db.doctors.bulkAdd(MOCK_DATA.DOCTORS);
            await db.assistants.bulkAdd(MOCK_DATA.ASSISTANTS);
        },
        async validateLogin(role, username, password) {
            let user = null;
            if (role === 'doctor') { user = await db.doctors.get({ username }); } 
            else if (role === 'assistant') { user = await db.assistants.get({ username }); }
            return (user && user.password === password) ? user : null;
        },
        async addPatient(patientData) {
            patientData.uid = 'PAT-' + Date.now();
            return await db.patients.add(patientData);
        },
        async addAppointment(appointmentData) {
            return await db.appointments.add(appointmentData);
        }
    };

    // ===================================================================================
    //  UI TEMPLATES
    // ===================================================================================
    const templates = {
        entryPoint() { return `<div class="min-h-screen bg-slate-100 flex items-center justify-center p-4"><div class="w-full max-w-2xl glass soft-shadow p-8 text-center"><h1 class="text-4xl font-bold text-blue-800 mb-2">Hospital Service Portal</h1><p class="text-slate-600 mb-8">Please select a service department</p><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div id="select-outpatient" class="p-8 bg-blue-50 hover:bg-blue-100 rounded-lg cursor-pointer transition transform hover:scale-105"><i class="fa-solid fa-stethoscope text-6xl text-blue-500 mb-4"></i><h2 class="text-2xl font-semibold text-blue-700">Outpatient</h2></div><div class="p-8 bg-red-50 hover:bg-red-100 rounded-lg cursor-not-allowed transition opacity-50"><i class="fa-solid fa-bed-pulse text-6xl text-red-400 mb-4"></i><h2 class="text-2xl font-semibold text-red-600">Inpatient</h2><p class="text-sm text-red-500">(Module Coming Soon)</p></div></div></div></div>`; },
        loginSelection() { return `<div class="min-h-screen bg-slate-100 flex items-center justify-center p-4"><div class="w-full max-w-5xl glass soft-shadow p-8"><button id="back-to-home" class="absolute top-6 left-6 px-3 py-1 bg-slate-200 rounded-full text-sm hover:bg-slate-300">&larr; Back</button><h1 class="text-3xl font-bold text-blue-800 mb-8 text-center">Outpatient Department</h1><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><div data-role="doctor" class="login-card p-6 bg-blue-50 hover:bg-blue-100 rounded-lg cursor-pointer text-center"><i class="fa-solid fa-user-doctor text-5xl text-blue-500 mb-4"></i><h2 class="text-xl font-semibold text-blue-700">Doctor</h2></div><div data-role="assistant" class="login-card p-6 bg-purple-50 hover:bg-purple-100 rounded-lg cursor-pointer text-center"><i class="fa-solid fa-user-tie text-5xl text-purple-500 mb-4"></i><h2 class="text-xl font-semibold text-purple-700">Assistant</h2></div><div class="p-6 bg-orange-50 rounded-lg text-center opacity-50 cursor-not-allowed"><i class="fa-solid fa-user-nurse text-5xl text-orange-400 mb-4"></i><h2 class="text-xl font-semibold text-orange-600">Nurse</h2></div><div class="p-6 bg-gray-50 rounded-lg text-center opacity-50 cursor-not-allowed"><i class="fa-solid fa-user-shield text-5xl text-gray-400 mb-4"></i><h2 class="text-xl font-semibold text-gray-600">Admin</h2></div></div><div class="mt-8 border-t pt-6"><div id="book-appointment" class="p-6 bg-green-50 hover:bg-green-100 rounded-lg cursor-pointer text-center"><i class="fa-solid fa-calendar-check text-5xl text-green-500 mb-4"></i><h2 class="text-xl font-semibold text-green-700">Patient Section</h2><p class="text-slate-500">Book or Manage Appointments</p></div></div></div></div>`; },
        loginModal(role) { const capRole = role.charAt(0).toUpperCase() + role.slice(1); return `<div id="login-modal-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-60 z-50 flex items-center justify-center modal-overlay"><div class="glass soft-shadow p-8 rounded-xl w-full max-w-md modal-content"><h2 class="text-2xl font-bold text-blue-800 mb-6 text-center">${capRole} Login</h2><form id="login-form"><div class="space-y-4"><div><label class="block text-sm font-medium text-slate-700 mb-1">Username</label><input id="login-username" class="w-full px-4 py-2 bg-slate-50 border rounded-lg" required value="${role === 'doctor' ? 'dr.rahman' : 'assistant1'}"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">Password</label><input id="login-password" type="password" class="w-full px-4 py-2 bg-slate-50 border rounded-lg" required value="password"></div><p id="login-error" class="text-red-500 text-sm hidden"></p><div class="flex gap-4"><button type="button" id="cancel-login" class="w-full py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Cancel</button><button type="submit" class="w-full py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Login</button></div></div></form></div></div>`; },
        doctorPortal(doctor) { return `<div class="p-4 md:p-8 max-w-screen-xl mx-auto"><header class="glass soft-shadow p-4 mb-6 flex justify-between items-center"><div><h1 class="text-2xl font-bold">Dr. ${doctor.name}'s Dashboard</h1><p class="text-slate-500">${doctor.specialty}</p></div><div class="flex gap-2"><button id="add-patient-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"><i class="fa-solid fa-user-plus mr-2"></i>Add New Patient</button><button id="add-appointment-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"><i class="fa-solid fa-calendar-plus mr-2"></i>New Appointment</button><button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"><i class="fa-solid fa-right-from-bracket mr-2"></i>Logout</button></div></header><main><div class="flex items-center gap-4 mb-4"><label class="font-semibold">Select Date:</label><input type="date" id="appointment-date-picker" class="px-3 py-2 border rounded" value="${new Date().toISOString().split('T')[0]}"></div><h2 class="text-xl font-semibold mb-4 text-slate-700">Appointments</h2><div id="appointment-list" class="space-y-4"></div></main></div>`; },
        addPatientModal() { return `<div id="add-patient-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 z-50 flex items-center justify-center modal-overlay"><div class="bg-white rounded-xl p-8 w-full max-w-md modal-content"><h2 class="text-xl font-bold mb-4">Add New Patient</h2><form id="add-patient-form" class="space-y-4"><input required name="name" class="input-field" placeholder="Full Name"><input required name="dob" type="date" class="input-field" placeholder="Date of Birth"><select required name="gender" class="input-field"><option value="">Select Gender</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select><input required name="phone" class="input-field" placeholder="Phone Number"><div class="flex gap-2 justify-end"><button type="button" id="cancel-add-patient" class="px-4 py-2 bg-slate-200 rounded">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Add Patient</button></div></form></div></div>`; },
        addAppointmentModal() { return `<div id="add-appointment-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 z-50 flex items-center justify-center modal-overlay"><div class="bg-white rounded-xl p-8 w-full max-w-md modal-content"><h2 class="text-xl font-bold mb-4">New Appointment</h2><form id="add-appointment-form" class="space-y-4"><select required name="patientId" class="input-field" id="patient-select-for-appt"></select><input required name="date" type="date" class="input-field" value="${new Date().toISOString().split('T')[0]}"><input required name="timeSlot" type="time" class="input-field"><div class="flex gap-2 items-center"><input type="checkbox" id="consult-now" name="consultNow"><label for="consult-now">Consult Now</label></div><div class="flex gap-2 justify-end"><button type="button" id="cancel-add-appointment" class="px-4 py-2 bg-slate-200 rounded">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Add</button></div></form></div></div>`; },
        addNewMedicineModal() { return `<div id="add-new-medicine-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 z-50 flex items-center justify-center modal-overlay"><div class="bg-white rounded-xl p-8 w-full max-w-4xl modal-content max-h-screen overflow-y-auto"><h2 class="text-xl font-bold mb-6">Add New Medicine</h2><form id="add-new-medicine-form" class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="label-text">Medicine Name (Generic)</label><input required name="genericName" class="input-field" placeholder="e.g., Paracetamol"></div><div><label class="label-text">Formulation</label><select required name="formulation" class="input-field"><option value="">Select Formulation</option><option value="Tablet">Tablet</option><option value="Capsule">Capsule</option><option value="Syrup">Syrup</option><option value="Suspension">Suspension</option><option value="Injection">Injection</option><option value="Cream">Cream</option><option value="Gel">Gel</option><option value="Ointment">Ointment</option><option value="Suppository">Suppository</option><option value="Inhaler">Inhaler</option><option value="Drops">Drops</option><option value="Sustained Release">Sustained Release</option><option value="Extended Release">Extended Release</option><option value="Nebulizer">Nebulizer</option><option value="Spray">Spray</option><option value="Ointment">Ointment</option><option value="Eye/Ear Drops">Eye/Ear Drops</option></select></div><div><label class="label-text">Strength</label><input required name="strength" class="input-field" placeholder="e.g., 500mg"></div><div class="relative"><label class="label-text">Pharmaceutical Company</label><div class="flex gap-2"><select required name="company" id="company-select" class="input-field flex-grow"><option value="">Select Company</option><option value="Square Pharmaceuticals">Square Pharmaceuticals</option><option value="Beximco Pharmaceuticals">Beximco Pharmaceuticals</option><option value="Incepta Pharmaceuticals">Incepta Pharmaceuticals</option><option value="ACI Limited">ACI Limited</option><option value="Renata Limited">Renata Limited</option><option value="Opsonin Pharma">Opsonin Pharma</option><option value="Healthcare Pharmaceuticals">Healthcare Pharmaceuticals</option><option value="Drug International">Drug International</option><option value="Popular Pharmaceuticals">Popular Pharmaceuticals</option><option value="Globe Pharmaceuticals">Globe Pharmaceuticals</option><option value="Generic">Generic</option><option value="Other">Other</option></select><button type="button" id="add-company-btn" class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition" title="Add New Company"><i class="fa-solid fa-plus"></i></button></div></div></div><div class="border-t pt-4"><h3 class="font-semibold mb-3">Combination Medicine (Optional)</h3><div id="combination-medicines-container" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 combination-medicine-row"><div><label class="label-text">Second Medicine Name</label><input name="secondGenericName" class="input-field" placeholder="e.g., Clavulanic Acid"></div><div><label class="label-text">Second Medicine Strength</label><input name="secondStrength" class="input-field" placeholder="e.g., 125mg"></div></div></div><div class="flex gap-2 mb-4"><button type="button" id="add-combination-medicine-btn" class="px-4 py-2 bg-green-100 text-green-700 rounded-md hover:bg-green-200 transition text-sm"><i class="fa-solid fa-plus mr-1"></i>Add Another Medicine</button><button type="button" id="remove-combination-medicine-btn" class="px-4 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition text-sm hidden"><i class="fa-solid fa-minus mr-1"></i>Remove Last Medicine</button></div></div><div class="flex gap-3 justify-end"><button type="button" id="cancel-add-new-medicine" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 transition">Cancel</button><button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">Add Medicine</button></div></form></div></div>`; },
        consultationView(patient, appointment, doctor) { return `<div class="flex flex-col md:flex-row gap-6 p-4 md:p-8 max-w-screen-2xl mx-auto"><div class="w-full md:w-2/3 space-y-6"><div class="glass soft-shadow p-4 flex justify-between items-center"><di><h2 class="text-2xl font-bold">${patient.name}</h2><p class="text-slate-500">Age: ${app.utils.calculateAge(patient.dob)} | Gender: ${patient.gender} | Phone: ${patient.phone}</p></di><button id="back-to-dashboard" class="px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition"><i class="fa-solid fa-arrow-left mr-2"></i> Back</button></div>
            <div id="history-section" class="glass soft-shadow p-6"></div>
            <div id="pastMedicalHistory-section" class="glass soft-shadow p-6"></div>
            <div id="drugHistory-section" class="glass soft-shadow p-6"></div>
            <div id="familyHistory-section" class="glass soft-shadow p-6"></div>
            <div id="menstrualHistory-section" class="glass soft-shadow p-6"></div>
            <div id="obsGynaeHistory-section" class="glass soft-shadow p-6"></div>
            <div id="personalHistory-section" class="glass soft-shadow p-6"></div>
            <div id="socioeconomicHistory-section" class="glass soft-shadow p-6"></div>
            <div id="occupationalHistory-section" class="glass soft-shadow p-6"></div>
            <div id="immunizationHistory-section" class="glass soft-shadow p-6"></div>
            <div id="examination-section" class="glass soft-shadow p-6"></div>
            <div id="investigations-section" class="glass soft-shadow p-6"></div>
            <div id="prescription-section" class="glass soft-shadow p-6"></div>
            <div class="flex justify-end gap-4"><button id="save-consultation" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">Save Consultation</button><button id="generate-prescription" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">Generate Prescription</button></div></div>
            <aside class="w-full md:w-1/3 space-y-4">
                <div class="glass soft-shadow p-4 h-screen-90 sticky top-4 overflow-y-auto">
                    <div class="section-title">Live Summary</div>
                    <div id="live-summary-content" class="text-sm space-y-3 prose prose-sm max-w-none">
                        <p class="text-slate-400">Begin consultation to see live summary.</p>
                    </div>
                </div>
                
                <!-- Live Prescription Preview -->
                <div class="glass soft-shadow p-4 sticky top-4">
                    <div class="section-title">Prescription Preview</div>
                    <div id="prescription-preview" class="text-sm space-y-2">
                        <div class="text-slate-400 text-center py-4">No medicines added yet.</div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-slate-200">
                        <div class="flex justify-between items-center text-xs text-slate-500">
                            <span>Total Medicines: <span id="total-medicines">0</span></span>
                            <span>Last Updated: <span id="last-updated">-</span></span>
                        </div>
                    </div>
                </div>
            </aside>
            </div><div id="prescription-print-area" class="hidden"></div>`; }
    };

    // ===================================================================================
    //  APPLICATION LOGIC
    // ===================================================================================
    const app = {
        state: { currentUser: null, currentView: 'home', selectedAppointmentId: null, consultationData: {} },
        init() { this.router.route(); window.addEventListener('hashchange', () => this.router.route()); dataService.seedDatabase(); },
        utils: { 
            calculateAge(dob) { if (!dob) return 'N/A'; const birthDate = new Date(dob); const today = new Date(); let age = today.getFullYear() - birthDate.getFullYear(); const m = today.getMonth() - birthDate.getMonth(); if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; } return age; },
            getCustomOptions(key) { try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch { return []; } },
            addCustomOption(key, value) { let arr = this.getCustomOptions(key); if (!arr.includes(value)) { arr.push(value); localStorage.setItem(key, JSON.stringify(arr)); } },
            getAllOptions(fieldKey, defaults) { return [...new Set([...defaults, ...this.getCustomOptions(fieldKey)])]; },
            getCustomInvestigations() { try { return JSON.parse(localStorage.getItem('custom_investigations') || '[]'); } catch { return []; } },
            saveCustomInvestigation(investigation) { 
                let customInvs = this.getCustomInvestigations(); 
                if (!customInvs.some(inv => inv.name === investigation.name)) { 
                    customInvs.push(investigation); 
                    localStorage.setItem('custom_investigations', JSON.stringify(customInvs)); 
                } 
            },
            getAllInvestigations() {
                const customInvs = this.getCustomInvestigations();
                const allInvs = { ...MOCK_DATA.INVESTIGATIONS.categories };
                
                // Add custom investigations to a "Custom" category
                if (customInvs.length > 0) {
                    allInvs["Custom"] = {};
                    customInvs.forEach(inv => {
                        allInvs["Custom"][inv.name] = {
                            components: inv.components || [],
                            timing: [inv.timing || "Scheduled"],
                            special_instructions: inv.details || ""
                        };
                    });
                }
                
                return allInvs;
            },
            getDefaultCompanyPreferences() {
                try {
                    return JSON.parse(localStorage.getItem('default_company_preferences') || '{}');
                } catch {
                    return {};
                }
            },
            setDefaultCompanyPreference(genericName, company) {
                const preferences = this.getDefaultCompanyPreferences();
                preferences[genericName] = company;
                localStorage.setItem('default_company_preferences', JSON.stringify(preferences));
            },
            getDefaultCompanyForGeneric(genericName) {
                const preferences = this.getDefaultCompanyPreferences();
                return preferences[genericName] || null;
            },
            getTradeNamesForGeneric(genericName, company = null) {
                const tradeNames = [];
                Object.keys(MOCK_DATA.MEDICINE_DATABASE.brandNames).forEach(brandName => {
                    const brandData = MOCK_DATA.MEDICINE_DATABASE.brandNames[brandName];
                    if (brandData.generic === genericName) {
                        if (!company || brandData.company === company) {
                            tradeNames.push({
                                name: brandName,
                                company: brandData.company,
                                strength: brandData.strength,
                                formulation: brandData.formulation
                            });
                        }
                    }
                });
                return tradeNames.sort((a, b) => a.name.localeCompare(b.name));
            },
            
            setDefaultRoutePreference(genericName, route) {
                const preferences = JSON.parse(localStorage.getItem('medicinePreferences') || '{}');
                if (!preferences[genericName]) {
                    preferences[genericName] = {};
                }
                preferences[genericName].defaultRoute = route;
                localStorage.setItem('medicinePreferences', JSON.stringify(preferences));
            },
            
            getDefaultRoutePreference(genericName) {
                const preferences = JSON.parse(localStorage.getItem('medicinePreferences') || '{}');
                return preferences[genericName]?.defaultRoute || null;
            },
            
            setDefaultInstructionsPreference(genericName, instructions) {
                const preferences = JSON.parse(localStorage.getItem('medicinePreferences') || '{}');
                if (!preferences[genericName]) {
                    preferences[genericName] = {};
                }
                preferences[genericName].defaultInstructions = instructions;
                localStorage.setItem('medicinePreferences', JSON.stringify(preferences));
            },
            
            getDefaultInstructionsPreference(genericName) {
                const preferences = JSON.parse(localStorage.getItem('medicinePreferences') || '{}');
                return preferences[genericName]?.defaultInstructions || [];
            },
            
            setDefaultDosagePreference(genericName, dosage) {
                const preferences = JSON.parse(localStorage.getItem('medicinePreferences') || '{}');
                if (!preferences[genericName]) {
                    preferences[genericName] = {};
                }
                preferences[genericName].defaultDosage = dosage;
                localStorage.setItem('medicinePreferences', JSON.stringify(preferences));
            },
            
            getDefaultDosagePreference(genericName) {
                const preferences = JSON.parse(localStorage.getItem('medicinePreferences') || '{}');
                return preferences[genericName]?.defaultDosage || null;
            },
            
            setDefaultFrequencyPreference(genericName, frequency) {
                const preferences = JSON.parse(localStorage.getItem('medicinePreferences') || '{}');
                if (!preferences[genericName]) {
                    preferences[genericName] = {};
                }
                preferences[genericName].defaultFrequency = frequency;
                localStorage.setItem('medicinePreferences', JSON.stringify(preferences));
            },
            
            getDefaultFrequencyPreference(genericName) {
                const preferences = JSON.parse(localStorage.getItem('medicinePreferences') || '{}');
                return preferences[genericName]?.defaultFrequency || null;
            },
            
            setDefaultDurationPreference(genericName, duration) {
                const preferences = JSON.parse(localStorage.getItem('medicinePreferences') || '{}');
                if (!preferences[genericName]) {
                    preferences[genericName] = {};
                }
                preferences[genericName].defaultDuration = duration;
                localStorage.setItem('medicinePreferences', JSON.stringify(preferences));
            },
            
            getDefaultDurationPreference(genericName) {
                const preferences = JSON.parse(localStorage.getItem('medicinePreferences') || '{}');
                return preferences[genericName]?.defaultDuration || null;
            }
        },
        router: {
            route() {
                const hash = window.location.hash.slice(1) || 'home';
                const [view, param] = hash.split('/');
                app.state.currentView = view;
                const container = document.getElementById('app-container');
                switch(view) {
                    case 'home': container.innerHTML = templates.entryPoint(); this.attachHomeListeners(); break;
                    case 'login-selection': container.innerHTML = templates.loginSelection(); this.attachLoginSelectionListeners(); break;
                    case 'doctor': this.renderDoctorPortal(param); break;
                    case 'consultation': this.renderConsultation(param); break;
                    default: window.location.hash = 'home';
                }
            },
            attachHomeListeners() { document.getElementById('select-outpatient').onclick = () => window.location.hash = 'login-selection'; },
            attachLoginSelectionListeners() { document.getElementById('back-to-home').onclick = () => window.location.hash = 'home'; document.querySelectorAll('.login-card').forEach(card => { card.onclick = () => app.handlers.showLoginModal(card.dataset.role); }); },
            async renderDoctorPortal(username) {
                const doctor = await db.doctors.get({ username });
                if (!doctor) { alert('Doctor not found!'); window.location.hash = 'home'; return; }
                document.getElementById('app-container').innerHTML = templates.doctorPortal(doctor);
                document.getElementById('logout-btn').onclick = () => { app.state.currentUser = null; window.location.hash = 'home'; };
                document.getElementById('add-patient-btn').onclick = () => app.handlers.showAddPatientModal(doctor.id);
                document.getElementById('add-appointment-btn').onclick = () => app.handlers.showAddAppointmentModal(doctor.id);
                const datePicker = document.getElementById('appointment-date-picker');
                datePicker.onchange = () => this.loadAppointments(doctor.id, datePicker.value);
                this.loadAppointments(doctor.id, datePicker.value);
            },
            async loadAppointments(doctorId, dateStr) {
                let appointments = await db.appointments.where({ doctorId, date: dateStr }).toArray();
                const listEl = document.getElementById('appointment-list');
                listEl.innerHTML = '';
                if (appointments.length === 0) {
                    listEl.innerHTML = `<p class="text-center text-slate-500">No appointments scheduled for this date.</p>`;
                    return;
                }
                for (const appt of appointments) {
                    const patient = await db.patients.get(appt.patientId);
                    const el = document.createElement('div');
                    el.className = 'glass soft-shadow p-4 flex justify-between items-center';
                    el.innerHTML = `<div><p class="font-bold text-lg">${patient.name}</p><p class="text-sm text-slate-500">Time: ${appt.timeSlot} | Status: <span class="font-semibold text-green-600">${appt.status.toUpperCase()}</span></p></div><button data-appointment-id="${appt.id}" class="start-consultation-btn px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Start Consultation</button>`;
                    listEl.appendChild(el);
                }
                document.querySelectorAll('.start-consultation-btn').forEach(btn => { btn.onclick = () => window.location.hash = `consultation/${btn.dataset.appointmentId}`; });
            },
            async renderConsultation(appointmentId) {
                const id = parseInt(appointmentId);
                const appointment = await db.appointments.get(id);
                const patient = await db.patients.get(appointment.patientId);
                const doctor = await db.doctors.get(appointment.doctorId);
                
                // Check for existing consultation data
                let existingConsultation = await db.consultations.where({ appointmentId: id }).first();
                app.state.selectedAppointmentId = id;
                app.state.consultationData = existingConsultation ? existingConsultation.data : { 
                    history: [], 
                    examinations: {}, 
                    pastMedicalHistory: [], 
                    drugHistory: [], 
                    familyHistory: [], 
                    menstrualHistory: [], 
                    obsGynaeHistory: [], 
                    personalHistory: [], 
                    socioeconomicHistory: [], 
                    occupationalHistory: [], 
                    immunizationHistory: [],
                    investigations: [], 
                    prescriptions: [] 
                };

                document.getElementById('app-container').innerHTML = templates.consultationView(patient, appointment, doctor);
                this.attachConsultationListeners(doctor);
                this.renderConsultationSections();
                this.updatePrescriptionPreview();
            },
            attachConsultationListeners(doctor) {
                document.getElementById('back-to-dashboard').onclick = () => window.location.hash = `doctor/${doctor.username}`;
                document.getElementById('generate-prescription').onclick = () => app.handlers.generatePdf(doctor);
                document.getElementById('save-consultation').onclick = () => app.handlers.saveConsultation(doctor);
            },
            renderConsultationSections() {
                this.renderHistorySection();
                this.renderPastMedicalHistorySection();
                this.renderDrugHistorySection();
                this.renderFamilyHistorySection();
                this.renderMenstrualHistorySection();
                this.renderObsGynaeHistorySection();
                this.renderPersonalHistorySection();
                this.renderSocioeconomicHistorySection();
                this.renderOccupationalHistorySection();
                this.renderImmunizationHistorySection();
                this.renderExaminationSection();
                this.renderInvestigationSection();
                this.renderPrescriptionSection();
                this.updateLiveSummary();
                this.updatePrescriptionPreview();
            },
            renderHistorySection() {
                const container = document.getElementById('history-section');
                container.innerHTML = `<h2 class="section-title">History of Presenting Complaint</h2><div class="mb-4"><label for="symptom-select" class="label-text">1. Add Presenting Complaint</label><select id="symptom-select" class="input-field"><option value="">-- Add a symptom to document --</option></select></div><div id="symptom-cards-container" class="space-y-6"></div>`;
                const select = container.querySelector('#symptom-select');
                const allSymptoms = [...new Set([...MOCK_DATA.SYMPTOMS_BY_SYSTEM.flatMap(s => s.symptoms), ...app.utils.getCustomOptions('custom_presenting_complaints')])];
                allSymptoms.forEach(symptom => {
                    const option = document.createElement('option');
                    option.value = symptom;
                    option.textContent = symptom;
                    select.appendChild(option);
                });
                if (!container.querySelector('#add-symptom-btn')) {
                    const addSymptomDiv = document.createElement('div');
                    addSymptomDiv.className = 'flex gap-2 mt-2';
                    addSymptomDiv.innerHTML = `<input id="add-symptom-input" class="input-field" placeholder="Add new symptom..."><button id="add-symptom-btn" class="px-3 py-2 bg-blue-500 text-white rounded-md">+</button>`;
                    select.parentElement.appendChild(addSymptomDiv);
                    document.getElementById('add-symptom-btn').onclick = () => {
                        const input = document.getElementById('add-symptom-input');
                        const val = input.value.trim();
                        if (val) { app.utils.addCustomOption('custom_presenting_complaints', val); this.renderHistorySection(); input.value = ''; }
                    };
                }
                select.onchange = (e) => { if (!e.target.value) return; app.handlers.addSymptom(e.target.value); e.target.value = ''; };
                container.querySelector('#symptom-cards-container').innerHTML = '';
                app.state.consultationData.history.forEach(symptom => this.renderSymptomCard(symptom));
            },
            renderSymptomCard(symptom) {
                const container = document.getElementById('symptom-cards-container');
                const protocol = MOCK_DATA.SYMPTOM_PROTOCOLS[symptom.name] || MOCK_DATA.SYMPTOM_PROTOCOLS['Default'];
                if (!protocol) return;
                const wrapper = document.createElement('div');
                wrapper.id = symptom.id;
                wrapper.className = 'p-4 border border-slate-200 rounded-lg';
                wrapper.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-blue-700">${symptom.name}</h3><button data-symptom-id="${symptom.id}" class="remove-symptom-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button></div><div id="${symptom.id}-details"></div>`;
                container.appendChild(wrapper);
                const detailsContainer = wrapper.querySelector(`#${symptom.id}-details`);
                const verbatimKey = `custom_verbatim_${symptom.name.replace(/\s/g, '_')}`;
                const allVerbatimOptions = app.utils.getAllOptions(verbatimKey, protocol.verbatimOptions);
                detailsContainer.innerHTML = `<div class="mb-4"><label class="label-text">Patient's Verbatim</label><input type="text" data-field="patientWords" class="input-field" readonly><div class="flex flex-wrap gap-2 mt-2">${allVerbatimOptions.map(opt => `<button type="button" data-value="${opt}" class="quick-pick-btn verbatim-pick">${opt}</button>`).join('')}</div><div class="flex gap-2 mt-2"><input class="input-field text-xs" placeholder="Add new description..."><button data-key="${verbatimKey}" class="add-option-btn px-2 text-xs bg-blue-500 text-white rounded-md">+</button></div></div><div class="border-b border-slate-200"><nav class="tab-nav -mb-px flex flex-wrap space-x-4"></nav></div><div class="mt-4 tab-content"></div>`;
                const nav = detailsContainer.querySelector('.tab-nav');
                protocol.tabs.forEach((tab, index) => {
                    const btn = document.createElement('button');
                    btn.textContent = tab;
                    btn.className = `py-2 px-1 text-sm tab-btn ${index === 0 ? 'active' : ''}`;
                    btn.dataset.tab = tab;
                    nav.appendChild(btn);
                });
                this.renderSymptomTabContent(symptom, protocol.tabs[0]);
                wrapper.addEventListener('click', (e) => app.handlers.handleSymptomCardClick(e, symptom));
                wrapper.addEventListener('input', (e) => app.handlers.handleSymptomCardInput(e, symptom));
                wrapper.addEventListener('change', (e) => app.handlers.handleSymptomCardInput(e, symptom));
            },
            renderSymptomTabContent(symptom, tab) {
                const contentContainer = document.getElementById(symptom.id).querySelector('.tab-content');
                const protocol = MOCK_DATA.SYMPTOM_PROTOCOLS[symptom.name];
                if (!protocol || !protocol.content[tab]) { contentContainer.innerHTML = ''; return; }
                contentContainer.innerHTML = protocol.content[tab].map(q => this.renderFormControl(symptom, q)).join('');
            },
            renderFormControl(symptom, q) {
                const fieldValue = symptom.data[q.id] || '';
                const fieldKey = `custom_${symptom.name.replace(/\s/g, '_')}_${q.id}`;
                const allOptions = q.options ? app.utils.getAllOptions(fieldKey, q.options) : [];
                let controlHtml = `<div class="mb-4"><label class="label-text">${q.label}</label>`;
                switch (q.type) {
                    case 'select': controlHtml += `<select data-field="${q.id}" class="input-field"><option value=""></option>${allOptions.map(opt => `<option value="${opt}" ${fieldValue === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select>`; break;
                    case 'checkboxes': const checkedItems = fieldValue || []; controlHtml += `<div data-field="${q.id}" class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm mt-2">${allOptions.map(opt => `<label class="flex items-center gap-2"><input type="checkbox" value="${opt}" ${checkedItems.includes(opt) ? 'checked' : ''} data-field="${q.id}"><span>${opt}</span></label>`).join('')}</div>`; break;
                    case 'quick-pick': const selectedWords = fieldValue ? fieldValue.split(', ') : []; controlHtml += `<input type="text" data-field="${q.id}" class="input-field" value="${fieldValue}" readonly><div class="flex flex-wrap gap-2 mt-2">${allOptions.map(opt => `<button type="button" data-value="${opt}" class="quick-pick-btn ${selectedWords.includes(opt) ? 'selected' : ''}">${opt}</button>`).join('')}</div>`; break;
                    default: controlHtml += `<input type="${q.type}" data-field="${q.id}" class="input-field" placeholder="${q.placeholder || ''}" value="${fieldValue}">`;
                }
                controlHtml += '</div>';
                const wrapper = document.createElement('div');
                wrapper.innerHTML = controlHtml;
                if (['select', 'quick-pick', 'checkboxes'].includes(q.type)) {
                    const addDiv = document.createElement('div');
                    addDiv.className = 'flex gap-2 mt-1';
                    addDiv.innerHTML = `<input class="input-field text-xs" placeholder="Add new option..."><button data-key="${fieldKey}" data-type="${q.type}" class="add-option-btn px-2 text-xs bg-blue-500 text-white rounded-md">+</button>`;
                    wrapper.appendChild(addDiv);
                }
                return wrapper.innerHTML;
            },
            renderPastMedicalHistorySection() {
                this.renderSection('pastMedicalHistory', 'Past Medical History', MOCK_DATA.PAST_MEDICAL_HISTORY);
            },
            renderDrugHistorySection() {
                this.renderSection('drugHistory', 'Drug History', MOCK_DATA.DRUG_HISTORY);
            },
            renderFamilyHistorySection() {
                this.renderSection('familyHistory', 'Family History', MOCK_DATA.FAMILY_HISTORY);
            },
            renderMenstrualHistorySection() {
                this.renderSection('menstrualHistory', 'Menstrual History', MOCK_DATA.MENSTRUAL_HISTORY);
            },
            renderObsGynaeHistorySection() {
                this.renderSection('obsGynaeHistory', 'Obstetric & Gynecological History', MOCK_DATA.OBS_GYNAE_HISTORY);
            },
            renderPersonalHistorySection() {
                this.renderSection('personalHistory', 'Personal History', MOCK_DATA.PERSONAL_HISTORY);
            },
            renderSocioeconomicHistorySection() {
                this.renderSection('socioeconomicHistory', 'Socioeconomic History', MOCK_DATA.SOCIOECONOMIC_HISTORY);
            },
            renderOccupationalHistorySection() {
                this.renderSection('occupationalHistory', 'Occupational History', MOCK_DATA.OCCUPATIONAL_HISTORY);
            },
            renderImmunizationHistorySection() {
                this.renderSection('immunizationHistory', 'Immunization History', MOCK_DATA.IMMUNIZATION_HISTORY);
            },
            renderExaminationSection() {
                const container = document.getElementById('examination-section');
                const examSystems = Object.keys(MOCK_DATA.EXAMINATION_DATA);
                container.innerHTML = `<h2 class="section-title">Examination</h2><div class="mb-4"><label for="exam-system-select" class="label-text">Select System</label><select id="exam-system-select" class="input-field"><option value="">-- Select Examination System --</option>${examSystems.map(sys => `<option value="${sys}">${sys}</option>`).join('')}</select></div><div id="exam-system-details"></div>`;
                const select = container.querySelector('#exam-system-select');
                select.onchange = () => {
                    const systemKey = select.value;
                    const detailsContainer = container.querySelector('#exam-system-details');
                    detailsContainer.innerHTML = '';
                    if (!systemKey) return;
                    const system = MOCK_DATA.EXAMINATION_DATA[systemKey];
                    system.sections.forEach(section => {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'mb-4 border-t pt-4';
                        sectionDiv.innerHTML = `<h4 class="font-semibold text-blue-700 mb-2">${section.title}</h4>`;
                        section.findings.forEach(finding => {
                            const findingDiv = document.createElement('div');
                            findingDiv.className = 'mb-2';
                            findingDiv.innerHTML = `<label class="label-text">${finding.label}</label>`;
                            
                            // Handle different finding types
                            if (finding.type === 'custom_select') {
                                const select = document.createElement('select');
                                select.className = 'input-field';
                                select.innerHTML = `<option value="">-- Select --</option>` + finding.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                                select.onchange = () => {
                                    if (!app.state.consultationData.examinations[systemKey]) app.state.consultationData.examinations[systemKey] = {};
                                    app.state.consultationData.examinations[systemKey][finding.label] = select.value;
                                    this.updateLiveSummary();
                                };
                                findingDiv.appendChild(select);
                                
                                // Add custom input field if specified
                                if (finding.custom_placeholder) {
                                    const customInput = document.createElement('input');
                                    customInput.type = 'text';
                                    customInput.className = 'input-field mt-1 text-sm';
                                    customInput.placeholder = finding.custom_placeholder;
                                    customInput.onchange = () => {
                                        if (!app.state.consultationData.examinations[systemKey]) app.state.consultationData.examinations[systemKey] = {};
                                        const currentValue = app.state.consultationData.examinations[systemKey][finding.label] || '';
                                        app.state.consultationData.examinations[systemKey][finding.label] = currentValue + (currentValue ? ' - ' : '') + customInput.value;
                                        this.updateLiveSummary();
                                    };
                                    findingDiv.appendChild(customInput);
                                }
                            } else if (finding.type === 'temperature_group') {
                                const tempDiv = this.createTemperatureGroup(finding);
                                findingDiv.appendChild(tempDiv);
                            } else if (finding.type === 'bp_group') {
                                const bpDiv = this.createBloodPressureGroup(finding);
                                findingDiv.appendChild(bpDiv);
                            } else if (finding.type === 'peripheral_pulse_group') {
                                const pulseDiv = this.createPeripheralPulseGroup(finding);
                                findingDiv.appendChild(pulseDiv);
                            } else if (finding.type === 'palpation_group') {
                                const palpDiv = this.createPalpationGroup(finding);
                                findingDiv.appendChild(palpDiv);
                            } else if (finding.type === 'murmur_group') {
                                const murmurDiv = this.createMurmurGroup(finding);
                                findingDiv.appendChild(murmurDiv);
                            } else if (finding.type === 'framingham_score') {
                                const scoreDiv = this.createFraminghamScore(finding);
                                findingDiv.appendChild(scoreDiv);
                            } else if (finding.type === 'timi_score') {
                                const scoreDiv = this.createTimiScore(finding);
                                findingDiv.appendChild(scoreDiv);
                            } else if (finding.type === 'calcium_score') {
                                const scoreDiv = this.createCalciumScore(finding);
                                findingDiv.appendChild(scoreDiv);
                            } else if (finding.type === 'syntax_score') {
                                const scoreDiv = this.createSyntaxScore(finding);
                                findingDiv.appendChild(scoreDiv);
                            } else if (finding.type === 'gcs_score') {
                                const scoreDiv = this.createGCSScore(finding);
                                findingDiv.appendChild(scoreDiv);
                            } else if (finding.type === 'nihss_score') {
                                const scoreDiv = this.createNIHSSScore(finding);
                                findingDiv.appendChild(scoreDiv);
                            } else if (finding.type === 'curb65_score') {
                                const scoreDiv = this.createCURB65Score(finding);
                                findingDiv.appendChild(scoreDiv);
                            } else if (finding.type === 'wells_pe_score') {
                                const scoreDiv = this.createWellsPEScore(finding);
                                findingDiv.appendChild(scoreDiv);
                            } else if (finding.type === 'rockall_score') {
                                const scoreDiv = this.createRockallScore(finding);
                                findingDiv.appendChild(scoreDiv);
                            } else if (finding.type === 'child_pugh_score') {
                                const scoreDiv = this.createChildPughScore(finding);
                                findingDiv.appendChild(scoreDiv);
                            } else if (finding.type === 'womac_score') {
                                const scoreDiv = this.createWOMACScore(finding);
                                findingDiv.appendChild(scoreDiv);
                            } else if (finding.type === 'sub_group') {
                                const subDiv = this.createSubGroup(finding);
                                findingDiv.appendChild(subDiv);
                            } else if (finding.type === 'sided_input') {
                                const sidedDiv = this.createSidedInput(finding);
                                findingDiv.appendChild(sidedDiv);
                            } else if (finding.type === 'power_chart') {
                                const powerDiv = this.createPowerChart(finding);
                                findingDiv.appendChild(powerDiv);
                            } else if (finding.type === 'reflex_chart') {
                                const reflexDiv = this.createReflexChart(finding);
                                findingDiv.appendChild(reflexDiv);
                            } else if (finding.type === 'sensory_chart') {
                                const sensoryDiv = this.createSensoryChart(finding);
                                findingDiv.appendChild(sensoryDiv);
                            } else if (finding.type === 'checkbox_group') {
                                const checkboxDiv = this.createCheckboxGroup(finding);
                                findingDiv.appendChild(checkboxDiv);
                            } else if (finding.type === 'sided_clonable') {
                                const sidedClonableDiv = this.createSidedClonable(finding);
                                findingDiv.appendChild(sidedClonableDiv);
                            }
                            
                            sectionDiv.appendChild(findingDiv);
                        });
                        detailsContainer.appendChild(sectionDiv);
                    });
                };
            },
            
            // Advanced Examination Component Creation Functions
            createTemperatureGroup(finding) {
                const container = document.createElement('div');
                container.className = 'temp-group';
                container.innerHTML = `
                    <div>
                        <label class="label-text text-sm">Temperature Value</label>
                        <input type="number" step="0.1" class="finding-input temp-value" placeholder="e.g., 37.2">
                    </div>
                    <div>
                        <label class="label-text text-sm">Unit</label>
                        <div class="unit-toggle">
                            <button type="button" class="temp-unit active" data-unit="C">C</button>
                            <button type="button" class="temp-unit" data-unit="F">F</button>
                        </div>
                    </div>
                `;
                
                container.querySelectorAll('.temp-unit').forEach(btn => {
                    btn.onclick = () => {
                        container.querySelectorAll('.temp-unit').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    };
                });
                
                return container;
            },
            
            createBloodPressureGroup(finding) {
                const container = document.createElement('div');
                container.className = 'bp-entry-row';
                container.innerHTML = `
                    <div>
                        <label class="label-text text-sm">Systolic</label>
                        <input type="number" class="finding-input bp-systolic" placeholder="120">
                    </div>
                    <div>
                        <label class="label-text text-sm">Diastolic</label>
                        <input type="number" class="finding-input bp-diastolic" placeholder="80">
                    </div>
                    <div>
                        <label class="label-text text-sm">Position</label>
                        <select class="finding-select bp-position">
                            <option value="Sitting">Sitting</option>
                            <option value="Standing">Standing</option>
                            <option value="Lying">Lying</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-text text-sm">Arm</label>
                        <select class="finding-select bp-arm">
                            <option value="Right">Right</option>
                            <option value="Left">Left</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-text text-sm">Result</label>
                        <div class="bp-result text-sm font-semibold text-blue-600"></div>
                    </div>
                `;
                
                const updateResult = () => {
                    const systolic = container.querySelector('.bp-systolic').value;
                    const diastolic = container.querySelector('.bp-diastolic').value;
                    const position = container.querySelector('.bp-position').value;
                    const arm = container.querySelector('.bp-arm').value;
                    
                    if (systolic && diastolic) {
                        let category = '';
                        const sys = parseInt(systolic);
                        const dia = parseInt(diastolic);
                        
                        if (sys < 120 && dia < 80) category = 'Normal';
                        else if (sys < 130 && dia < 80) category = 'Elevated';
                        else if (sys < 140 && dia < 90) category = 'Stage 1 HTN';
                        else if (sys >= 140 || dia >= 90) category = 'Stage 2 HTN';
                        else if (sys < 90 || dia < 60) category = 'Hypotension';
                        
                        container.querySelector('.bp-result').textContent = `${systolic}/${diastolic} (${category}) - ${position}, ${arm}`;
                    }
                };
                
                container.querySelectorAll('input, select').forEach(el => {
                    el.addEventListener('input', updateResult);
                    el.addEventListener('change', updateResult);
                });
                
                return container;
            },
            
            createPeripheralPulseGroup(finding) {
                const container = document.createElement('div');
                container.className = 'pulse-grid';
                const pulses = ['Carotid', 'Radial', 'Brachial', 'Femoral', 'Popliteal', 'Posterior Tibial', 'Dorsalis Pedis'];
                
                container.innerHTML = `
                    <div class="font-semibold text-sm">Pulse</div>
                    <div class="font-semibold text-sm">Right</div>
                    <div class="font-semibold text-sm">Left</div>
                    ${pulses.map(pulse => `
                        <div class="text-sm">${pulse}</div>
                        <select class="finding-select pulse-right" data-pulse="${pulse}">
                            <option value="">--</option>
                            <option value="Normal">Normal</option>
                            <option value="Weak">Weak</option>
                            <option value="Absent">Absent</option>
                            <option value="Bounding">Bounding</option>
                        </select>
                        <select class="finding-select pulse-left" data-pulse="${pulse}">
                            <option value="">--</option>
                            <option value="Normal">Normal</option>
                            <option value="Weak">Weak</option>
                            <option value="Absent">Absent</option>
                            <option value="Bounding">Bounding</option>
                        </select>
                    `).join('')}
                `;
                
                return container;
            },
            
            createPalpationGroup(finding) {
                const container = document.createElement('div');
                container.innerHTML = `
                    <select class="finding-select general-palpation-finding">
                        <option value="">Select General Finding...</option>
                        <option>PMI non-displaced, normal character</option>
                        <option>PMI displaced (inferolaterally)</option>
                        <option>Sustained lift (LVH)</option>
                        <option>Parasternal heave (RVH)</option>
                        <option>Palpable P2 (pulmonary HTN)</option>
                    </select>
                    <div class="thrill-container mt-4">
                        <div class="finding-label-container">
                            <label class="finding-label text-sm">Thrills</label>
                            <button class="add-finding-btn thrill-add-btn">+</button>
                        </div>
                    </div>
                `;
                
                const thrillContainer = container.querySelector('.thrill-container');
                const addBtn = container.querySelector('.thrill-add-btn');
    
                const createThrillRow = () => {
                    const row = document.createElement('div');
                    row.className = 'finding-input-wrapper clone thrill-row grid grid-cols-2 gap-2 items-center';
                    row.innerHTML = `
                        <select class="finding-select thrill-location">
                            <option>Aortic Area</option>
                            <option>Pulmonic Area</option>
                            <option>Tricuspid Area</option>
                            <option>Mitral Area</option>
                        </select>
                        <div class="relative">
                            <input type="text" class="finding-input" placeholder="Notes...">
                            <button class="delete-clone-btn absolute right-[-25px] top-1/2 -translate-y-1/2">&times;</button>
                        </div>
                    `;
                    row.querySelector('.delete-clone-btn').onclick = () => row.remove();
                    return row;
                };
    
                addBtn.onclick = (e) => { 
                    e.preventDefault(); 
                    thrillContainer.appendChild(createThrillRow()); 
                };
    
                return container;
            },
            
            createMurmurGroup(finding, isClone) {
                const container = document.createElement('div');
                container.className = "grid grid-cols-2 md:grid-cols-5 gap-2";
                const createDropdown = (label, cls, options) => `<div><label class="finding-label text-xs">${label}</label><select class="finding-select ${cls}">${options.map(o=>`<option value="${o}">${o}</option>`).join('')}</select></div>`;
                
                container.innerHTML = 
                    createDropdown("Timing", "murmur-timing", ["Systolic ejection", "Pansystolic", "Late systolic", "Early diastolic", "Mid-diastolic", "Continuous"]) +
                    createDropdown("Grade", "murmur-grade", ["1/6", "2/6", "3/6", "4/6", "5/6", "6/6"]) +
                    createDropdown("Location", "murmur-location", ["Aortic", "Pulmonic", "Tricuspid", "Mitral", "Erb's Point"]) +
                    createDropdown("Radiation", "murmur-radiation", ["None", "Carotids", "Axilla", "Back"]) +
                    createDropdown("Quality", "murmur-quality", ["Harsh", "Blowing", "Rumbling", "Musical"]);
    
                if (isClone) {
                     const wrapper = document.createElement('div');
                     wrapper.className = 'finding-input-wrapper clone';
                     wrapper.appendChild(container);
                     const deleteBtn = document.createElement('button');
                     deleteBtn.innerHTML = '&times;';
                     deleteBtn.className = 'delete-clone-btn';
                     deleteBtn.onclick = (e) => { e.preventDefault(); wrapper.remove(); };
                     wrapper.appendChild(deleteBtn);
                     return wrapper;
                }
                return container;
            },
            
            createFraminghamScore(finding) {
                const container = document.createElement('div');
                container.className = 'score-container';
                const baseId = `frs_${finding.id}`;

                container.innerHTML = `
                    <div class="score-grid">
                         <div><label class="finding-label text-sm">Sex</label><select id="${baseId}_sex" class="finding-select frs-param"><option value="male">Male</option><option value="female">Female</option></select></div>
                         <div><label class="finding-label text-sm">Age</label><input type="number" id="${baseId}_age" class="finding-input frs-param"></div>
                         <div><label class="finding-label text-sm">Total Cholesterol (mg/dL)</label><input type="number" id="${baseId}_tc" class="finding-input frs-param"></div>
                         <div><label class="finding-label text-sm">HDL Cholesterol (mg/dL)</label><input type="number" id="${baseId}_hdl" class="finding-input frs-param"></div>
                         <div><label class="finding-label text-sm">Systolic BP (mmHg)</label><input type="number" id="${baseId}_sbp" class="finding-input frs-param"></div>
                    </div>
                    <div class="checkbox-group mt-4">
                        <div class="checkbox-item"><input type="checkbox" id="${baseId}_smoker" class="frs-param"><label class="ml-2">Smoker</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="${baseId}_bptx" class="frs-param"><label class="ml-2">On BP Treatment</label></div>
                    </div>
                    <button class="calculate-btn frs-calc">Calculate Framingham Score</button>
                    <div id="${baseId}_result" class="score-result" style="display:none;"></div>
                `;
                
                container.querySelector('.frs-calc').addEventListener('click', (e) => {
                    e.preventDefault();
                    // Simplified FRS calculation (full implementation would need complete tables)
                    const sex = container.querySelector(`#${baseId}_sex`).value;
                    const age = parseInt(container.querySelector(`#${baseId}_age`).value);
                    const tc = parseInt(container.querySelector(`#${baseId}_tc`).value);
                    const hdl = parseInt(container.querySelector(`#${baseId}_hdl`).value);
                    const sbp = parseInt(container.querySelector(`#${baseId}_sbp`).value);
                    const smoker = container.querySelector(`#${baseId}_smoker`).checked;
                    const onBPTx = container.querySelector(`#${baseId}_bptx`).checked;

                    if (isNaN(age) || isNaN(tc) || isNaN(hdl) || isNaN(sbp)) {
                         container.querySelector(`#${baseId}_result`).innerHTML = '<b>Error:</b> Please fill all fields.';
                         container.querySelector(`#${baseId}_result`).style.display = 'block';
                         return;
                    }

                    // Simplified calculation
                    let points = 0;
                    if (sex === 'male') {
                        if (age >= 60) points += 8;
                        if (smoker) points += 4;
                        if (tc >= 240) points += 3;
                        if (hdl < 40) points += 2;
                        if (sbp >= 160) points += 3;
                    } else {
                        if (age >= 60) points += 10;
                        if (smoker) points += 5;
                        if (tc >= 240) points += 2;
                        if (hdl < 40) points += 2;
                        if (sbp >= 160) points += 4;
                    }

                    const riskMap = { 0: '<1%', 1: '1%', 2: '2%', 3: '3%', 4: '4%', 5: '5%', 6: '6%', 7: '7%', 8: '8%', 9: '9%', 10: '10%' };
                    const risk = riskMap[points] || '>10%';

                    container.querySelector(`#${baseId}_result`).innerHTML = `<b>FRS Points: ${points}</b>. Estimated 10-year risk for CHD: <b>${risk}</b>`;
                    container.querySelector(`#${baseId}_result`).style.display = 'block';
                });

                return container;
            },
            
            createTimiScore(finding) {
                const container = document.createElement('div');
                const baseId = `timi_${finding.id}`;
                container.innerHTML = `
                    <div class="score-container">
                         <h4>TIMI Risk Score for UA/NSTEMI</h4>
                         <div class="checkbox-group">
                            <div class="checkbox-item"><input type="checkbox" class="timi-param" value="1"><label class="ml-2">Age  65</label></div>
                            <div class="checkbox-item"><input type="checkbox" class="timi-param" value="1"><label class="ml-2"> 3 CAD risk factors</label></div>
                            <div class="checkbox-item"><input type="checkbox" class="timi-param" value="1"><label class="ml-2">Known CAD (Stenosis  50%)</label></div>
                            <div class="checkbox-item"><input type="checkbox" class="timi-param" value="1"><label class="ml-2">Aspirin use in past 7 days</label></div>
                            <div class="checkbox-item"><input type="checkbox" class="timi-param" value="1"><label class="ml-2">Severe angina (2 events in 24h)</label></div>
                            <div class="checkbox-item"><input type="checkbox" class="timi-param" value="1"><label class="ml-2">ST deviation 0.5mm</label></div>
                            <div class="checkbox-item"><input type="checkbox" class="timi-param" value="1"><label class="ml-2">Elevated cardiac marker</label></div>
                         </div>
                        <button class="calculate-btn timi-calc">Calculate TIMI Score</button>
                        <div id="${baseId}_result" class="score-result mt-4" style="display:none;"></div>
                    </div>`;

                container.querySelector('.timi-calc').addEventListener('click', (e) => {
                    e.preventDefault();
                    let score = 0;
                    container.querySelectorAll('.timi-param:checked').forEach(p => score += parseInt(p.value));

                    const riskMap = {0: '4.7%', 1: '8.3%', 2: '13.2%', 3: '19.9%', 4: '26.2%', 5: '40.9%', 6: '40.9%', 7: '40.9%'};
                    let interp = `At 14 days, the approximate risk for all-cause mortality, new/recurrent MI, or severe recurrent ischemia is <b>${riskMap[score]}</b>.`;

                    const resultEl = container.querySelector(`#${baseId}_result`);
                    resultEl.innerHTML = `<b>TIMI Score: ${score}/7</b>. ${interp}`;
                    resultEl.style.display = 'block';
                });
                return container;
            },
            
            createCalciumScore(finding) {
                const container = document.createElement('div');
                container.className = 'score-container';
                container.innerHTML = `<p class="text-sm mb-2">Interpret a patient's Agatston score to assess plaque burden.</p>
                                       <button type="button" class="calculate-btn" onclick="openCACModal()">Open CAC Score Interpreter</button>`;
                return container;
            },
    
            createSyntaxScore(finding) {
                const container = document.createElement('div');
                container.className = 'score-container';
                container.innerHTML = `<p class="text-sm mb-2">Calculate 4-year mortality for PCI vs. CABG based on clinical and anatomical factors.</p>
                                       <button type="button" class="calculate-btn" onclick="openSyntax2Modal()">Open SYNTAX II Calculator</button>`;
                return container;
            },
            
            createGCSScore(finding) {
                const container = document.createElement('div');
                container.className = 'score-container';
                const baseId = `gcs_${finding.id}`;
                
                container.innerHTML = `
                    <h4>Glasgow Coma Scale (GCS)</h4>
                    <div class="score-grid">
                        <div>
                            <label class="finding-label text-sm">Eye Opening (E)</label>
                            <select id="${baseId}_eye" class="finding-select gcs-param">
                                <option value="">Select...</option>
                                <option value="4">4 - Spontaneous</option>
                                <option value="3">3 - To Voice</option>
                                <option value="2">2 - To Pain</option>
                                <option value="1">1 - None</option>
                            </select>
                        </div>
                        <div>
                            <label class="finding-label text-sm">Verbal Response (V)</label>
                            <select id="${baseId}_verbal" class="finding-select gcs-param">
                                <option value="">Select...</option>
                                <option value="5">5 - Oriented</option>
                                <option value="4">4 - Confused</option>
                                <option value="3">3 - Inappropriate Words</option>
                                <option value="2">2 - Incomprehensible Sounds</option>
                                <option value="1">1 - None</option>
                            </select>
                        </div>
                        <div>
                            <label class="finding-label text-sm">Motor Response (M)</label>
                            <select id="${baseId}_motor" class="finding-select gcs-param">
                                <option value="">Select...</option>
                                <option value="6">6 - Obeys Commands</option>
                                <option value="5">5 - Localizes Pain</option>
                                <option value="4">4 - Withdraws from Pain</option>
                                <option value="3">3 - Flexion to Pain</option>
                                <option value="2">2 - Extension to Pain</option>
                                <option value="1">1 - None</option>
                            </select>
                        </div>
                    </div>
                    <button class="calculate-btn gcs-calc">Calculate GCS</button>
                    <div id="${baseId}_result" class="score-result" style="display:none;"></div>
                `;
                
                container.querySelector('.gcs-calc').addEventListener('click', (e) => {
                    e.preventDefault();
                    const eye = parseInt(container.querySelector(`#${baseId}_eye`).value) || 0;
                    const verbal = parseInt(container.querySelector(`#${baseId}_verbal`).value) || 0;
                    const motor = parseInt(container.querySelector(`#${baseId}_motor`).value) || 0;
                    
                    const total = eye + verbal + motor;
                    let severity = '';
                    if (total >= 13) severity = 'Mild (13-15)';
                    else if (total >= 9) severity = 'Moderate (9-12)';
                    else severity = 'Severe (3-8)';
                    
                    const resultEl = container.querySelector(`#${baseId}_result`);
                    resultEl.innerHTML = `<b>GCS Total: ${total}/15 (E${eye}V${verbal}M${motor})</b><br>Severity: <b>${severity}</b>`;
                    resultEl.style.display = 'block';
                });
                
                return container;
            },
            
            createNIHSSScore(finding) {
                const container = document.createElement('div');
                container.className = 'score-container';
                container.innerHTML = `<p class="text-sm mb-2">NIH Stroke Scale - Comprehensive stroke severity assessment tool.</p>
                                       <button type="button" class="calculate-btn" onclick="openNIHSSModal()">Open NIHSS Calculator</button>`;
                return container;
            },
            
            createCURB65Score(finding) {
                const container = document.createElement('div');
                container.className = 'score-container';
                const baseId = `curb65_${finding.id}`;
                
                container.innerHTML = `
                    <h4>CURB-65 Score for Pneumonia Severity</h4>
                    <div class="checkbox-group">
                        <div class="checkbox-item"><input type="checkbox" class="curb65-param" value="1"><label class="ml-2">Confusion</label></div>
                        <div class="checkbox-item"><input type="checkbox" class="curb65-param" value="1"><label class="ml-2">Urea > 7 mmol/L</label></div>
                        <div class="checkbox-item"><input type="checkbox" class="curb65-param" value="1"><label class="ml-2">Respiratory Rate  30/min</label></div>
                        <div class="checkbox-item"><input type="checkbox" class="curb65-param" value="1"><label class="ml-2">Blood Pressure < 90/60 mmHg</label></div>
                        <div class="checkbox-item"><input type="checkbox" class="curb65-param" value="1"><label class="ml-2">Age  65 years</label></div>
                    </div>
                    <button class="calculate-btn curb65-calc">Calculate CURB-65</button>
                    <div id="${baseId}_result" class="score-result" style="display:none;"></div>
                `;
                
                container.querySelector('.curb65-calc').addEventListener('click', (e) => {
                    e.preventDefault();
                    let score = 0;
                    container.querySelectorAll('.curb65-param:checked').forEach(p => score += parseInt(p.value));
                    
                    let risk = '';
                    if (score === 0) risk = '0.6% - Low risk, consider outpatient treatment';
                    else if (score === 1) risk = '2.7% - Low risk, consider outpatient treatment';
                    else if (score === 2) risk = '6.8% - Low risk, consider outpatient treatment';
                    else if (score === 3) risk = '14.0% - Moderate risk, consider hospital admission';
                    else if (score === 4) risk = '27.8% - High risk, hospital admission recommended';
                    else risk = '27.8% - High risk, hospital admission recommended';
                    
                    const resultEl = container.querySelector(`#${baseId}_result`);
                    resultEl.innerHTML = `<b>CURB-65 Score: ${score}/5</b><br>30-day mortality risk: <b>${risk}</b>`;
                    resultEl.style.display = 'block';
                });
                
                return container;
            },
            
            createWellsPEScore(finding) {
                const container = document.createElement('div');
                container.className = 'score-container';
                const baseId = `wells_pe_${finding.id}`;
                
                container.innerHTML = `
                    <h4>Wells Score for Pulmonary Embolism</h4>
                    <div class="checkbox-group">
                        <div class="checkbox-item"><input type="checkbox" class="wells-param" value="1.5"><label class="ml-2">Clinical signs of DVT</label></div>
                        <div class="checkbox-item"><input type="checkbox" class="wells-param" value="3"><label class="ml-2">PE is #1 diagnosis</label></div>
                        <div class="checkbox-item"><input type="checkbox" class="wells-param" value="1.5"><label class="ml-2">Heart rate > 100</label></div>
                        <div class="checkbox-item"><input type="checkbox" class="wells-param" value="1.5"><label class="ml-2">Immobilization/Surgery in 6 weeks</label></div>
                        <div class="checkbox-item"><input type="checkbox" class="wells-param" value="1.5"><label class="ml-2">Previous DVT/PE</label></div>
                        <div class="checkbox-item"><input type="checkbox" class="wells-param" value="1"><label class="ml-2">Hemoptysis</label></div>
                        <div class="checkbox-item"><input type="checkbox" class="wells-param" value="3"><label class="ml-2">Malignancy</label></div>
                    </div>
                    <button class="calculate-btn wells-calc">Calculate Wells Score</button>
                    <div id="${baseId}_result" class="score-result" style="display:none;"></div>
                `;
                
                container.querySelector('.wells-calc').addEventListener('click', (e) => {
                    e.preventDefault();
                    let score = 0;
                    container.querySelectorAll('.wells-param:checked').forEach(p => score += parseFloat(p.value));
                    
                    let probability = '';
                    if (score < 2) probability = 'Low probability (1.3% PE prevalence)';
                    else if (score < 6) probability = 'Moderate probability (16.2% PE prevalence)';
                    else probability = 'High probability (37.5% PE prevalence)';
                    
                    const resultEl = container.querySelector(`#${baseId}_result`);
                    resultEl.innerHTML = `<b>Wells Score: ${score}</b><br>Probability: <b>${probability}</b>`;
                    resultEl.style.display = 'block';
                });
                
                return container;
            },
            
            createRockallScore(finding) {
                const container = document.createElement('div');
                container.className = 'score-container';
                container.innerHTML = `<p class="text-sm mb-2">Rockall Score for Upper GI Bleeding - Risk stratification tool.</p>
                                       <button type="button" class="calculate-btn" onclick="openRockallModal()">Open Rockall Calculator</button>`;
                return container;
            },
            
            createWOMACScore(finding) {
                const container = document.createElement('div');
                container.className = 'score-container';
                container.innerHTML = `<p class="text-sm mb-2">WOMAC Osteoarthritis Index - Joint pain and function assessment.</p>
                                       <button type="button" class="calculate-btn" onclick="openWOMACModal()">Open WOMAC Calculator</button>`;
                return container;
            },
            
            createSubGroup(finding) {
                const container = document.createElement('div');
                container.className = 'sub-finding-group';
                
                if (finding.sub_findings) {
                    finding.sub_findings.forEach(subFinding => {
                        const subDiv = document.createElement('div');
                        subDiv.className = 'mb-3';
                        subDiv.innerHTML = `<label class="label-text text-sm">${subFinding.label}</label>`;
                        
                        if (subFinding.type === 'checkbox_group') {
                            const checkboxDiv = this.createCheckboxGroup(subFinding);
                            subDiv.appendChild(checkboxDiv);
                        } else if (subFinding.type === 'custom_select') {
                            const select = document.createElement('select');
                            select.className = 'input-field';
                            select.innerHTML = `<option value="">-- Select --</option>` + subFinding.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                            subDiv.appendChild(select);
                        }
                        
                        container.appendChild(subDiv);
                    });
                }
                
                return container;
            },
            
            createSidedInput(finding) {
                const container = document.createElement('div');
                container.className = 'sided-grid';
                container.innerHTML = `
                    <div>
                        <label class="label-text text-sm">Right</label>
                        <select class="finding-select sided-right">
                            <option value="">-- Select --</option>
                            ${finding.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="label-text text-sm">Left</label>
                        <select class="finding-select sided-left">
                            <option value="">-- Select --</option>
                            ${finding.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                    </div>
                `;
                
                return container;
            },
            
            createPowerChart(finding) {
                const container = document.createElement('div');
                container.className = 'score-container';
                
                const muscleGroups = finding.muscle_groups || [];
                let chartHTML = '<h4>Muscle Power Assessment (MRC Scale)</h4><div class="score-grid">';
                
                muscleGroups.forEach(muscle => {
                    chartHTML += `
                        <div class="lymph-item">
                            <span class="text-sm">${muscle.name}</span>
                            <select class="finding-select power-right" data-muscle="${muscle.muscle}">
                                <option value="">--</option>
                                <option value="5/5">5/5</option>
                                <option value="4/5">4/5</option>
                                <option value="3/5">3/5</option>
                                <option value="2/5">2/5</option>
                                <option value="1/5">1/5</option>
                                <option value="0/5">0/5</option>
                            </select>
                            <select class="finding-select power-left" data-muscle="${muscle.muscle}">
                                <option value="">--</option>
                                <option value="5/5">5/5</option>
                                <option value="4/5">4/5</option>
                                <option value="3/5">3/5</option>
                                <option value="2/5">2/5</option>
                                <option value="1/5">1/5</option>
                                <option value="0/5">0/5</option>
                            </select>
                        </div>
                    `;
                });
                
                chartHTML += '</div>';
                container.innerHTML = chartHTML;
                
                return container;
            },
            
            createReflexChart(finding) {
                const container = document.createElement('div');
                container.className = 'score-container';
                
                const reflexes = finding.reflexes || [];
                let chartHTML = '<h4>Deep Tendon Reflexes</h4><div class="score-grid">';
                
                reflexes.forEach(reflex => {
                    chartHTML += `
                        <div class="lymph-item">
                            <span class="text-sm">${reflex.name}</span>
                            <select class="finding-select reflex-right" data-reflex="${reflex.name}">
                                <option value="">--</option>
                                <option value="0">0</option>
                                <option value="1+">1+</option>
                                <option value="2+">2+</option>
                                <option value="3+">3+</option>
                                <option value="4+">4+</option>
                            </select>
                            <select class="finding-select reflex-left" data-reflex="${reflex.name}">
                                <option value="">--</option>
                                <option value="0">0</option>
                                <option value="1+">1+</option>
                                <option value="2+">2+</option>
                                <option value="3+">3+</option>
                                <option value="4+">4+</option>
                            </select>
                        </div>
                    `;
                });
                
                chartHTML += '</div>';
                container.innerHTML = chartHTML;
                
                return container;
            },
            
            createSensoryChart(finding) {
                const container = document.createElement('div');
                container.className = 'score-container';
                
                const dermatomes = finding.dermatomes || [];
                let chartHTML = '<h4>Sensory Assessment</h4><div class="score-grid">';
                
                dermatomes.forEach(dermatome => {
                    chartHTML += `
                        <div class="lymph-item">
                            <span class="text-sm">${dermatome}</span>
                            <select class="finding-select sensory-right" data-dermatome="${dermatome}">
                                <option value="">--</option>
                                <option value="Normal">Normal</option>
                                <option value="Decreased">Decreased</option>
                                <option value="Absent">Absent</option>
                            </select>
                            <select class="finding-select sensory-left" data-dermatome="${dermatome}">
                                <option value="">--</option>
                                <option value="Normal">Normal</option>
                                <option value="Decreased">Decreased</option>
                                <option value="Absent">Absent</option>
                            </select>
                        </div>
                    `;
                });
                
                chartHTML += '</div>';
                container.innerHTML = chartHTML;
                
                return container;
            },
            
            createCheckboxGroup(finding) {
                const container = document.createElement('div');
                container.className = 'checkbox-group';
                
                const options = finding.options || [];
                options.forEach(option => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'checkbox-item';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" value="${option}" data-field="${finding.id}">
                        <label class="ml-2">${option}</label>
                    `;
                    container.appendChild(checkboxDiv);
                });
                
                return container;
            },
            
            createSidedClonable(finding) {
                const container = document.createElement('div');
                container.className = 'sided-grid';
                container.innerHTML = `
                    <div>
                        <label class="label-text text-sm">Right</label>
                        <select class="finding-select sided-clonable-right">
                            <option value="">-- Select --</option>
                            ${finding.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                        ${finding.sub_options ? `
                            <select class="finding-select sided-clonable-right-sub mt-1">
                                <option value="">-- Select --</option>
                                ${finding.sub_options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        ` : ''}
                    </div>
                    <div>
                        <label class="label-text text-sm">Left</label>
                        <select class="finding-select sided-clonable-left">
                            <option value="">-- Select --</option>
                            ${finding.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                        ${finding.sub_options ? `
                            <select class="finding-select sided-clonable-left-sub mt-1">
                                <option value="">-- Select --</option>
                                ${finding.sub_options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        ` : ''}
                    </div>
                `;
                
                return container;
            },
            renderSection(type, title, predefinedItems) {
                const container = document.getElementById(`${type}-section`);
                if (!container) return;
                
                if (type === 'investigations') {
                    this.renderInvestigationSection();
                    return;
                }
                
                // Load custom options from localStorage
                let customOptions = [];
                try {
                    customOptions = JSON.parse(localStorage.getItem(`customOptions_${type}`)) || [];
                } catch (e) { 
                    customOptions = []; 
                }
                
                // Merge and deduplicate
                const allOptions = Array.from(new Set([...predefinedItems, ...customOptions]));
                
                let itemsHtml = app.state.consultationData[type].map((item, index) => 
                    `<div class="flex items-center gap-2 bg-slate-100 p-2 rounded-md">
                        <span class="flex-grow">${item}</span>
                        <button data-type="${type}" data-index="${index}" class="remove-item-btn text-red-500 hover:text-red-700">&times;</button>
                    </div>`
                ).join('');
                
                container.innerHTML = `
                    <h3 class="section-title">${title}</h3>
                    <div id="${type}-items" class="space-y-2 mb-4">${itemsHtml}</div>
                    
                    <!-- Predefined options -->
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="${type}-input" list="${type}-datalist" class="input-field flex-1" placeholder="Type or select from predefined options...">
                        <datalist id="${type}-datalist">${allOptions.map(item => `<option value="${item}"></option>`).join('')}</datalist>
                        <button data-type="${type}" class="add-item-btn px-4 py-2 bg-blue-200 text-blue-800 rounded-md hover:bg-blue-300">Add</button>
                    </div>
                    
                    <!-- Custom input for new options -->
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="${type}-custom-input" class="input-field flex-1" placeholder="Add new custom option...">
                        <button data-type="${type}" class="add-custom-item-btn px-4 py-2 bg-green-200 text-green-800 rounded-md hover:bg-green-300">Add New</button>
                    </div>
                    
                    <!-- Test utilities -->
                    <div class="flex gap-2 mt-2">
                        <button data-type="${type}" class="show-custom-options-btn px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-sm">Show Custom</button>
                        <button data-type="${type}" class="clear-custom-options-btn px-2 py-1 bg-red-100 text-red-800 rounded text-sm">Clear Custom</button>
                    </div>
                    <div id="${type}-custom-list" class="text-xs text-slate-500 mt-1"></div>
                `;
                
                // Add item from predefined list
                container.querySelector('.add-item-btn').onclick = (e) => { 
                    const type = e.target.dataset.type; 
                    const input = document.getElementById(`${type}-input`); 
                    if (input.value.trim()) { 
                        app.state.consultationData[type].push(input.value.trim()); 
                        input.value = ''; 
                        this.renderConsultationSections(); 
                    } 
                };
                
                // Add custom item and save to localStorage
                container.querySelector('.add-custom-item-btn').onclick = (e) => { 
                    const type = e.target.dataset.type; 
                    const input = document.getElementById(`${type}-custom-input`); 
                    if (input.value.trim()) { 
                        const customValue = input.value.trim();
                        app.state.consultationData[type].push(customValue); 
                        
                        // Save to localStorage for future use
                        let customOptions = [];
                        try { 
                            customOptions = JSON.parse(localStorage.getItem(`customOptions_${type}`)) || []; 
                        } catch (e) { 
                            customOptions = []; 
                        }
                        
                        if (!customOptions.includes(customValue)) {
                            customOptions.push(customValue);
                            localStorage.setItem(`customOptions_${type}`, JSON.stringify(customOptions));
                        }
                        
                        input.value = ''; 
                        this.renderConsultationSections(); 
                    } 
                };
                
                // Remove item buttons
                container.querySelectorAll('.remove-item-btn').forEach(btn => { 
                    btn.onclick = (e) => { 
                        const { type, index } = e.target.dataset; 
                        app.state.consultationData[type].splice(index, 1); 
                        this.renderConsultationSections(); 
                    }; 
                });
                
                // Test utility: Show custom options
                container.querySelector('.show-custom-options-btn').onclick = (e) => {
                    const type = e.target.dataset.type;
                    let customOptions = [];
                    try { 
                        customOptions = JSON.parse(localStorage.getItem(`customOptions_${type}`)) || []; 
                    } catch (e) { 
                        customOptions = []; 
                    }
                    document.getElementById(`${type}-custom-list`).textContent = 'Custom options: ' + (customOptions.length ? customOptions.join(', ') : 'None');
                };
                
                // Test utility: Clear custom options
                container.querySelector('.clear-custom-options-btn').onclick = (e) => {
                    const type = e.target.dataset.type;
                    localStorage.removeItem(`customOptions_${type}`);
                    document.getElementById(`${type}-custom-list`).textContent = 'Custom options: None';
                    this.renderConsultationSections();
                };
            },
            
            renderInvestigationSection() {
                const container = document.getElementById('investigations-section');
                if (!container) return;
                
                // Get all investigation names for search
                const allInvestigations = [];
                const allInvs = app.utils.getAllInvestigations();
                Object.entries(allInvs).forEach(([category, tests]) => {
                    Object.keys(tests).forEach(testName => {
                        allInvestigations.push({ name: testName, category: category });
                    });
                });
                
                // Render selected investigations
                let selectedItemsHtml = '';
                if (app.state.consultationData.investigations && app.state.consultationData.investigations.length > 0) {
                    selectedItemsHtml = app.state.consultationData.investigations.map((inv, index) => {
                        const details = inv.details ? ` - ${inv.details}` : '';
                        const timing = inv.timing ? ` (${inv.timing})` : '';
                        return `<div class="flex items-center gap-2 bg-slate-100 p-3 rounded-md">
                            <div class="flex-grow">
                                <div class="font-semibold">${inv.name}</div>
                                <div class="text-sm text-slate-600">${inv.category}${details}${timing}</div>
                            </div>
                            <button data-index="${index}" class="remove-investigation-btn text-red-500 hover:text-red-700">&times;</button>
                        </div>`;
                    }).join('');
                }
                
                container.innerHTML = `
                    <h3 class="section-title">Investigations Advised</h3>
                    
                    <!-- Search and Add Section -->
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="investigation-search" class="flex-grow input-field" placeholder="Search investigations...">
                            <button id="clear-search" class="px-3 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300">Clear</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="label-text">Category</label>
                                <select id="category-filter" class="input-field">
                                    <option value="">All Categories</option>
                                    ${Object.keys(allInvs).map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="label-text">Timing</label>
                                <select id="timing-filter" class="input-field">
                                    <option value="">All Timing</option>
                                    <option value="Immediate">Immediate</option>
                                    <option value="Scheduled">Scheduled</option>
                                    <option value="Fasting">Fasting</option>
                                    <option value="Non-fasting">Non-fasting</option>
                                    <option value="Overnight">Overnight</option>
                                </select>
                            </div>
                            <div>
                                <label class="label-text">Quick Add Common Tests</label>
                                <select id="quick-add" class="input-field">
                                    <option value="">Select common test...</option>
                                    <option value="CBC">Complete Blood Count (CBC)</option>
                                    <option value="CMP">Comprehensive Metabolic Panel (CMP)</option>
                                    <option value="Lipid">Lipid Profile</option>
                                    <option value="TSH">Thyroid Function Tests</option>
                                    <option value="ECG">Electrocardiogram (ECG)</option>
                                    <option value="CXR">Chest X-ray</option>
                                    <option value="HbA1c">HbA1c</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="search-results" class="max-h-60 overflow-y-auto border rounded-lg bg-white"></div>
                    </div>
                    
                                        <!-- Custom Investigation Addition -->
                    <div class="mb-6 p-4 bg-green-50 rounded-lg">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold">Add Custom Investigation</h4>
                            <div class="flex gap-2">
                                <button id="export-investigations" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600">Export List</button>
                                <button id="import-investigations" class="px-3 py-1 bg-purple-500 text-white text-sm rounded-md hover:bg-purple-600">Import List</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                            <input type="text" id="custom-inv-name" class="input-field" placeholder="Investigation name">
                            <select id="custom-inv-category" class="input-field">
                                <option value="">Select category...</option>
                                ${Object.keys(allInvs).map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                <option value="Custom">Custom</option>
                            </select>
                            <select id="custom-inv-timing" class="input-field">
                                <option value="">Select timing...</option>
                                <option value="Immediate">Immediate</option>
                                <option value="Scheduled">Scheduled</option>
                                <option value="Fasting">Fasting</option>
                                <option value="Non-fasting">Non-fasting</option>
                                <option value="Overnight">Overnight</option>
                                <option value="24-hour">24-hour collection</option>
                            </select>
                            <button id="add-custom-inv" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Add Custom</button>
                        </div>
                        <input type="text" id="custom-inv-details" class="input-field mt-2" placeholder="Additional details/instructions">
                    </div>
                    
                    <!-- Selected Investigations -->
                    <div id="selected-investigations" class="space-y-2">
                        ${selectedItemsHtml || '<p class="text-slate-400 text-center py-4">No investigations selected yet.</p>'}
                    </div>
                `;
                
                this.attachInvestigationListeners();
                this.performInvestigationSearch();
            },
            
            attachInvestigationListeners() {
                // Search functionality
                const searchInput = document.getElementById('investigation-search');
                const categoryFilter = document.getElementById('category-filter');
                const timingFilter = document.getElementById('timing-filter');
                const clearSearch = document.getElementById('clear-search');
                
                searchInput.addEventListener('input', () => this.performInvestigationSearch());
                categoryFilter.addEventListener('change', () => this.performInvestigationSearch());
                timingFilter.addEventListener('change', () => this.performInvestigationSearch());
                clearSearch.addEventListener('click', () => {
                    searchInput.value = '';
                    categoryFilter.value = '';
                    timingFilter.value = '';
                    this.performInvestigationSearch();
                });
                
                // Quick add functionality
                const quickAdd = document.getElementById('quick-add');
                quickAdd.addEventListener('change', (e) => {
                    if (e.target.value) {
                        this.addInvestigationByName(e.target.value);
                        e.target.value = '';
                    }
                });
                
                // Custom investigation addition
                const addCustomBtn = document.getElementById('add-custom-inv');
                addCustomBtn.addEventListener('click', () => {
                    const name = document.getElementById('custom-inv-name').value.trim();
                    const category = document.getElementById('custom-inv-category').value;
                    const timing = document.getElementById('custom-inv-timing').value;
                    const details = document.getElementById('custom-inv-details').value.trim();
                    
                    if (name) {
                        const customInv = {
                            name: name,
                            category: category || 'Custom',
                            timing: timing,
                            details: details,
                            isCustom: true
                        };
                        
                        if (!app.state.consultationData.investigations) {
                            app.state.consultationData.investigations = [];
                        }
                        app.state.consultationData.investigations.push(customInv);
                        
                        // Save custom investigation to localStorage
                        app.utils.saveCustomInvestigation(customInv);
                        
                        // Clear form
                        document.getElementById('custom-inv-name').value = '';
                        document.getElementById('custom-inv-category').value = '';
                        document.getElementById('custom-inv-timing').value = '';
                        document.getElementById('custom-inv-details').value = '';
                        
                        this.renderConsultationSections();
                    }
                });
                
                // Remove investigation buttons
                document.querySelectorAll('.remove-investigation-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        app.state.consultationData.investigations.splice(index, 1);
                        this.renderConsultationSections();
                    });
                });
                
                // Export/Import functionality
                const exportBtn = document.getElementById('export-investigations');
                const importBtn = document.getElementById('import-investigations');
                
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        const investigations = app.state.consultationData.investigations || [];
                        if (investigations.length === 0) {
                            alert('No investigations to export.');
                            return;
                        }
                        
                        const dataStr = JSON.stringify(investigations, null, 2);
                        const dataBlob = new Blob([dataStr], {type: 'application/json'});
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `investigations_${new Date().toISOString().split('T')[0]}.json`;
                        link.click();
                        URL.revokeObjectURL(url);
                    });
                }
                
                if (importBtn) {
                    importBtn.addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.json';
                        input.onchange = (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    try {
                                        const importedInvestigations = JSON.parse(e.target.result);
                                        if (Array.isArray(importedInvestigations)) {
                                            if (!app.state.consultationData.investigations) {
                                                app.state.consultationData.investigations = [];
                                            }
                                            app.state.consultationData.investigations.push(...importedInvestigations);
                                            this.renderConsultationSections();
                                            alert(`Successfully imported ${importedInvestigations.length} investigations.`);
                                        } else {
                                            alert('Invalid file format. Please select a valid JSON file.');
                                        }
                                    } catch (error) {
                                        alert('Error reading file. Please check the file format.');
                                    }
                                };
                                reader.readAsText(file);
                            }
                        };
                        input.click();
                    });
                }
            },
            
            performInvestigationSearch() {
                const searchTerm = document.getElementById('investigation-search').value.toLowerCase();
                const categoryFilter = document.getElementById('category-filter').value;
                const timingFilter = document.getElementById('timing-filter').value;
                const resultsContainer = document.getElementById('search-results');
                
                let filteredResults = [];
                
                const allInvs = app.utils.getAllInvestigations();
                Object.entries(allInvs).forEach(([category, tests]) => {
                    if (categoryFilter && category !== categoryFilter) return;
                    
                    Object.entries(tests).forEach(([testName, testData]) => {
                        if (searchTerm && !testName.toLowerCase().includes(searchTerm)) return;
                        if (timingFilter && !testData.timing.includes(timingFilter)) return;
                        
                        filteredResults.push({
                            name: testName,
                            category: category,
                            data: testData
                        });
                    });
                });
                
                // Sort results
                filteredResults.sort((a, b) => a.name.localeCompare(b.name));
                
                // Limit results to prevent overwhelming
                filteredResults = filteredResults.slice(0, 50);
                
                if (filteredResults.length === 0) {
                    resultsContainer.innerHTML = '<p class="p-4 text-slate-500 text-center">No investigations found matching your criteria.</p>';
                    return;
                }
                
                const resultsHtml = filteredResults.map(result => {
                    const timingText = result.data.timing.join(', ');
                    const componentsText = result.data.components.slice(0, 3).join(', ') + (result.data.components.length > 3 ? '...' : '');
                    
                    return `
                        <div class="p-3 border-b hover:bg-slate-50 cursor-pointer investigation-result" 
                             data-name="${result.name}" 
                             data-category="${result.category}"
                             data-timing="${timingText}"
                             data-components="${result.data.components.join(', ')}"
                             data-instructions="${result.data.special_instructions || ''}">
                            <div class="font-semibold text-blue-700">${result.name}</div>
                            <div class="text-sm text-slate-600">${result.category}</div>
                            <div class="text-xs text-slate-500">Timing: ${timingText}</div>
                            <div class="text-xs text-slate-500">Components: ${componentsText}</div>
                            <div class="text-xs text-green-600 mt-1">Click to add  Double-click for details</div>
                        </div>
                    `;
                }).join('');
                
                resultsContainer.innerHTML = resultsHtml;
                
                // Add click listeners to results
                document.querySelectorAll('.investigation-result').forEach(result => {
                    result.addEventListener('click', () => {
                        const name = result.dataset.name;
                        const category = result.dataset.category;
                        this.addInvestigationByName(name, category);
                    });
                    
                    result.addEventListener('dblclick', () => {
                        this.showInvestigationDetails(result.dataset);
                    });
                });
            },
            
            addInvestigationByName(name, category = null) {
                if (!app.state.consultationData.investigations) {
                    app.state.consultationData.investigations = [];
                }
                
                // Map quick add short names to full names
                const quickAddMap = {
                    'CBC': 'Complete Blood Count (CBC)',
                    'CMP': 'Comprehensive Metabolic Panel (CMP)',
                    'Lipid': 'Lipid Profile',
                    'TSH': 'Thyroid Function Tests',
                    'ECG': 'Electrocardiogram (ECG/EKG)',
                    'CXR': 'Chest X-ray',
                    'HbA1c': 'HbA1c'
                };
                
                const fullName = quickAddMap[name] || name;
                
                // Check if already added
                if (app.state.consultationData.investigations.some(inv => inv.name === fullName)) {
                    return;
                }
                
                let investigationData = null;
                
                // Find the investigation in our database
                const allInvs = app.utils.getAllInvestigations();
                if (category) {
                    investigationData = allInvs[category]?.[fullName];
                } else {
                    // Search across all categories
                    for (const [cat, tests] of Object.entries(allInvs)) {
                        if (tests[fullName]) {
                            investigationData = tests[fullName];
                            category = cat;
                            break;
                        }
                    }
                }
                
                const investigation = {
                    name: fullName,
                    category: category || 'Unknown',
                    timing: investigationData?.timing?.[0] || 'Scheduled',
                    details: investigationData?.special_instructions || '',
                    components: investigationData?.components || [],
                    isCustom: false
                };
                
                app.state.consultationData.investigations.push(investigation);
                this.renderConsultationSections();
            },
            
            showInvestigationDetails(data) {
                const modalContainer = document.getElementById('modal-container');
                const componentsList = data.components ? data.components.split(', ').map(comp => `<li>${comp}</li>`).join('') : '<li>No specific components listed</li>';
                
                modalContainer.innerHTML = `
                    <div class="fixed inset-0 bg-slate-900 bg-opacity-60 z-50 flex items-center justify-center modal-overlay">
                        <div class="bg-white rounded-xl p-6 w-full max-w-2xl modal-content">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-blue-800">${data.name}</h2>
                                <button id="close-inv-details" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <h3 class="font-semibold text-slate-700">Category</h3>
                                    <p class="text-slate-600">${data.category}</p>
                                </div>
                                
                                <div>
                                    <h3 class="font-semibold text-slate-700">Timing</h3>
                                    <p class="text-slate-600">${data.timing}</p>
                                </div>
                                
                                <div>
                                    <h3 class="font-semibold text-slate-700">Components</h3>
                                    <ul class="list-disc list-inside text-slate-600">
                                        ${componentsList}
                                    </ul>
                                </div>
                                
                                ${data.instructions ? `
                                    <div>
                                        <h3 class="font-semibold text-slate-700">Special Instructions</h3>
                                        <p class="text-slate-600">${data.instructions}</p>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="mt-6 flex justify-end">
                                <button id="add-from-details" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Add to Investigations
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners
                modalContainer.querySelector('#close-inv-details').onclick = () => modalContainer.innerHTML = '';
                modalContainer.querySelector('#add-from-details').onclick = () => {
                    this.addInvestigationByName(data.name, data.category);
                    modalContainer.innerHTML = '';
                };
            },
            renderPrescriptionSection() {
                const container = document.getElementById('prescription-section');
                let itemsHtml = app.state.consultationData.prescriptions.map((rx, index) => `
                    <div class="bg-slate-100 p-3 rounded-md relative">
                        <div class="font-semibold">${rx.medicineName}${rx.strength ? ` ${rx.strength}` : ''}</div>
                        <div class="text-sm text-slate-600">${rx.dose} | ${rx.frequency} | ${rx.duration}</div>
                        <div class="text-xs italic text-slate-500 mt-1">Instruction: ${rx.instructions}</div>
                        <div class="absolute top-2 right-2 flex gap-1">
                            <button data-index="${index}" class="edit-rx-btn text-blue-500 hover:text-blue-700" title="Edit Medicine">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            <button data-index="${index}" class="remove-rx-btn text-red-500 hover:text-red-700" title="Remove Medicine">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = `
                    <h3 class="section-title">Prescription (Rx)</h3>
                    
                    <!-- Selected Prescriptions -->
                    <div id="prescription-items" class="space-y-2 mb-6">
                        ${itemsHtml || '<p class="text-slate-400 text-center py-4">No medicines added yet.</p>'}
                    </div>
                    
                    <!-- Medicine Search and Add Section -->
                    <div class="bg-slate-50 border p-6 rounded-lg space-y-4">
                        <h4 class="font-semibold text-lg">Add Medicine</h4>
                        
                        <!-- Search Controls -->
                        <div class="flex gap-3 items-center">
                            <div class="flex-grow relative">
                                <input type="text" id="medicine-search" class="w-full p-3 border rounded-md pr-10" placeholder="Search medicines...">
                                <div id="search-toggle" class="absolute right-2 top-1/2 transform -translate-y-1/2">
                                    <button id="toggle-search-type" class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                        Generic
                                    </button>
                                </div>
                            </div>
                            <button id="add-new-medicine-btn" class="px-4 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition">
                                <i class="fa-solid fa-plus mr-2"></i>Add New Medicine
                            </button>
                        </div>
                        
                        <!-- Search Results -->
                        <div id="medicine-search-results" class="max-h-60 overflow-y-auto border rounded-lg bg-white hidden"></div>
                        
                        <!-- Medicine Details Form -->
                        <div id="medicine-details-form" class="hidden space-y-4 p-4 bg-white border rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="label-text">Medicine Name</label>
                                    <input type="text" id="selected-medicine-name" class="input-field" readonly>
                                </div>
                                <div>
                                    <label class="label-text">Trade Name</label>
                                    <select id="medicine-trade-name" class="input-field">
                                        <option value="">Select Trade Name</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="label-text">Strength</label>
                                    <select id="medicine-strength" class="input-field">
                                        <option value="">Select Strength</option>
                                        <option value="250mg">250mg</option>
                                        <option value="500mg">500mg</option>
                                        <option value="750mg">750mg</option>
                                        <option value="1000mg">1000mg</option>
                                        <option value="125mg">125mg</option>
                                        <option value="250mg/5ml">250mg/5ml</option>
                                        <option value="500mg/5ml">500mg/5ml</option>
                                        <option value="10mg">10mg</option>
                                        <option value="20mg">20mg</option>
                                        <option value="40mg">40mg</option>
                                        <option value="80mg">80mg</option>
                                        <option value="5mg">5mg</option>
                                        <option value="10mg/ml">10mg/ml</option>
                                        <option value="20mg/ml">20mg/ml</option>
                                        <option value="1mg">1mg</option>
                                        <option value="2mg">2mg</option>
                                        <option value="5mg/ml">5mg/ml</option>
                                        <option value="50mg">50mg</option>
                                        <option value="100mg">100mg</option>
                                        <option value="200mg">200mg</option>
                                        <option value="400mg">400mg</option>
                                        <option value="600mg">600mg</option>
                                        <option value="800mg">800mg</option>
                                        <option value="1g">1g</option>
                                        <option value="2g">2g</option>
                                        <option value="5mg/5ml">5mg/5ml</option>
                                        <option value="10mg/5ml">10mg/5ml</option>
                                        <option value="15mg/5ml">15mg/5ml</option>
                                        <option value="25mg/5ml">25mg/5ml</option>
                                        <option value="30mg/5ml">30mg/5ml</option>
                                        <option value="50mg/5ml">50mg/5ml</option>
                                        <option value="100mg/5ml">100mg/5ml</option>
                                        <option value="200mg/5ml">200mg/5ml</option>
                                        <option value="400mg/5ml">400mg/5ml</option>
                                        <option value="1mg/ml">1mg/ml</option>
                                        <option value="2mg/ml">2mg/ml</option>
                                        <option value="5mg/ml">5mg/ml</option>
                                        <option value="10mg/ml">10mg/ml</option>
                                        <option value="20mg/ml">20mg/ml</option>
                                        <option value="50mg/ml">50mg/ml</option>
                                        <option value="100mg/ml">100mg/ml</option>
                                        <option value="200mg/ml">200mg/ml</option>
                                        <option value="500mg/ml">500mg/ml</option>
                                        <option value="1g/ml">1g/ml</option>
                                        <option value="2g/ml">2g/ml</option>
                                        <option value="5%">5%</option>
                                        <option value="10%">10%</option>
                                        <option value="15%">15%</option>
                                        <option value="20%">20%</option>
                                        <option value="25%">25%</option>
                                        <option value="30%">30%</option>
                                        <option value="40%">40%</option>
                                        <option value="50%">50%</option>
                                        <option value="custom">Custom Strength</option>
                                    </select>
                                </div>
                                <div id="custom-strength-container" class="hidden">
                                    <label class="label-text">Custom Strength</label>
                                    <input type="text" id="custom-strength-input" class="input-field" placeholder="Enter custom strength (e.g., 375mg, 25mg/5ml)">
                                </div>
                                <div>
                                    <label class="label-text">Pharmaceutical Company</label>
                                    <select id="medicine-company" class="input-field">
                                        <option value="">Select Company</option>
                                        <option value="Square Pharmaceuticals">Square Pharmaceuticals</option>
                                        <option value="Beximco Pharmaceuticals">Beximco Pharmaceuticals</option>
                                        <option value="Incepta Pharmaceuticals">Incepta Pharmaceuticals</option>
                                        <option value="ACI Limited">ACI Limited</option>
                                        <option value="Renata Limited">Renata Limited</option>
                                        <option value="Opsonin Pharma">Opsonin Pharma</option>
                                        <option value="Healthcare Pharmaceuticals">Healthcare Pharmaceuticals</option>
                                        <option value="Drug International">Drug International</option>
                                        <option value="Popular Pharmaceuticals">Popular Pharmaceuticals</option>
                                        <option value="Globe Pharmaceuticals">Globe Pharmaceuticals</option>
                                        <option value="Generic">Generic</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="label-text">Set as Default</label>
                                    <div class="flex gap-2 items-center mt-2">
                                        <input type="checkbox" id="set-default-company" class="rounded">
                                        <label for="set-default-company" class="text-sm text-slate-600">Set this company as default for this drug</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dosage Section -->
                            <div class="border-t pt-4">
                                <label class="label-text font-semibold">Dosage</label>
                                <div id="dosage-container" class="space-y-2">
                                    <!-- Default 3 dosage boxes will be populated here -->
                                </div>
                                <button type="button" id="add-dosage-btn" class="mt-2 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                                    <i class="fa-solid fa-plus mr-1"></i>Add Dosage
                                </button>
                            </div>

                            <!-- Route Section -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="label-text">Route</label>
                                    <select id="medicine-route" class="input-field">
                                        <option value="">Select Route</option>
                                        <option value="Oral">Oral</option>
                                        <option value="Intravenous (IV)">Intravenous (IV)</option>
                                        <option value="Intramuscular (IM)">Intramuscular (IM)</option>
                                        <option value="Subcutaneous (SC)">Subcutaneous (SC)</option>
                                        <option value="Intradermal">Intradermal</option>
                                        <option value="Sublingual">Sublingual</option>
                                        <option value="Buccal">Buccal</option>
                                        <option value="Rectal">Rectal</option>
                                        <option value="Vaginal">Vaginal</option>
                                        <option value="Nasal">Nasal</option>
                                        <option value="Ophthalmic">Ophthalmic</option>
                                        <option value="Otic">Otic</option>
                                        <option value="Topical">Topical</option>
                                        <option value="Inhalation">Inhalation</option>
                                        <option value="Transdermal">Transdermal</option>
                                        <option value="Intra-articular">Intra-articular</option>
                                        <option value="Intrathecal">Intrathecal</option>
                                        <option value="Epidural">Epidural</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="label-text">Set as Default Route</label>
                                    <div class="flex gap-2 items-center mt-2">
                                        <input type="checkbox" id="set-default-route" class="rounded">
                                        <label for="set-default-route" class="text-sm text-slate-600">Set this route as default for this drug</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Main Frequency Section (for overall prescription) -->
                            <div class="border-t pt-4">
                                <label class="label-text font-semibold">Overall Frequency (if all dosages same)</label>
                                <div class="flex gap-2 items-center">
                                    <select id="medicine-frequency" class="input-field flex-1">
                                        <option value="">Select Frequency</option>
                                        <option value="Once daily (OD)">Once daily (OD)</option>
                                        <option value="Twice daily (BD)">Twice daily (BD)</option>
                                        <option value="Thrice daily (TDS)">Thrice daily (TDS)</option>
                                        <option value="Four times daily (QID)">Four times daily (QID)</option>
                                        <option value="Every 6 hours">Every 6 hours</option>
                                        <option value="Every 8 hours">Every 8 hours</option>
                                        <option value="Every 12 hours">Every 12 hours</option>
                                        <option value="Every 4 hours">Every 4 hours</option>
                                        <option value="Every 2 hours">Every 2 hours</option>
                                        <option value="Every hour">Every hour</option>
                                        <option value="As needed (PRN)">As needed (PRN)</option>
                                        <option value="Before meals">Before meals</option>
                                        <option value="After meals">After meals</option>
                                        <option value="With meals">With meals</option>
                                        <option value="At bedtime">At bedtime</option>
                                        <option value="On empty stomach">On empty stomach</option>
                                        <option value="Every alternate day">Every alternate day</option>
                                        <option value="Weekly">Weekly</option>
                                        <option value="Monthly">Monthly</option>
                                        <option value="Every 3 months">Every 3 months</option>
                                        <option value="Every 6 months">Every 6 months</option>
                                        <option value="Yearly">Yearly</option>
                                    </select>
                                    <button type="button" id="add-frequency-btn" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600" title="Add Custom Frequency">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                                <div id="custom-frequency-container" class="hidden mt-2">
                                    <div class="flex gap-2">
                                        <input type="text" id="custom-frequency-input" class="input-field flex-1" placeholder="Enter custom frequency...">
                                        <button type="button" id="save-custom-frequency" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save</button>
                                        <button type="button" id="cancel-custom-frequency" class="px-3 py-2 bg-slate-300 text-slate-700 rounded hover:bg-slate-400">Cancel</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Main Duration Section (for overall prescription) -->
                            <div class="border-t pt-4">
                                <label class="label-text font-semibold">Overall Duration (if all dosages same)</label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="label-text text-sm">Number</label>
                                        <select id="duration-number" class="input-field">
                                            <option value="">Select</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="5">5</option>
                                            <option value="7">7</option>
                                            <option value="10">10</option>
                                            <option value="14">14</option>
                                            <option value="21">21</option>
                                            <option value="28">28</option>
                                            <option value="30">30</option>
                                            <option value="45">45</option>
                                            <option value="60">60</option>
                                            <option value="90">90</option>
                                            <option value="180">180</option>
                                            <option value="365">365</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="label-text text-sm">Unit</label>
                                        <select id="duration-unit" class="input-field">
                                            <option value="">Select</option>
                                            <option value="days">Days</option>
                                            <option value="weeks">Weeks</option>
                                            <option value="months">Months</option>
                                            <option value="years">Years</option>
                                            <option value="continue">Continue</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="label-text text-sm">Pattern</label>
                                        <select id="duration-pattern" class="input-field">
                                            <option value="">Select</option>
                                            <option value="Daily">Daily</option>
                                            <option value="Every alternate day">Every alternate day</option>
                                            <option value="Weekly">Weekly</option>
                                            <option value="Monthly">Monthly</option>
                                            <option value="Every 3 months">Every 3 months</option>
                                            <option value="Every 6 months">Every 6 months</option>
                                            <option value="Yearly">Yearly</option>
                                            <option value="Continue">Continue</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <input type="text" id="duration-custom" class="input-field" placeholder="Or enter custom duration (e.g., 7 days, 2 weeks, 1 month)">
                                </div>
                            </div>
                            
                            <!-- Instructions Section -->
                            <div class="border-t pt-4">
                                <label class="label-text font-semibold">Instructions</label>
                                <div class="space-y-3">
                                    <!-- Common Instructions -->
                                    <div>
                                        <label class="label-text text-sm">Common Instructions</label>
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2">
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Take after meals">
                                                <span>Take after meals</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Take before meals">
                                                <span>Take before meals</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Take with meals">
                                                <span>Take with meals</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Take on empty stomach">
                                                <span>Take on empty stomach</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Avoid alcohol">
                                                <span>Avoid alcohol</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Avoid driving">
                                                <span>Avoid driving</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Take with plenty of water">
                                                <span>Take with plenty of water</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Store in refrigerator">
                                                <span>Store in refrigerator</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Shake well before use">
                                                <span>Shake well before use</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Apply to clean skin">
                                                <span>Apply to clean skin</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Avoid sunlight">
                                                <span>Avoid sunlight</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Complete full course">
                                                <span>Complete full course</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Take at same time daily">
                                                <span>Take at same time daily</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Monitor blood sugar">
                                                <span>Monitor blood sugar</span>
                                            </label>
                                            <label class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" class="common-instruction" value="Monitor blood pressure">
                                                <span>Monitor blood pressure</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Custom Instructions -->
                                    <div>
                                        <label class="label-text text-sm">Custom Instructions</label>
                                        <div class="flex gap-2">
                                            <textarea id="medicine-instructions" class="input-field flex-1" rows="2" placeholder="Enter custom instructions..."></textarea>
                                            <button type="button" id="add-instruction-btn" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" title="Add Custom Instruction">
                                                <i class="fa-solid fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Set as Default Instructions -->
                                    <div>
                                        <label class="label-text text-sm">Set as Default Instructions</label>
                                        <div class="flex gap-2 items-center mt-2">
                                            <input type="checkbox" id="set-default-instructions" class="rounded">
                                            <label for="set-default-instructions" class="text-sm text-slate-600">Save these instructions as default for this drug</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-3">
                                <button id="add-medicine-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                                    Add to Prescription
                                </button>
                                <button id="cancel-medicine-btn" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 transition">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                this.attachPrescriptionListeners();
                this.loadCustomOptions();
            },
            
            attachPrescriptionListeners() {
                // Search functionality
                const searchInput = document.getElementById('medicine-search');
                const toggleBtn = document.getElementById('toggle-search-type');
                const searchResults = document.getElementById('medicine-search-results');
                const addNewBtn = document.getElementById('add-new-medicine-btn');
                const detailsForm = document.getElementById('medicine-details-form');
                const addMedicineBtn = document.getElementById('add-medicine-btn');
                const cancelMedicineBtn = document.getElementById('cancel-medicine-btn');
                
                let searchType = 'generic'; // 'generic' or 'brand'
                
                // Toggle search type
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => {
                        searchType = searchType === 'generic' ? 'brand' : 'generic';
                        toggleBtn.textContent = searchType === 'generic' ? 'Generic' : 'Brand';
                        toggleBtn.className = searchType === 'generic' 
                            ? 'px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200'
                            : 'px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200';
                        if (searchInput.value) {
                            app.router.performMedicineSearch(searchInput.value, searchType);
                        }
                    });
                }
                
                // Search input
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const query = e.target.value.trim();
                        if (query.length >= 2) {
                            app.router.performMedicineSearch(query, searchType);
                        } else {
                            searchResults.classList.add('hidden');
                        }
                    });
                    
                    searchInput.addEventListener('focus', () => {
                        if (searchInput.value.trim().length >= 2) {
                            app.router.performMedicineSearch(searchInput.value.trim(), searchType);
                        }
                    });
                }
                
                // Add new medicine button
                if (addNewBtn) {
                    addNewBtn.addEventListener('click', () => {
                        app.handlers.showAddNewMedicineModal();
                    });
                }
                
                // Add medicine to prescription
                if (addMedicineBtn) {
                    addMedicineBtn.addEventListener('click', () => {
                        app.router.addMedicineToPrescription();
                    });
                } else {
                    console.error('Add medicine button not found');
                }
                
                // Cancel medicine selection
                if (cancelMedicineBtn) {
                    cancelMedicineBtn.addEventListener('click', () => {
                        app.router.cancelMedicineSelection();
                    });
                }
                
                // Company selection change
                const companySelect = document.getElementById('medicine-company');
                if (companySelect) {
                    companySelect.addEventListener('change', (e) => {
                        const selectedName = document.getElementById('selected-medicine-name');
                        const genericName = selectedName.value;
                        const selectedCompany = e.target.value;
                        
                        if (genericName && selectedCompany) {
                            app.router.populateTradeNames(genericName, selectedCompany);
                        }
                    });
                }
                
                // Set default company preference
                const setDefaultCheckbox = document.getElementById('set-default-company');
                if (setDefaultCheckbox) {
                    setDefaultCheckbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            const selectedName = document.getElementById('selected-medicine-name');
                            const companySelect = document.getElementById('medicine-company');
                            const genericName = selectedName.value;
                            const selectedCompany = companySelect.value;
                            
                            if (genericName && selectedCompany) {
                                app.utils.setDefaultCompanyPreference(genericName, selectedCompany);
                                alert(`Set ${selectedCompany} as default for ${genericName}`);
                            }
                        }
                    });
                }
                
                // Set default route preference
                const setDefaultRouteCheckbox = document.getElementById('set-default-route');
                if (setDefaultRouteCheckbox) {
                    setDefaultRouteCheckbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            const selectedName = document.getElementById('selected-medicine-name');
                            const routeSelect = document.getElementById('medicine-route');
                            const genericName = selectedName.value;
                            const selectedRoute = routeSelect.value;
                            
                            if (genericName && selectedRoute) {
                                app.utils.setDefaultRoutePreference(genericName, selectedRoute);
                                alert(`Set ${selectedRoute} as default route for ${genericName}`);
                            }
                        }
                    });
                }
                
                // Set default instructions preference
                const setDefaultInstructionsCheckbox = document.getElementById('set-default-instructions');
                if (setDefaultInstructionsCheckbox) {
                    setDefaultInstructionsCheckbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            const selectedName = document.getElementById('selected-medicine-name');
                            const genericName = selectedName.value;
                            const commonInstructions = Array.from(document.querySelectorAll('.common-instruction:checked')).map(cb => cb.value);
                            const customInstructions = document.getElementById('medicine-instructions').value;
                            const allInstructions = [...commonInstructions];
                            if (customInstructions) {
                                allInstructions.push(customInstructions);
                            }
                            
                            if (genericName && allInstructions.length > 0) {
                                app.utils.setDefaultInstructionsPreference(genericName, allInstructions);
                                alert(`Set instructions as default for ${genericName}`);
                            }
                        }
                    });
                }
                
                // Dosage management
                const addDosageBtn = document.getElementById('add-dosage-btn');
                if (addDosageBtn) {
                    addDosageBtn.addEventListener('click', () => {
                        app.router.addDosageRow();
                    });
                }
                
                // Frequency management
                const addFrequencyBtn = document.getElementById('add-frequency-btn');
                const saveCustomFrequencyBtn = document.getElementById('save-custom-frequency');
                const cancelCustomFrequencyBtn = document.getElementById('cancel-custom-frequency');
                
                if (addFrequencyBtn) {
                    addFrequencyBtn.addEventListener('click', () => {
                        document.getElementById('custom-frequency-container').classList.remove('hidden');
                    });
                }
                
                if (saveCustomFrequencyBtn) {
                    saveCustomFrequencyBtn.addEventListener('click', () => {
                        const customInput = document.getElementById('custom-frequency-input');
                        const customValue = customInput.value.trim();
                        if (customValue) {
                            app.router.addCustomFrequency(customValue);
                            customInput.value = '';
                            document.getElementById('custom-frequency-container').classList.add('hidden');
                        }
                    });
                }
                
                if (cancelCustomFrequencyBtn) {
                    cancelCustomFrequencyBtn.addEventListener('click', () => {
                        document.getElementById('custom-frequency-input').value = '';
                        document.getElementById('custom-frequency-container').classList.add('hidden');
                    });
                }
                
                // Instruction management
                const addInstructionBtn = document.getElementById('add-instruction-btn');
                if (addInstructionBtn) {
                    addInstructionBtn.addEventListener('click', () => {
                        const customInput = document.getElementById('medicine-instructions');
                        const customValue = customInput.value.trim();
                        if (customValue) {
                            app.router.addCustomInstruction(customValue);
                            customInput.value = '';
                        }
                    });
                }
                
                // Strength management
                const strengthSelect = document.getElementById('medicine-strength');
                const customStrengthContainer = document.getElementById('custom-strength-container');
                const customStrengthInput = document.getElementById('custom-strength-input');
                
                if (strengthSelect) {
                    strengthSelect.addEventListener('change', (e) => {
                        if (e.target.value === 'custom') {
                            customStrengthContainer.classList.remove('hidden');
                            customStrengthInput.focus();
                        } else {
                            customStrengthContainer.classList.add('hidden');
                            customStrengthInput.value = '';
                        }
                    });
                }
                
                // Custom strength input
                if (customStrengthInput) {
                    customStrengthInput.addEventListener('input', (e) => {
                        const customValue = e.target.value.trim();
                        if (customValue) {
                            // Update the strength select to show the custom value
                            const strengthSelect = document.getElementById('medicine-strength');
                            if (strengthSelect) {
                                // Create a temporary option to show the custom value
                                let customOption = strengthSelect.querySelector('option[value="custom"]');
                                if (customOption) {
                                    customOption.textContent = `Custom: ${customValue}`;
                                }
                            }
                        }
                    });
                }
                
                // Remove prescription buttons
                document.querySelectorAll('.remove-rx-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        app.state.consultationData.prescriptions.splice(index, 1);
                        this.renderConsultationSections();
                        this.updatePrescriptionPreview();
                    });
                });
                
                // Edit prescription buttons
                document.querySelectorAll('.edit-rx-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        this.editPrescription(index);
                    });
                });
                
                // Remove dosage buttons
                document.querySelectorAll('.remove-dosage-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.target.closest('.dosage-row').remove();
                    });
                });
            },
            
            performMedicineSearch(query, searchType) {
                const searchResults = document.getElementById('medicine-search-results');
                const results = [];
                
                if (searchType === 'generic') {
                    // Search in generics
                    Object.keys(MOCK_DATA.MEDICINE_DATABASE.generics).forEach(generic => {
                        if (generic.toLowerCase().includes(query.toLowerCase())) {
                            const genericData = MOCK_DATA.MEDICINE_DATABASE.generics[generic];
                            results.push({
                                name: generic,
                                type: 'generic',
                                data: genericData
                            });
                        }
                    });
                } else {
                    // Search in brand names
                    Object.keys(MOCK_DATA.MEDICINE_DATABASE.brandNames).forEach(brand => {
                        if (brand.toLowerCase().includes(query.toLowerCase())) {
                            const brandData = MOCK_DATA.MEDICINE_DATABASE.brandNames[brand];
                            results.push({
                                name: brand,
                                type: 'brand',
                                data: brandData
                            });
                        }
                    });
                }
                
                // Limit results
                const limitedResults = results.slice(0, 10);
                
                if (limitedResults.length === 0) {
                    searchResults.innerHTML = '<p class="p-4 text-slate-500 text-center">No medicines found. Try adding a new medicine.</p>';
                } else {
                    const resultsHtml = limitedResults.map(result => {
                        if (result.type === 'generic') {
                            const formulations = result.data.formulations.join(', ');
                            const strengths = result.data.strengths.join(', ');
                            return `
                                <div class="p-3 border-b hover:bg-slate-50 cursor-pointer medicine-result" 
                                     data-name="${result.name}" 
                                     data-type="generic"
                                     data-formulations="${result.data.formulations.join('|')}"
                                     data-strengths="${result.data.strengths.join('|')}"
                                     data-companies="${result.data.companies.join('|')}">
                                    <div class="font-semibold text-blue-700">${result.name}</div>
                                    <div class="text-sm text-slate-600">Formulations: ${formulations}</div>
                                    <div class="text-sm text-slate-600">Strengths: ${strengths}</div>
                                    <div class="text-xs text-green-600 mt-1">Click to select</div>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="p-3 border-b hover:bg-slate-50 cursor-pointer medicine-result" 
                                     data-name="${result.name}" 
                                     data-type="brand"
                                     data-generic="${result.data.generic}"
                                     data-strength="${result.data.strength}"
                                     data-formulation="${result.data.formulation}"
                                     data-company="${result.data.company}">
                                    <div class="font-semibold text-green-700">${result.name}</div>
                                    <div class="text-sm text-slate-600">${result.data.generic} ${result.data.strength} ${result.data.formulation}</div>
                                    <div class="text-sm text-slate-600">${result.data.company}</div>
                                    <div class="text-xs text-green-600 mt-1">Click to select</div>
                                </div>
                            `;
                        }
                    }).join('');
                    
                    searchResults.innerHTML = resultsHtml;
                }
                
                searchResults.classList.remove('hidden');
                
                // Add click listeners to results
                document.querySelectorAll('.medicine-result').forEach(result => {
                    result.addEventListener('click', () => {
                        this.selectMedicine(result.dataset);
                    });
                });
            },
            
            selectMedicine(medicineData) {
                const searchInput = document.getElementById('medicine-search');
                const searchResults = document.getElementById('medicine-search-results');
                const detailsForm = document.getElementById('medicine-details-form');
                const selectedName = document.getElementById('selected-medicine-name');
                const companySelect = document.getElementById('medicine-company');
                const tradeNameSelect = document.getElementById('medicine-trade-name');
                
                // Hide search results
                searchResults.classList.add('hidden');
                
                // Set medicine name
                if (medicineData.type === 'generic') {
                    selectedName.value = medicineData.name;
                    
                    // Get default company preference for this generic
                    const defaultCompany = app.utils.getDefaultCompanyForGeneric(medicineData.name);
                    
                    // Populate company options for generic
                    companySelect.innerHTML = '<option value="">Select Company</option>';
                    const companies = medicineData.companies.split('|');
                    companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company;
                        option.textContent = company;
                        companySelect.appendChild(option);
                    });
                    
                    // Auto-select default company if available
                    if (defaultCompany && companies.includes(defaultCompany)) {
                        companySelect.value = defaultCompany;
                        this.populateTradeNames(medicineData.name, defaultCompany);
                    } else if (companies.length > 0) {
                        // Auto-select first available company alphabetically
                        const sortedCompanies = companies.sort();
                        companySelect.value = sortedCompanies[0];
                        this.populateTradeNames(medicineData.name, sortedCompanies[0]);
                    }
                    
                } else {
                    // For brand names, set the generic name as the base medicine name
                    selectedName.value = medicineData.generic;
                    // Set company for brand name
                    companySelect.value = medicineData.company;
                    
                    // Populate trade name for brand selection
                    tradeNameSelect.innerHTML = '<option value="">Select Trade Name</option>';
                    const option = document.createElement('option');
                    option.value = medicineData.name;
                    option.textContent = medicineData.name;
                    option.selected = true;
                    tradeNameSelect.appendChild(option);
                }
                
                // Show details form
                detailsForm.classList.remove('hidden');
                
                // Populate intelligent dosage boxes based on medicine
                this.populateDosageBoxes(medicineData.name);
                
                // Load default preferences for this medicine
                this.loadDefaultPreferences(medicineData.name);
                
                // Clear search input
                searchInput.value = '';
            },
            
            populateTradeNames(genericName, company) {
                const tradeNameSelect = document.getElementById('medicine-trade-name');
                const tradeNames = app.utils.getTradeNamesForGeneric(genericName, company);
                
                tradeNameSelect.innerHTML = '<option value="">Select Trade Name</option>';
                
                if (tradeNames.length > 0) {
                    tradeNames.forEach(tradeName => {
                        const option = document.createElement('option');
                        option.value = tradeName.name;
                        option.textContent = `${tradeName.name} (${tradeName.strength} ${tradeName.formulation})`;
                        tradeNameSelect.appendChild(option);
                    });
                    
                    // Auto-select first trade name
                    tradeNameSelect.value = tradeNames[0].name;
                } else {
                    // If no trade names available, show generic option
                    const option = document.createElement('option');
                    option.value = genericName;
                    option.textContent = `${genericName} (Generic)`;
                    option.selected = true;
                    tradeNameSelect.appendChild(option);
                }
            },
            
            addMedicineToPrescription() {
                const medicineName = document.getElementById('selected-medicine-name').value;
                const tradeName = document.getElementById('medicine-trade-name').value;
                const company = document.getElementById('medicine-company').value;
                const route = document.getElementById('medicine-route').value;
                
                // Get strength
                const strengthSelect = document.getElementById('medicine-strength');
                let strength = '';
                if (strengthSelect) {
                    if (strengthSelect.value === 'custom') {
                        strength = document.getElementById('custom-strength-input').value;
                    } else {
                        strength = strengthSelect.value;
                    }
                }
                
                // Get dosage from multiple inputs with individual frequency and duration
                const dosageRows = document.querySelectorAll('.dosage-row');
                const dosages = [];
                const frequencies = [];
                const durations = [];
                
                dosageRows.forEach(row => {
                    const number = row.querySelector('.dosage-number').value;
                    const unit = row.querySelector('.dosage-unit').value;
                    const custom = row.querySelector('.dosage-custom').value;
                    const frequency = row.querySelector('.dosage-frequency').value;
                    const durationNumber = row.querySelector('.dosage-duration-number').value;
                    const durationUnit = row.querySelector('.dosage-duration-unit').value;
                    
                    let dosage = '';
                    if (number && unit) {
                        dosage = `${number} ${unit}`;
                    } else if (custom) {
                        dosage = custom;
                    }
                    
                    if (dosage) {
                        dosages.push(dosage);
                        frequencies.push(frequency || '');
                        
                        let duration = '';
                        if (durationNumber && durationUnit) {
                            if (durationUnit === 'continue') {
                                duration = 'Continue';
                            } else {
                                duration = `${durationNumber} ${durationUnit}`;
                            }
                        }
                        durations.push(duration);
                    }
                });
                
                // Fallback to main frequency if no individual frequencies set
                const mainFrequency = document.getElementById('medicine-frequency').value;
                
                // Get duration from multiple inputs
                const durationNumber = document.getElementById('duration-number').value;
                const durationUnit = document.getElementById('duration-unit').value;
                const durationPattern = document.getElementById('duration-pattern').value;
                const durationCustom = document.getElementById('duration-custom').value;
                
                let duration = '';
                if (durationNumber && durationUnit) {
                    if (durationUnit === 'continue') {
                        duration = 'Continue';
                    } else {
                        duration = `${durationNumber} ${durationUnit}`;
                        if (durationPattern) {
                            duration += ` (${durationPattern})`;
                        }
                    }
                } else if (durationCustom) {
                    duration = durationCustom;
                }
                
                // Get instructions from checkboxes and custom text
                const commonInstructions = Array.from(document.querySelectorAll('.common-instruction:checked')).map(cb => cb.value);
                const customInstructions = document.getElementById('medicine-instructions').value;
                const allInstructions = [...commonInstructions];
                if (customInstructions) {
                    allInstructions.push(customInstructions);
                }
                const instructions = allInstructions.join('; ');
                
                // Show warning if required fields are missing, but don't prevent addition
                const missingFields = [];
                if (!medicineName) missingFields.push('Medicine Name');
                if (dosages.length === 0) missingFields.push('Dosage');
                if (!mainFrequency) missingFields.push('Frequency');
                if (!duration) missingFields.push('Duration');
                
                if (missingFields.length > 0) {
                    const warningMessage = `Warning: The following fields are empty: ${missingFields.join(', ')}. You can still add the medicine, but please consider filling these fields for a complete prescription.`;
                    if (!confirm(warningMessage + '\n\nDo you want to continue adding this medicine?')) {
                        return;
                    }
                }
                
                // Format the medicine name for display
                let displayName;
                if (tradeName && tradeName !== medicineName) {
                    // If trade name is different from generic name, show trade name
                    displayName = tradeName;
                } else {
                    // If no trade name or same as generic, show generic name
                    displayName = medicineName;
                }
                
                // Create prescription with multiple dosages
                const prescription = {
                    medicineName: displayName,
                    genericName: medicineName,
                    tradeName: tradeName,
                    company: company,
                    route: route || 'Oral',
                    strength: strength,
                    dosages: dosages.map((dose, index) => ({
                        dose: dose,
                        frequency: frequencies[index] || mainFrequency,
                        duration: durations[index] || duration
                    })),
                    dose: dosages.join(' + '),
                    frequency: mainFrequency,
                    duration: duration,
                    instructions: instructions || 'As directed'
                };
                
                console.log('Prescription being added:', prescription);
                
                if (!app.state.consultationData.prescriptions) {
                    app.state.consultationData.prescriptions = [];
                }
                
                app.state.consultationData.prescriptions.push(prescription);
                
                // Save defaults if checkboxes are checked
                const genericName = document.getElementById('selected-medicine-name').value;
                const setDefaultCompany = document.getElementById('set-default-company').checked;
                const setDefaultRoute = document.getElementById('set-default-route').checked;
                const setDefaultInstructions = document.getElementById('set-default-instructions').checked;
                
                if (setDefaultCompany && company) {
                    app.utils.setDefaultCompanyPreference(genericName, company);
                }
                
                if (setDefaultRoute && route) {
                    app.utils.setDefaultRoutePreference(genericName, route);
                }
                
                if (setDefaultInstructions && instructions) {
                    app.utils.setDefaultInstructionsPreference(genericName, allInstructions);
                }
                
                app.router.renderConsultationSections();
                app.router.updatePrescriptionPreview();
                app.router.cancelMedicineSelection();
            },
            
            editPrescription(index) {
                const prescription = app.state.consultationData.prescriptions[index];
                if (!prescription) return;
                
                // Populate the form with existing prescription data
                document.getElementById('selected-medicine-name').value = prescription.genericName || prescription.medicineName;
                document.getElementById('medicine-trade-name').value = prescription.tradeName || '';
                document.getElementById('medicine-company').value = prescription.company || '';
                document.getElementById('medicine-route').value = prescription.route || '';
                
                // Set strength
                if (prescription.strength) {
                    const strengthSelect = document.getElementById('medicine-strength');
                    if (strengthSelect) {
                        // Check if the strength exists in dropdown
                        const existingOption = Array.from(strengthSelect.options).find(opt => opt.value === prescription.strength);
                        if (existingOption) {
                            strengthSelect.value = prescription.strength;
                        } else {
                            // Set to custom and populate custom input
                            strengthSelect.value = 'custom';
                            document.getElementById('custom-strength-input').value = prescription.strength;
                            document.getElementById('custom-strength-container').classList.remove('hidden');
                        }
                    }
                }
                
                // Set frequency
                document.getElementById('medicine-frequency').value = prescription.frequency || '';
                
                // Set duration
                if (prescription.duration) {
                    const durationMatch = prescription.duration.match(/(\d+)\s+(\w+)/);
                    if (durationMatch) {
                        document.getElementById('duration-number').value = durationMatch[1];
                        document.getElementById('duration-unit').value = durationMatch[2];
                    } else {
                        document.getElementById('duration-custom').value = prescription.duration;
                    }
                }
                
                // Set instructions
                if (prescription.instructions && prescription.instructions !== 'As directed') {
                    document.getElementById('medicine-instructions').value = prescription.instructions;
                }
                
                // Populate dosage rows with existing data
                if (prescription.dosages && prescription.dosages.length > 0) {
                    app.router.populateDosageBoxesForEdit(prescription.dosages);
                } else {
                    // Fallback to old format - populate with single dosage
                    app.router.populateDosageBoxes('');
                }
                
                // Show the form
                document.getElementById('medicine-details-form').classList.remove('hidden');
                
                // Store the index for updating
                document.getElementById('medicine-details-form').dataset.editIndex = index;
                
                // Change button text and handler
                const addBtn = document.getElementById('add-medicine-btn');
                if (addBtn) {
                    addBtn.textContent = 'Update Medicine';
                    // Remove existing event listeners and add new one
                    addBtn.replaceWith(addBtn.cloneNode(true));
                    const newAddBtn = document.getElementById('add-medicine-btn');
                    newAddBtn.addEventListener('click', () => app.router.updatePrescription(index));
                }
            },
            
            updatePrescription(index) {
                // Remove the old prescription
                app.state.consultationData.prescriptions.splice(index, 1);
                
                // Add the updated prescription
                app.router.addMedicineToPrescription();
                
                // Reset button
                const addBtn = document.getElementById('add-medicine-btn');
                if (addBtn) {
                    addBtn.textContent = 'Add to Prescription';
                    // Remove existing event listeners and add new one
                    addBtn.replaceWith(addBtn.cloneNode(true));
                    const newAddBtn = document.getElementById('add-medicine-btn');
                    newAddBtn.addEventListener('click', () => app.router.addMedicineToPrescription());
                }
            },
            
            cancelMedicineSelection() {
                const detailsForm = document.getElementById('medicine-details-form');
                const searchInput = document.getElementById('medicine-search');
                
                detailsForm.classList.add('hidden');
                searchInput.value = '';
                
                // Clear form fields
                document.getElementById('selected-medicine-name').value = '';
                document.getElementById('medicine-trade-name').value = '';
                document.getElementById('medicine-company').value = '';
                document.getElementById('medicine-route').value = '';
                
                // Clear dosage fields - populate with default 3 boxes
                app.router.populateDosageBoxes('');
                
                // Clear frequency fields
                document.getElementById('medicine-frequency').value = '';
                document.getElementById('custom-frequency-container').classList.add('hidden');
                document.getElementById('custom-frequency-input').value = '';
                
                // Clear duration fields
                document.getElementById('duration-number').value = '';
                document.getElementById('duration-unit').value = '';
                document.getElementById('duration-pattern').value = '';
                document.getElementById('duration-custom').value = '';
                
                // Clear instruction fields
                document.querySelectorAll('.common-instruction').forEach(cb => cb.checked = false);
                document.getElementById('medicine-instructions').value = '';
                
                // Clear default checkboxes
                document.getElementById('set-default-company').checked = false;
                document.getElementById('set-default-route').checked = false;
                document.getElementById('set-default-instructions').checked = false;
                
                // Reset button to original state
                const addBtn = document.getElementById('add-medicine-btn');
                if (addBtn) {
                    addBtn.textContent = 'Add to Prescription';
                    // Remove existing event listeners and add new one
                    addBtn.replaceWith(addBtn.cloneNode(true));
                    const newAddBtn = document.getElementById('add-medicine-btn');
                    newAddBtn.addEventListener('click', () => app.router.addMedicineToPrescription());
                }
            },
            updateLiveSummary() {
                const { history, examinations, investigations, prescriptions, pastMedicalHistory, drugHistory, familyHistory, menstrualHistory, obsGynaeHistory, personalHistory, socioeconomicHistory, occupationalHistory, immunizationHistory } = app.state.consultationData;
                const container = document.getElementById('live-summary-content');
                if (!container) return;
                
                let historyHtml = history.map(symptom => {
                    const data = symptom.data;
                    if (Object.keys(data).length === 0 && !data.patientWords) return '';
                    let narrative = `<div class="p-2 border-l-4 border-blue-500 bg-blue-50 mb-4"><h4 class="font-bold text-base">${symptom.name}</h4><p>Patient reports <strong>${symptom.name.toLowerCase()}</strong>, describing it as <em>"${data.patientWords || '...'}"</em>.</p>`;
                    let details = '';
                    const protocol = MOCK_DATA.SYMPTOM_PROTOCOLS[symptom.name];
                    if(protocol) {
                        Object.values(protocol.content).flat().forEach(q => {
                            const value = data[q.id];
                            if (value && (Array.isArray(value) ? value.length > 0 : value.toString().length > 0)) { 
                                details += `<li><strong>${q.label}:</strong> ${Array.isArray(value) ? value.join(', ') : value}</li>`; 
                            }
                        });
                    }
                    if (details) { narrative += `<ul>${details}</ul>`; }
                    return narrative + `</div>`;
                }).join('');

                let examHtml = '';
                if (examinations) {
                    Object.keys(examinations).forEach(sys => {
                        const findings = examinations[sys];
                        if (Object.keys(findings).length > 0) {
                            examHtml += `<div class="p-2 border-l-4 border-purple-500 bg-purple-50 mb-4"><h4 class="font-bold text-base">${sys}</h4><ul>${Object.entries(findings).map(([k,v]) => v ? `<li><strong>${k}:</strong> ${v}</li>` : '').join('')}</ul></div>`;
                        }
                    });
                }

                container.innerHTML = `
                    <div><h4 class="font-semibold text-slate-700 border-b pb-1 mb-2">History of Presenting Complaint</h4>${historyHtml || '<p class="text-slate-400">None recorded.</p>'}</div>
                    <div><h4 class="font-semibold text-slate-700 border-b pb-1 mb-2">Past Medical History</h4><ul class="list-disc list-inside space-y-1">${(pastMedicalHistory || []).map(f => `<li>${f}</li>`).join('') || '<li class="text-slate-400 list-none">None</li>'}</ul></div>
                    <div><h4 class="font-semibold text-slate-700 border-b pb-1 mb-2">Drug History</h4><ul class="list-disc list-inside space-y-1">${(drugHistory || []).map(f => `<li>${f}</li>`).join('') || '<li class="text-slate-400 list-none">None</li>'}</ul></div>
                    <div><h4 class="font-semibold text-slate-700 border-b pb-1 mb-2">Family History</h4><ul class="list-disc list-inside space-y-1">${(familyHistory || []).map(f => `<li>${f}</li>`).join('') || '<li class="text-slate-400 list-none">None</li>'}</ul></div>
                    <div><h4 class="font-semibold text-slate-700 border-b pb-1 mb-2">Menstrual History</h4><ul class="list-disc list-inside space-y-1">${(menstrualHistory || []).map(f => `<li>${f}</li>`).join('') || '<li class="text-slate-400 list-none">None</li>'}</ul></div>
                    <div><h4 class="font-semibold text-slate-700 border-b pb-1 mb-2">Obstetric & Gynecological History</h4><ul class="list-disc list-inside space-y-1">${(obsGynaeHistory || []).map(f => `<li>${f}</li>`).join('') || '<li class="text-slate-400 list-none">None</li>'}</ul></div>
                    <div><h4 class="font-semibold text-slate-700 border-b pb-1 mb-2">Personal History</h4><ul class="list-disc list-inside space-y-1">${(personalHistory || []).map(f => `<li>${f}</li>`).join('') || '<li class="text-slate-400 list-none">None</li>'}</ul></div>
                    <div><h4 class="font-semibold text-slate-700 border-b pb-1 mb-2">Socioeconomic History</h4><ul class="list-disc list-inside space-y-1">${(socioeconomicHistory || []).map(f => `<li>${f}</li>`).join('') || '<li class="text-slate-400 list-none">None</li>'}</ul></div>
                    <div><h4 class="font-semibold text-slate-700 border-b pb-1 mb-2">Occupational History</h4><ul class="list-disc list-inside space-y-1">${(occupationalHistory || []).map(f => `<li>${f}</li>`).join('') || '<li class="text-slate-400 list-none">None</li>'}</ul></div>
                    <div><h4 class="font-semibold text-slate-700 border-b pb-1 mb-2">Immunization History</h4><ul class="list-disc list-inside space-y-1">${(immunizationHistory || []).map(f => `<li>${f}</li>`).join('') || '<li class="text-slate-400 list-none">None</li>'}</ul></div>
                    <div><h4 class="font-semibold text-slate-700 border-b pb-1 mb-2">Examination</h4>${examHtml || '<p class="text-slate-400">None recorded.</p>'}</div>
                    <div><h4 class="font-semibold text-slate-700 border-b pb-1 mb-2">Investigations</h4><ul class="list-disc list-inside space-y-1">${(investigations || []).map(i => `<li>${i.name}${i.timing ? ` (${i.timing})` : ''}${i.details ? ` - ${i.details}` : ''}</li>`).join('') || '<li class="text-slate-400 list-none">None</li>'}</ul></div>
                    <div><h4 class="font-semibold text-slate-700 border-b pb-1 mb-2">Prescription</h4><ul class="list-disc list-inside space-y-1">${prescriptions.map(p => {
                        // Use strength from prescription object
                        let drugStrength = p.strength || '';
                        
                        // Handle multiple dosages
                        let prescriptionLines = [];
                        if (p.dosages && p.dosages.length > 0) {
                            p.dosages.forEach((dosage, dosageIndex) => {
                                let prescriptionLine = `Tablet ${p.medicineName}`;
                                if (drugStrength) {
                                    prescriptionLine += ` ${drugStrength}`;
                                }
                                prescriptionLine += ` ${dosage.dose} ${dosage.frequency.toLowerCase()} for ${dosage.duration} ${p.route || 'oral'}`;
                                
                                if (p.instructions && p.instructions !== 'As directed') {
                                    prescriptionLine += ` after meal`;
                                }
                                
                                prescriptionLines.push(prescriptionLine);
                            });
                        } else {
                            // Fallback to old format
                            let formattedDose = p.dose;
                            if (p.dose.match(/^\d+(\+\d+)*$/)) {
                                formattedDose = p.dose;
                            }
                            
                            let prescriptionLine = `Tablet ${p.medicineName}`;
                            if (drugStrength) {
                                prescriptionLine += ` ${drugStrength}`;
                            }
                            prescriptionLine += ` ${formattedDose} ${p.frequency.toLowerCase()} for ${p.duration} ${p.route || 'oral'}`;
                            
                            if (p.instructions && p.instructions !== 'As directed') {
                                prescriptionLine += ` after meal`;
                            }
                            
                            prescriptionLines.push(prescriptionLine);
                        }
                        
                        return prescriptionLines.map((line, lineIndex) => 
                            `<li>${line}</li>`
                        ).join('');
                    }).join('') || '<li class="text-slate-400 list-none">None</li>'}</ul></div>
                `;
                
                // Update prescription preview
                this.updatePrescriptionPreview();
            },
            
            updatePrescriptionPreview() {
                const previewContainer = document.getElementById('prescription-preview');
                const totalMedicines = document.getElementById('total-medicines');
                const lastUpdated = document.getElementById('last-updated');
                const prescriptions = app.state.consultationData.prescriptions || [];
                
                if (prescriptions.length === 0) {
                    previewContainer.innerHTML = '<div class="text-slate-400 text-center py-4">No medicines added yet.</div>';
                    totalMedicines.textContent = '0';
                    lastUpdated.textContent = '-';
                    return;
                }
                
                const previewHtml = prescriptions.map((rx, index) => {
                    // Use strength from prescription object
                    let drugStrength = rx.strength || '';
                    
                    // Handle multiple dosages
                    let prescriptionLines = [];
                    if (rx.dosages && rx.dosages.length > 0) {
                        rx.dosages.forEach((dosage, dosageIndex) => {
                            let prescriptionLine = `Tablet ${rx.medicineName}`;
                            if (drugStrength) {
                                prescriptionLine += ` ${drugStrength}`;
                            }
                            prescriptionLine += ` ${dosage.dose} ${dosage.frequency.toLowerCase()} for ${dosage.duration} ${rx.route || 'oral'}`;
                            
                            if (rx.instructions && rx.instructions !== 'As directed') {
                                prescriptionLine += ` after meal`;
                            }
                            
                            prescriptionLines.push(prescriptionLine);
                        });
                    } else {
                        // Fallback to old format
                        let formattedDose = rx.dose;
                        if (rx.dose.match(/^\d+(\+\d+)*$/)) {
                            formattedDose = rx.dose;
                        }
                        
                        let prescriptionLine = `Tablet ${rx.medicineName}`;
                        if (drugStrength) {
                            prescriptionLine += ` ${drugStrength}`;
                        }
                        prescriptionLine += ` ${formattedDose} ${rx.frequency.toLowerCase()} for ${rx.duration} ${rx.route || 'oral'}`;
                        
                        if (rx.instructions && rx.instructions !== 'As directed') {
                            prescriptionLine += ` after meal`;
                        }
                        
                        prescriptionLines.push(prescriptionLine);
                    }
                    
                    return `
                        <div class="bg-slate-50 p-3 rounded-md border-l-4 border-blue-500">
                            ${prescriptionLines.map((line, lineIndex) => 
                                `<div class="font-semibold text-blue-700">${index + 1}.${lineIndex > 0 ? String.fromCharCode(97 + lineIndex) : ''} ${line}</div>`
                            ).join('')}
                        </div>
                    `;
                }).join('');
                
                previewContainer.innerHTML = previewHtml;
                totalMedicines.textContent = prescriptions.length;
                lastUpdated.textContent = new Date().toLocaleTimeString();
            },
            
            createDosageRow() {
                const newRow = document.createElement('div');
                newRow.className = 'dosage-row border p-3 rounded-md bg-slate-50';
                newRow.innerHTML = `
                    <div class="flex gap-2 items-center mb-2">
                        <select class="dosage-number input-field w-20">
                            <option value="">#</option>
                            <option value="0.25">0.25</option>
                            <option value="0.5">0.5</option>
                            <option value="0.75">0.75</option>
                            <option value="1">1</option>
                            <option value="1.25">1.25</option>
                            <option value="1.5">1.5</option>
                            <option value="2">2</option>
                            <option value="2.5">2.5</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                            <option value="25">25</option>
                            <option value="30">30</option>
                            <option value="40">40</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="250">250</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                        </select>
                        <select class="dosage-unit input-field w-24">
                            <option value="">Unit</option>
                            <option value="mg">mg</option>
                            <option value="g">g</option>
                            <option value="ml">ml</option>
                            <option value="mcg">mcg</option>
                            <option value="IU">IU</option>
                            <option value="units">units</option>
                            <option value="drops">drops</option>
                            <option value="tablet">tablet</option>
                            <option value="capsule">capsule</option>
                            <option value="vial">vial</option>
                            <option value="ampoule">ampoule</option>
                            <option value="sachet">sachet</option>
                            <option value="spoonful">spoonful</option>
                            <option value="puff">puff</option>
                            <option value="patch">patch</option>
                        </select>
                        <input type="text" class="dosage-custom input-field flex-1" placeholder="Custom (e.g., 1+0+1)">
                        <button type="button" class="remove-dosage-btn px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600" title="Remove">-</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div>
                            <label class="label-text text-xs">Frequency</label>
                            <select class="dosage-frequency input-field text-sm">
                                <option value="">Select Frequency</option>
                                <option value="Once daily (OD)">Once daily (OD)</option>
                                <option value="Twice daily (BD)">Twice daily (BD)</option>
                                <option value="Thrice daily (TDS)">Thrice daily (TDS)</option>
                                <option value="Four times daily (QID)">Four times daily (QID)</option>
                                <option value="Every 6 hours">Every 6 hours</option>
                                <option value="Every 8 hours">Every 8 hours</option>
                                <option value="Every 12 hours">Every 12 hours</option>
                                <option value="Every 4 hours">Every 4 hours</option>
                                <option value="Every 2 hours">Every 2 hours</option>
                                <option value="Every hour">Every hour</option>
                                <option value="As needed (PRN)">As needed (PRN)</option>
                                <option value="Before meals">Before meals</option>
                                <option value="After meals">After meals</option>
                                <option value="With meals">With meals</option>
                                <option value="At bedtime">At bedtime</option>
                                <option value="On empty stomach">On empty stomach</option>
                                <option value="Every alternate day">Every alternate day</option>
                                <option value="Weekly">Weekly</option>
                                <option value="Monthly">Monthly</option>
                            </select>
                        </div>
                        <div>
                            <label class="label-text text-xs">Duration</label>
                            <div class="flex gap-1">
                                <select class="dosage-duration-number input-field text-sm w-16">
                                    <option value="">#</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="5">5</option>
                                    <option value="7">7</option>
                                    <option value="10">10</option>
                                    <option value="14">14</option>
                                    <option value="21">21</option>
                                    <option value="28">28</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                    <option value="60">60</option>
                                    <option value="90">90</option>
                                    <option value="180">180</option>
                                    <option value="365">365</option>
                                </select>
                                <select class="dosage-duration-unit input-field text-sm w-20">
                                    <option value="">Unit</option>
                                    <option value="days">Days</option>
                                    <option value="weeks">Weeks</option>
                                    <option value="months">Months</option>
                                    <option value="years">Years</option>
                                    <option value="continue">Continue</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listener for remove button
                newRow.querySelector('.remove-dosage-btn').addEventListener('click', () => {
                    newRow.remove();
                });
                
                return newRow;
            },
            
            addDosageRow() {
                const container = document.getElementById('dosage-container');
                const newRow = app.router.createDosageRow();
                container.appendChild(newRow);
            },
            
            populateDosageBoxes(genericName) {
                const container = document.getElementById('dosage-container');
                container.innerHTML = ''; // Clear existing boxes
                
                // Get intelligent dosage pattern based on medicine
                const dosagePattern = app.router.getIntelligentDosagePattern(genericName);
                
                // Create dosage boxes based on pattern
                dosagePattern.forEach((dosage, index) => {
                    const newRow = app.router.createDosageRow();
                    
                    // Pre-populate with intelligent defaults
                    if (dosage.number) {
                        newRow.querySelector('.dosage-number').value = dosage.number;
                    }
                    if (dosage.unit) {
                        newRow.querySelector('.dosage-unit').value = dosage.unit;
                    }
                    if (dosage.custom) {
                        newRow.querySelector('.dosage-custom').value = dosage.custom;
                    }
                    
                    container.appendChild(newRow);
                });
            },
            
            populateDosageBoxesForEdit(dosages) {
                const container = document.getElementById('dosage-container');
                container.innerHTML = ''; // Clear existing boxes
                
                // Create dosage boxes based on existing prescription data
                dosages.forEach((dosage, index) => {
                    const newRow = app.router.createDosageRow();
                    
                    // Parse dose to extract number and unit
                    const doseMatch = dosage.dose.match(/^(\d+(?:\.\d+)?)\s+(\w+)$/);
                    if (doseMatch) {
                        newRow.querySelector('.dosage-number').value = doseMatch[1];
                        newRow.querySelector('.dosage-unit').value = doseMatch[2];
                    } else {
                        // If not a standard format, put in custom field
                        newRow.querySelector('.dosage-custom').value = dosage.dose;
                    }
                    
                    // Set frequency
                    if (dosage.frequency) {
                        newRow.querySelector('.dosage-frequency').value = dosage.frequency;
                    }
                    
                    // Set duration
                    if (dosage.duration) {
                        const durationMatch = dosage.duration.match(/^(\d+)\s+(\w+)$/);
                        if (durationMatch) {
                            newRow.querySelector('.dosage-duration-number').value = durationMatch[1];
                            newRow.querySelector('.dosage-duration-unit').value = durationMatch[2];
                        }
                    }
                    
                    container.appendChild(newRow);
                });
            },
            
            getIntelligentDosagePattern(genericName) {
                // Common prescribing patterns based on medicine type
                const patterns = {
                    // Analgesics and Anti-inflammatory
                    'Paracetamol': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    'Ibuprofen': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    'Diclofenac': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    'Naproxen': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    
                    // Antibiotics
                    'Amoxicillin': [
                        { number: '1', unit: 'capsule' },
                        { number: '1', unit: 'capsule' },
                        { number: '1', unit: 'capsule' }
                    ],
                    'Azithromycin': [
                        { number: '1', unit: 'tablet' }
                    ],
                    'Ciprofloxacin': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    'Doxycycline': [
                        { number: '1', unit: 'capsule' },
                        { number: '1', unit: 'capsule' }
                    ],
                    
                    // Anti-ulcer and GI
                    'Omeprazole': [
                        { number: '1', unit: 'capsule' },
                        { number: '1', unit: 'capsule' }
                    ],
                    'Pantoprazole': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    'Ranitidine': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    
                    // Anti-hypertensive
                    'Amlodipine': [
                        { number: '1', unit: 'tablet' }
                    ],
                    'Losartan': [
                        { number: '1', unit: 'tablet' }
                    ],
                    'Metoprolol': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    'Atenolol': [
                        { number: '1', unit: 'tablet' }
                    ],
                    
                    // Anti-diabetic
                    'Metformin': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    'Gliclazide': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    
                    // Anti-asthma
                    'Salbutamol': [
                        { number: '1', unit: 'puff' },
                        { number: '1', unit: 'puff' },
                        { number: '1', unit: 'puff' },
                        { number: '1', unit: 'puff' }
                    ],
                    'Budesonide': [
                        { number: '1', unit: 'puff' },
                        { number: '1', unit: 'puff' }
                    ],
                    
                    // Vitamins and Supplements
                    'Vitamin D': [
                        { number: '1', unit: 'tablet' }
                    ],
                    'Calcium': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    'Iron': [
                        { number: '1', unit: 'tablet' }
                    ],
                    
                    // Anti-allergic
                    'Cetirizine': [
                        { number: '1', unit: 'tablet' }
                    ],
                    'Loratadine': [
                        { number: '1', unit: 'tablet' }
                    ],
                    'Fexofenadine': [
                        { number: '1', unit: 'tablet' }
                    ],
                    
                    // Anti-emetic
                    'Ondansetron': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    'Domperidone': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    
                    // Anti-spasmodic
                    'Dicyclomine': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ],
                    'Hyoscine': [
                        { number: '1', unit: 'tablet' },
                        { number: '1', unit: 'tablet' }
                    ]
                };
                
                // Check for exact match first
                if (patterns[genericName]) {
                    return patterns[genericName];
                }
                
                // Check for partial matches (case-insensitive)
                const lowerGenericName = genericName.toLowerCase();
                for (const [key, pattern] of Object.entries(patterns)) {
                    if (lowerGenericName.includes(key.toLowerCase()) || key.toLowerCase().includes(lowerGenericName)) {
                        return pattern;
                    }
                }
                
                // Default pattern: 3 boxes with common defaults
                return [
                    { number: '1', unit: 'tablet' },
                    { number: '1', unit: 'tablet' },
                    { number: '1', unit: 'tablet' }
                ];
            },
            
            addCustomInstruction(instruction) {
                // Add as a checkbox option
                const container = document.querySelector('.grid.grid-cols-2.md\\:grid-cols-3.gap-2.mt-2');
                const newLabel = document.createElement('label');
                newLabel.className = 'flex items-center gap-2 text-sm';
                newLabel.innerHTML = `
                    <input type="checkbox" class="common-instruction" value="${instruction}">
                    <span>${instruction}</span>
                `;
                container.appendChild(newLabel);
                
                // Save to localStorage for future use
                const customInstructions = JSON.parse(localStorage.getItem('customInstructions') || '[]');
                if (!customInstructions.includes(instruction)) {
                    customInstructions.push(instruction);
                    localStorage.setItem('customInstructions', JSON.stringify(customInstructions));
                }
            },
            
            loadCustomOptions() {
                // Load custom frequencies
                const customFrequencies = JSON.parse(localStorage.getItem('customFrequencies') || '[]');
                const frequencySelect = document.getElementById('medicine-frequency');
                customFrequencies.forEach(freq => {
                    if (!Array.from(frequencySelect.options).some(opt => opt.value === freq)) {
                        const option = document.createElement('option');
                        option.value = freq;
                        option.textContent = freq;
                        frequencySelect.appendChild(option);
                    }
                });
                
                // Load custom instructions
                const customInstructions = JSON.parse(localStorage.getItem('customInstructions') || '[]');
                const instructionContainer = document.querySelector('.grid.grid-cols-2.md\\:grid-cols-3.gap-2.mt-2');
                if (instructionContainer) {
                    customInstructions.forEach(instruction => {
                        if (!document.querySelector(`input[value="${instruction}"]`)) {
                            const newLabel = document.createElement('label');
                            newLabel.className = 'flex items-center gap-2 text-sm';
                            newLabel.innerHTML = `
                                <input type="checkbox" class="common-instruction" value="${instruction}">
                                <span>${instruction}</span>
                            `;
                            instructionContainer.appendChild(newLabel);
                        }
                    });
                }
            },
            
            addCustomFrequency(frequency) {
                const select = document.getElementById('medicine-frequency');
                const option = document.createElement('option');
                option.value = frequency;
                option.textContent = frequency;
                select.appendChild(option);
                select.value = frequency;
                
                // Save to localStorage for future use
                const customFrequencies = JSON.parse(localStorage.getItem('customFrequencies') || '[]');
                if (!customFrequencies.includes(frequency)) {
                    customFrequencies.push(frequency);
                    localStorage.setItem('customFrequencies', JSON.stringify(customFrequencies));
                }
            },
            
            loadDefaultPreferences(genericName) {
                // Load default route
                const defaultRoute = app.utils.getDefaultRoutePreference(genericName);
                if (defaultRoute) {
                    document.getElementById('medicine-route').value = defaultRoute;
                }
                
                // Load default frequency
                const defaultFrequency = app.utils.getDefaultFrequencyPreference(genericName);
                if (defaultFrequency) {
                    document.getElementById('medicine-frequency').value = defaultFrequency;
                }
                
                // Load default duration
                const defaultDuration = app.utils.getDefaultDurationPreference(genericName);
                if (defaultDuration) {
                    // Parse duration and set fields
                    const durationMatch = defaultDuration.match(/(\d+)\s+(\w+)/);
                    if (durationMatch) {
                        document.getElementById('duration-number').value = durationMatch[1];
                        document.getElementById('duration-unit').value = durationMatch[2];
                    } else {
                        document.getElementById('duration-custom').value = defaultDuration;
                    }
                }
                
                // Load default instructions
                const defaultInstructions = app.utils.getDefaultInstructionsPreference(genericName);
                if (defaultInstructions && defaultInstructions.length > 0) {
                    // Clear existing selections
                    document.querySelectorAll('.common-instruction').forEach(cb => cb.checked = false);
                    
                    // Check the default instructions
                    defaultInstructions.forEach(instruction => {
                        const checkbox = document.querySelector(`input[value="${instruction}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
                
                // Load default dosage
                const defaultDosage = app.utils.getDefaultDosagePreference(genericName);
                if (defaultDosage) {
                    // Clear existing dosage rows
                    const dosageContainer = document.getElementById('dosage-container');
                    dosageContainer.innerHTML = '';
                    
                    // Parse dosage and create rows
                    const dosages = defaultDosage.split(' + ');
                    dosages.forEach(dosage => {
                        const newRow = this.createDosageRow();
                        const dosageMatch = dosage.match(/(\d+(?:\.\d+)?)\s+(\w+)/);
                        if (dosageMatch) {
                            newRow.querySelector('.dosage-number').value = dosageMatch[1];
                            newRow.querySelector('.dosage-unit').value = dosageMatch[2];
                        } else {
                            newRow.querySelector('.dosage-custom').value = dosage;
                        }
                        dosageContainer.appendChild(newRow);
                    });
                }
            }
        },
        handlers: {
            showLoginModal(role) {
                const modalContainer = document.getElementById('modal-container');
                modalContainer.innerHTML = templates.loginModal(role);
                modalContainer.querySelector('#cancel-login').onclick = () => modalContainer.innerHTML = '';
                modalContainer.querySelector('#login-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const username = modalContainer.querySelector('#login-username').value;
                    const password = modalContainer.querySelector('#login-password').value;
                    const user = await dataService.validateLogin(role, username, password);
                    if (user) { app.state.currentUser = { type: role, data: user }; modalContainer.innerHTML = ''; window.location.hash = `${role}/${user.username}`; } 
                    else { modalContainer.querySelector('#login-error').textContent = 'Invalid credentials.'; modalContainer.querySelector('#login-error').classList.remove('hidden'); }
                };
            },
            showAddPatientModal(doctorId) {
                const modalContainer = document.getElementById('modal-container');
                modalContainer.innerHTML = templates.addPatientModal();
                modalContainer.querySelector('#cancel-add-patient').onclick = () => modalContainer.innerHTML = '';
                modalContainer.querySelector('#add-patient-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const patientData = { name: form.name.value, dob: form.dob.value, gender: form.gender.value, phone: form.phone.value };
                    const newPatientId = await dataService.addPatient(patientData);
                    alert(`Patient ${patientData.name} added successfully!`);
                    modalContainer.innerHTML = '';
                    app.router.loadAppointments(doctorId, new Date().toISOString().split('T')[0]);
                };
            },
            async showAddAppointmentModal(doctorId) {
                const modalContainer = document.getElementById('modal-container');
                modalContainer.innerHTML = templates.addAppointmentModal();
                const patientSelect = modalContainer.querySelector('#patient-select-for-appt');
                const patients = await db.patients.toArray();
                patientSelect.innerHTML = '<option value="">Select Patient</option>' + patients.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                modalContainer.querySelector('#cancel-add-appointment').onclick = () => modalContainer.innerHTML = '';
                modalContainer.querySelector('#add-appointment-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const appointmentData = { patientId: parseInt(form.patientId.value), doctorId, date: form.date.value, timeSlot: form.timeSlot.value, status: 'confirmed' };
                    const apptId = await dataService.addAppointment(appointmentData);
                    modalContainer.innerHTML = '';
                    if (form.consultNow.checked) {
                        window.location.hash = `consultation/${apptId}`;
                    } else {
                        document.getElementById('appointment-date-picker').value = form.date.value;
                        app.router.loadAppointments(doctorId, form.date.value);
                    }
                };
            },
            async saveConsultation(doctor) {
                const appointmentId = app.state.selectedAppointmentId;
                const appointment = await db.appointments.get(appointmentId);
                const consultationRecord = {
                    appointmentId: appointmentId,
                    patientId: appointment.patientId,
                    doctorId: doctor.id,
                    date: new Date().toISOString(),
                    data: app.state.consultationData
                };
                await db.consultations.put(consultationRecord);
                await db.appointments.update(appointmentId, { status: 'completed' });
                alert('Consultation saved successfully!');
                window.location.hash = `doctor/${doctor.username}`;
            },
            addSymptom(symptomName) {
                if (app.state.consultationData.history.some(s => s.name === symptomName)) return;
                const newSymptom = { id: `symptom-${Date.now()}`, name: symptomName, data: {} };
                app.state.consultationData.history.push(newSymptom);
                app.router.renderSymptomCard(newSymptom);
                app.router.updateLiveSummary();
            },
            handleSymptomCardClick(e, symptom) {
                const target = e.target;
                if (target.classList.contains('remove-symptom-btn')) {
                    const index = app.state.consultationData.history.findIndex(s => s.id === symptom.id);
                    if (index > -1) { app.state.consultationData.history.splice(index, 1); document.getElementById(symptom.id).remove(); app.router.updateLiveSummary(); }
                } else if (target.classList.contains('tab-btn')) {
                    const tab = target.dataset.tab;
                    target.parentElement.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    target.classList.add('active');
                    app.router.renderSymptomTabContent(symptom, tab);
                } else if (target.classList.contains('quick-pick-btn')) {
                    target.classList.toggle('selected');
                    const container = target.closest('div');
                    const selectedBtns = Array.from(container.querySelectorAll('.quick-pick-btn.selected'));
                    const value = selectedBtns.map(b => b.dataset.value).join(', ');
                    const inputEl = container.previousElementSibling;
                    inputEl.value = value;
                    this.updateSymptomData(symptom, inputEl.dataset.field, value);
                } else if (target.classList.contains('add-option-btn')) {
                    const input = target.previousElementSibling;
                    const value = input.value.trim();
                    if (value) {
                        app.utils.addCustomOption(target.dataset.key, value);
                        const cardContainer = document.getElementById('symptom-cards-container');
                        const card = cardContainer.querySelector(`#${symptom.id}`);
                        if(card) card.remove();
                        app.router.renderSymptomCard(symptom);
                    }
                }
            },
            handleSymptomCardInput(e, symptom) {
                const target = e.target;
                const field = target.dataset.field;
                if (!field) return;

                let value;
                if (target.type === 'checkbox') {
                    const container = target.closest(`[data-field="${field}"]`);
                    value = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
                    // Force immediate update for checkboxes
                    this.updateSymptomData(symptom, field, value);
                } else {
                    value = target.value;
                    this.updateSymptomData(symptom, field, value);
                }
            },
            updateSymptomData(symptom, field, value) {
                const index = app.state.consultationData.history.findIndex(s => s.id === symptom.id);
                if (index > -1) {
                    app.state.consultationData.history[index].data[field] = value;
                    app.router.updateLiveSummary();
                }
            },
            generatePdf(doctor) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18); doc.setFont("helvetica", "bold"); doc.text(doctor.name, 20, 20);
                doc.setFontSize(12); doc.setFont("helvetica", "normal"); doc.text(doctor.title, 20, 27);
                doc.text(`BMDC Reg: ${doctor.bmdc}`, 20, 34); doc.text(`Contact: ${doctor.contact}`, 20, 41);
                doc.line(20, 45, 190, 45);
                doc.setFontSize(22); doc.setFont("helvetica", "bold"); doc.text("Rx.", 20, 60);
                let yPos = 70;
                doc.setFontSize(12); doc.setFont("helvetica", "normal");
                const rxList = app.state.consultationData.prescriptions || [];
                console.log('Prescriptions for PDF:', rxList);
                rxList.forEach((rx, index) => {
                    // Get drug strength from trade name or generic data
                    let drugStrength = rx.strength || '';
                    console.log(`Medicine ${index + 1}:`, rx.medicineName, 'Strength:', drugStrength, 'Frequency:', rx.frequency, 'Duration:', rx.duration);
                    
                    // Format dose more concisely
                    let formattedDose = rx.dose;
                    if (rx.dose.includes(' + ')) {
                        const doseParts = rx.dose.split(' + ');
                        const numbers = doseParts.map(part => {
                            const match = part.match(/(\d+(?:\.\d+)?)/);
                            return match ? match[1] : '1';
                        });
                        formattedDose = numbers.join('+');
                    }
                    
                    // Create concise prescription line
                    let prescriptionLine = `Tablet ${rx.medicineName}`;
                    if (drugStrength) {
                        prescriptionLine += ` ${drugStrength}`;
                    }
                    prescriptionLine += ` ${formattedDose} ${rx.frequency.toLowerCase()} for ${rx.duration} ${rx.route || 'Oral'}`;
                    
                    if (rx.instructions && rx.instructions !== 'As directed') {
                        prescriptionLine += ` ${rx.instructions}`;
                    }
                    
                    // Split into two lines if too long
                    const maxLineLength = 80;
                    if (prescriptionLine.length > maxLineLength) {
                        const words = prescriptionLine.split(' ');
                        let line1 = '';
                        let line2 = '';
                        let currentLine = '';
                        
                        for (let word of words) {
                            if ((currentLine + ' ' + word).length <= maxLineLength) {
                                currentLine += (currentLine ? ' ' : '') + word;
                            } else {
                                if (!line1) {
                                    line1 = currentLine;
                                    currentLine = word;
                                } else {
                                    line2 = currentLine + ' ' + word;
                                    break;
                                }
                            }
                        }
                        
                        if (!line2) line2 = currentLine;
                        
                        doc.text(`${index + 1}. ${line1}`, 25, yPos); yPos += 7;
                        if (line2) {
                            doc.text(`   ${line2}`, 25, yPos); yPos += 7;
                        }
                    } else {
                        doc.text(`${index + 1}. ${prescriptionLine}`, 25, yPos); yPos += 7;
                    }
                    
                    yPos += 5;
                });
                doc.line(20, 280, 190, 280); doc.setFontSize(10); doc.text("Generated by EMR System", 105, 285, null, null, "center");
                doc.save("prescription.pdf");
            },
            
            showAddNewMedicineModal() {
                const modalContainer = document.getElementById('modal-container');
                modalContainer.innerHTML = templates.addNewMedicineModal();
                
                let combinationCount = 1;
                
                // Add company button functionality
                const addCompanyBtn = modalContainer.querySelector('#add-company-btn');
                if (addCompanyBtn) {
                    addCompanyBtn.onclick = () => {
                        const companyName = prompt('Enter new pharmaceutical company name:');
                        if (companyName && companyName.trim()) {
                            const companySelect = modalContainer.querySelector('#company-select');
                            const option = document.createElement('option');
                            option.value = companyName.trim();
                            option.textContent = companyName.trim();
                            companySelect.appendChild(option);
                            companySelect.value = companyName.trim();
                            
                            // Add to all existing generics
                            Object.keys(MOCK_DATA.MEDICINE_DATABASE.generics).forEach(generic => {
                                if (!MOCK_DATA.MEDICINE_DATABASE.generics[generic].companies.includes(companyName.trim())) {
                                    MOCK_DATA.MEDICINE_DATABASE.generics[generic].companies.push(companyName.trim());
                                }
                            });
                        }
                    };
                }
                
                // Add combination medicine button functionality
                modalContainer.querySelector('#add-combination-medicine-btn').onclick = () => {
                    combinationCount++;
                    const container = modalContainer.querySelector('#combination-medicines-container');
                    const newRow = document.createElement('div');
                    newRow.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 combination-medicine-row';
                    newRow.innerHTML = `
                        <div>
                            <label class="label-text">${combinationCount === 2 ? 'Second' : combinationCount === 3 ? 'Third' : combinationCount === 4 ? 'Fourth' : combinationCount + 'th'} Medicine Name</label>
                            <input name="medicine${combinationCount}Name" class="input-field" placeholder="e.g., Clavulanic Acid">
                        </div>
                        <div>
                            <label class="label-text">${combinationCount === 2 ? 'Second' : combinationCount === 3 ? 'Third' : combinationCount === 4 ? 'Fourth' : combinationCount + 'th'} Medicine Strength</label>
                            <input name="medicine${combinationCount}Strength" class="input-field" placeholder="e.g., 125mg">
                        </div>
                    `;
                    container.appendChild(newRow);
                    
                    // Show remove button if more than 1 combination medicine
                    if (combinationCount > 1) {
                        modalContainer.querySelector('#remove-combination-medicine-btn').classList.remove('hidden');
                    }
                };
                
                // Remove combination medicine button functionality
                modalContainer.querySelector('#remove-combination-medicine-btn').onclick = () => {
                    if (combinationCount > 1) {
                        const container = modalContainer.querySelector('#combination-medicines-container');
                        const rows = container.querySelectorAll('.combination-medicine-row');
                        if (rows.length > 1) {
                            container.removeChild(rows[rows.length - 1]);
                            combinationCount--;
                            
                            // Hide remove button if only 1 combination medicine left
                            if (combinationCount === 1) {
                                modalContainer.querySelector('#remove-combination-medicine-btn').classList.add('hidden');
                            }
                        }
                    }
                };
                
                modalContainer.querySelector('#cancel-add-new-medicine').onclick = () => modalContainer.innerHTML = '';
                
                modalContainer.querySelector('#add-new-medicine-form').onsubmit = (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const formData = new FormData(form);
                    
                    const newMedicine = {
                        genericName: formData.get('genericName'),
                        formulation: formData.get('formulation'),
                        strength: formData.get('strength'),
                        company: formData.get('company'),
                        combinationMedicines: []
                    };
                    
                    // Collect all combination medicines
                    for (let i = 2; i <= combinationCount; i++) {
                        const medicineName = formData.get(`medicine${i}Name`);
                        const medicineStrength = formData.get(`medicine${i}Strength`);
                        if (medicineName && medicineStrength) {
                            newMedicine.combinationMedicines.push({
                                name: medicineName,
                                strength: medicineStrength
                            });
                        }
                    }
                    
                    // Add to medicine database
                    if (!MOCK_DATA.MEDICINE_DATABASE.generics[newMedicine.genericName]) {
                        MOCK_DATA.MEDICINE_DATABASE.generics[newMedicine.genericName] = {
                            formulations: [newMedicine.formulation],
                            strengths: [newMedicine.strength],
                            companies: [newMedicine.company]
                        };
                    } else {
                        // Add new formulation if not exists
                        if (!MOCK_DATA.MEDICINE_DATABASE.generics[newMedicine.genericName].formulations.includes(newMedicine.formulation)) {
                            MOCK_DATA.MEDICINE_DATABASE.generics[newMedicine.genericName].formulations.push(newMedicine.formulation);
                        }
                        // Add new strength if not exists
                        if (!MOCK_DATA.MEDICINE_DATABASE.generics[newMedicine.genericName].strengths.includes(newMedicine.strength)) {
                            MOCK_DATA.MEDICINE_DATABASE.generics[newMedicine.genericName].strengths.push(newMedicine.strength);
                        }
                        // Add new company if not exists
                        if (!MOCK_DATA.MEDICINE_DATABASE.generics[newMedicine.genericName].companies.includes(newMedicine.company)) {
                            MOCK_DATA.MEDICINE_DATABASE.generics[newMedicine.genericName].companies.push(newMedicine.company);
                        }
                    }
                    
                    // If it's a combination medicine, create a brand name entry
                    if (newMedicine.combinationMedicines.length > 0) {
                        const combinationNames = [newMedicine.genericName, ...newMedicine.combinationMedicines.map(m => m.name)];
                        const combinationStrengths = [newMedicine.strength, ...newMedicine.combinationMedicines.map(m => m.strength)];
                        const combinationName = combinationNames.join(' + ');
                        const brandName = combinationNames.join('');
                        
                        MOCK_DATA.MEDICINE_DATABASE.brandNames[brandName] = {
                            generic: combinationName,
                            strength: combinationStrengths.join(' + '),
                            formulation: newMedicine.formulation,
                            company: newMedicine.company
                        };
                    }
                    
                    alert(`Medicine "${newMedicine.genericName}" added successfully!`);
                    modalContainer.innerHTML = '';
                    
                    // Refresh prescription section to show new medicine
                    app.router.renderPrescriptionSection();
                };
            }
        }
    };
    window.app = app;
    app.init();
    })();
  </script>

  <!-- Utility: Script to convert old medicine-data.json to new format (run in browser console) -->
  <script id="convert-medicine-json" type="text/plain">
    /*
    Paste this in the browser console on a page where medicine-data.json is loaded as a JS variable named `oldData` (array of objects):
    */
    function convertOldMedicineData(oldData) {
      const generics = {};
      const brandNames = {};
      oldData.forEach(item => {
        // GENERICS
        const generic = item.generic_name || item.medicine_name;
        if (!generics[generic]) {
          generics[generic] = { formulations: [], strengths: [], companies: [] };
        }
        if (item.dosage_form && !generics[generic].formulations.includes(item.dosage_form)) {
          generics[generic].formulations.push(item.dosage_form);
        }
        if (item.power_strength && !generics[generic].strengths.includes(item.power_strength)) {
          generics[generic].strengths.push(item.power_strength);
        }
        if (item.company && !generics[generic].companies.includes(item.company)) {
          generics[generic].companies.push(item.company);
        }
        // BRAND NAMES (if medicine_name is a brand and generic_name is present)
        if (item.generic_name && item.medicine_name && item.medicine_name !== item.generic_name) {
          brandNames[item.medicine_name] = {
            generic: item.generic_name,
            strength: item.power_strength || '',
            formulation: item.dosage_form || '',
            company: item.company || ''
          };
        }
      });
      return { generics, brandNames };
    }
    // Example usage:
    // const newData = convertOldMedicineData(oldData);
    // console.log(JSON.stringify(newData, null, 2));
  </script>

</body>
</html>
