# Lab Event-Driven Flow - Visual Architecture

## ğŸ¯ Complete System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         EMR/HMS Event-Driven Architecture                    â”‚
â”‚                              Lab Service Example                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Lab Portal      â”‚  Lab technician enters results
â”‚   (Port 5176)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ HTTP POST /api/lab/orders/{id}/results
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LAB SERVICE (Port 3013)                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ LabOrdersController                                          â”‚            â”‚
â”‚  â”‚   â†“                                                          â”‚            â”‚
â”‚  â”‚ LabOrdersService.submitResult()                             â”‚            â”‚
â”‚  â”‚   â”œâ”€ Update database (Prisma)                               â”‚            â”‚
â”‚  â”‚   â”œâ”€ Detect critical values                                 â”‚            â”‚
â”‚  â”‚   â””â”€ Publish events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”˜            â”‚
â”‚                                                              â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”            â”‚
â”‚  â”‚ LabEventPublisher                                            â”‚            â”‚
â”‚  â”‚  â”œâ”€ publishLabResultAvailable()                             â”‚            â”‚
â”‚  â”‚  â””â”€ publishCriticalLabAlert()  (if critical)                â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â”‚ Events published
                                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NATS JETSTREAM (Port 4222)                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Message Bus                                                 â”‚             â”‚
â”‚  â”‚  â”œâ”€ lab.order.created                                      â”‚             â”‚
â”‚  â”‚  â”œâ”€ lab.result.available                                   â”‚             â”‚
â”‚  â”‚  â”œâ”€ lab.critical.alert                                     â”‚             â”‚
â”‚  â”‚  â””â”€ lab.result.viewed                                      â”‚             â”‚
â”‚  â”‚                                                             â”‚             â”‚
â”‚  â”‚ Features:                                                   â”‚             â”‚
â”‚  â”‚  âœ“ At-least-once delivery                                  â”‚             â”‚
â”‚  â”‚  âœ“ Queue groups for load balancing                         â”‚             â”‚
â”‚  â”‚  âœ“ Message persistence (JetStream)                         â”‚             â”‚
â”‚  â”‚  âœ“ Replay capability                                        â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                              â”‚
        â–¼                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AGGREGATION SERVICE         â”‚      â”‚ NOTIFICATION SERVICE        â”‚
â”‚ (Port 3020)                 â”‚      â”‚ (Port 3021)                 â”‚
â”‚                             â”‚      â”‚                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ LabEventHandler         â”‚ â”‚      â”‚ â”‚ LabNotificationHandler  â”‚ â”‚
â”‚ â”‚                         â”‚ â”‚      â”‚ â”‚                         â”‚ â”‚
â”‚ â”‚ @EventPattern(          â”‚ â”‚      â”‚ â”‚ @EventPattern(          â”‚ â”‚
â”‚ â”‚   'lab.result.available'â”‚ â”‚      â”‚ â”‚   'lab.result.available'â”‚ â”‚
â”‚ â”‚ )                       â”‚ â”‚      â”‚ â”‚ )                       â”‚ â”‚
â”‚ â”‚                         â”‚ â”‚      â”‚ â”‚ â†“                       â”‚ â”‚
â”‚ â”‚ handleLabResult()       â”‚ â”‚      â”‚ â”‚ Send WebSocket          â”‚ â”‚
â”‚ â”‚  â”œâ”€ Create LabResultViewâ”‚ â”‚      â”‚ â”‚   notification          â”‚ â”‚
â”‚ â”‚  â”œâ”€ Update Patient      â”‚ â”‚      â”‚ â”‚                         â”‚ â”‚
â”‚ â”‚  â”‚   Aggregate          â”‚ â”‚      â”‚ â”‚ @EventPattern(          â”‚ â”‚
â”‚ â”‚  â””â”€ Update counters     â”‚ â”‚      â”‚ â”‚   'lab.critical.alert'  â”‚ â”‚
â”‚ â”‚                         â”‚ â”‚      â”‚ â”‚ )                       â”‚ â”‚
â”‚ â”‚ @EventPattern(          â”‚ â”‚      â”‚ â”‚ â†“                       â”‚ â”‚
â”‚ â”‚   'lab.critical.alert'  â”‚ â”‚      â”‚ â”‚ Send CRITICAL alert     â”‚ â”‚
â”‚ â”‚ )                       â”‚ â”‚      â”‚ â”‚   with sound            â”‚ â”‚
â”‚ â”‚ â†“                       â”‚ â”‚      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ Store critical details  â”‚ â”‚      â”‚           â”‚                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚           â”‚                 â”‚                  â”‚
â”‚           â–¼                 â”‚                  â”‚ WebSocket (Socket.io)
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                  â”‚
â”‚  â”‚ PostgreSQL           â”‚   â”‚                  â”‚
â”‚  â”‚ (Aggregation Schema) â”‚   â”‚                  â–¼
â”‚  â”‚                      â”‚   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ Tables:              â”‚   â”‚      â”‚ PROVIDER PORTAL             â”‚
â”‚  â”‚  â”œâ”€ LabResultView    â”‚   â”‚      â”‚ (Port 5174)                 â”‚
â”‚  â”‚  â”œâ”€ Patient          â”‚   â”‚      â”‚                             â”‚
â”‚  â”‚  â”‚   AggregateView   â”‚   â”‚      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â””â”€ AuditLog         â”‚   â”‚      â”‚ â”‚ useNotifications() hook â”‚ â”‚
â”‚  â”‚                      â”‚   â”‚      â”‚ â”‚  â†“                      â”‚ â”‚
â”‚  â”‚ Benefits:            â”‚   â”‚      â”‚ â”‚ Connect to WebSocket    â”‚ â”‚
â”‚  â”‚  âœ“ Fast queries      â”‚   â”‚      â”‚ â”‚   ws://localhost:3021   â”‚ â”‚
â”‚  â”‚  âœ“ No joins needed   â”‚   â”‚      â”‚ â”‚                         â”‚ â”‚
â”‚  â”‚  âœ“ Read-optimized    â”‚   â”‚      â”‚ â”‚ on('notification')      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚      â”‚ â”‚  â”œâ”€ Update badge        â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚  â”œâ”€ Show notification   â”‚ â”‚
                                     â”‚ â”‚  â”œâ”€ Play sound          â”‚ â”‚
                                     â”‚ â”‚  â””â”€ Browser notify      â”‚ â”‚
                                     â”‚ â”‚                         â”‚ â”‚
                                     â”‚ â”‚ on('critical_alert')    â”‚ â”‚
                                     â”‚ â”‚  â”œâ”€ Show prominently    â”‚ â”‚
                                     â”‚ â”‚  â”œâ”€ Play urgent sound   â”‚ â”‚
                                     â”‚ â”‚  â”œâ”€ Require ACK         â”‚ â”‚
                                     â”‚ â”‚  â””â”€ Desktop notify      â”‚ â”‚
                                     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                     â”‚           â”‚                 â”‚
                                     â”‚           â–¼                 â”‚
                                     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                                     â”‚ â”‚ NotificationPanel       â”‚ â”‚
                                     â”‚ â”‚                         â”‚ â”‚
                                     â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
                                     â”‚ â”‚ â”‚ ğŸš¨ CRITICAL ALERT   â”‚ â”‚ â”‚
                                     â”‚ â”‚ â”‚ Potassium = 7.5     â”‚ â”‚ â”‚
                                     â”‚ â”‚ â”‚ Requires ACK        â”‚ â”‚ â”‚
                                     â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
                                     â”‚ â”‚                         â”‚ â”‚
                                     â”‚ â”‚ ğŸ”” Lab Results Availableâ”‚ â”‚
                                     â”‚ â”‚ ğŸ”” Order Created        â”‚ â”‚
                                     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## â±ï¸ Latency Timeline

```
Time (ms)    Event
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0            Lab tech clicks "Submit Result"
             â”‚
5            HTTP request reaches Lab Service
             â”‚
15           Database updated (Prisma transaction)
             â”‚
20           Event published to NATS
             â”‚
25           NATS receives event
             â”‚
30           Aggregation Service receives event
             â”‚
35           Notification Service receives event
             â”‚
40           Read model updated in PostgreSQL
             â”‚
45           WebSocket message sent to frontend
             â”‚
50           Browser receives notification
             â”‚
55           UI updates (notification appears)
             â”‚
60           Audio alert plays
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total: ~60ms from submit to notification display
```

## ğŸ”„ Event Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. EVENT CREATION                                                â”‚
â”‚    â”œâ”€ Generate unique eventId (UUID v4)                         â”‚
â”‚    â”œâ”€ Add timestamp (ISO 8601)                                  â”‚
â”‚    â”œâ”€ Include userId (HIPAA audit)                              â”‚
â”‚    â”œâ”€ Add FHIR resource (compliance)                            â”‚
â”‚    â””â”€ Attach portal type                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. EVENT PUBLISHING (Lab Service)                               â”‚
â”‚    â”œâ”€ natsClient.emit('lab.result.available', event)           â”‚
â”‚    â”œâ”€ Non-blocking publish                                      â”‚
â”‚    â”œâ”€ Retry on failure (3 attempts)                             â”‚
â”‚    â””â”€ Log publish success/failure                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. MESSAGE BROKER (NATS JetStream)                              â”‚
â”‚    â”œâ”€ Persist message to disk                                   â”‚
â”‚    â”œâ”€ Distribute to all subscribers                             â”‚
â”‚    â”œâ”€ Queue group load balancing                                â”‚
â”‚    â””â”€ Track acknowledgments                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4A. AGGREGATION            â”‚  â”‚ 4B. NOTIFICATION               â”‚
â”‚     (CQRS Read Model)      â”‚  â”‚     (Real-time Alert)          â”‚
â”‚                            â”‚  â”‚                                â”‚
â”‚ â”œâ”€ Check idempotency       â”‚  â”‚ â”œâ”€ Extract notification data  â”‚
â”‚ â”‚   (eventId processed?)   â”‚  â”‚ â”œâ”€ Determine priority          â”‚
â”‚ â”œâ”€ Update LabResultView    â”‚  â”‚ â”œâ”€ Find connected users        â”‚
â”‚ â”œâ”€ Update Patient          â”‚  â”‚ â”‚   (WebSocket mapping)        â”‚
â”‚ â”‚   Aggregate              â”‚  â”‚ â”œâ”€ Send to user's sockets      â”‚
â”‚ â”œâ”€ Create AuditLog         â”‚  â”‚ â””â”€ Log delivery                â”‚
â”‚ â””â”€ Mark as processed       â”‚  â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â†“
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚ 5. FRONTEND RECEIPT          â”‚
                                 â”‚                              â”‚
                                 â”‚ â”œâ”€ WebSocket message arrives â”‚
                                 â”‚ â”œâ”€ Update React state        â”‚
                                 â”‚ â”œâ”€ Trigger re-render         â”‚
                                 â”‚ â”œâ”€ Show notification         â”‚
                                 â”‚ â”œâ”€ Play audio alert          â”‚
                                 â”‚ â””â”€ Browser notification      â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Security & Compliance Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HIPAA AUDIT TRAIL                                                â”‚
â”‚                                                                  â”‚
â”‚ Event Published:                                                 â”‚
â”‚  â”œâ”€ userId: "lab-tech-001"     â† Who performed the action       â”‚
â”‚  â”œâ”€ timestamp: "2025-01-11..."  â† When it happened              â”‚
â”‚  â”œâ”€ eventId: "uuid-v4"          â† Unique identifier             â”‚
â”‚  â””â”€ portalType: "LAB"           â† Source of action              â”‚
â”‚                                                                  â”‚
â”‚ Aggregation Service:                                             â”‚
â”‚  â”œâ”€ Creates AuditLog entry                                       â”‚
â”‚  â”œâ”€ Stores who, what, when, where                                â”‚
â”‚  â””â”€ Immutable record                                             â”‚
â”‚                                                                  â”‚
â”‚ Result Viewed Event:                                             â”‚
â”‚  â”œâ”€ userId: "provider-123"      â† Who viewed PHI                â”‚
â”‚  â”œâ”€ ipAddress: "192.168.1.100"  â† From where                    â”‚
â”‚  â”œâ”€ timestamp: "2025-01-11..."  â† When viewed                   â”‚
â”‚  â””â”€ Logged to AuditLog                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FHIR R4 COMPLIANCE                                               â”‚
â”‚                                                                  â”‚
â”‚ ServiceRequest (Lab Order):                                      â”‚
â”‚  {                                                               â”‚
â”‚    resourceType: "ServiceRequest",                              â”‚
â”‚    status: "active",                                            â”‚
â”‚    intent: "order",                                             â”‚
â”‚    code: { coding: [{ system: "http://loinc.org", ... }] }     â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚ DiagnosticReport (Lab Result):                                  â”‚
â”‚  {                                                               â”‚
â”‚    resourceType: "DiagnosticReport",                            â”‚
â”‚    status: "final",                                             â”‚
â”‚    subject: { reference: "Patient/123" },                       â”‚
â”‚    performer: [{ reference: "Practitioner/456" }]               â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚ Observation (Critical Value):                                   â”‚
â”‚  {                                                               â”‚
â”‚    resourceType: "Observation",                                 â”‚
â”‚    status: "final",                                             â”‚
â”‚    code: { coding: [{ system: "http://loinc.org", ... }] },    â”‚
â”‚    valueQuantity: { value: 7.5, unit: "mmol/L" }               â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Scalability Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HORIZONTAL SCALING                                                â”‚
â”‚                                                                   â”‚
â”‚ Lab Service (Multiple Instances):                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Instance 1 â”‚  â”‚ Instance 2 â”‚  â”‚ Instance 3 â”‚                 â”‚
â”‚  â”‚ Port 3013  â”‚  â”‚ Port 3014  â”‚  â”‚ Port 3015  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                         â”‚                                         â”‚
â”‚                         â–¼                                         â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                  â”‚    NATS     â”‚  All instances publish          â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                         â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â–¼               â–¼               â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Aggregationâ”‚  â”‚ Aggregationâ”‚  â”‚ Aggregationâ”‚                 â”‚
â”‚  â”‚ Instance 1 â”‚  â”‚ Instance 2 â”‚  â”‚ Instance 3 â”‚                 â”‚
â”‚  â”‚ Queue: agg â”‚  â”‚ Queue: agg â”‚  â”‚ Queue: agg â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                   â”‚
â”‚  NATS Queue Groups ensure each event processed once              â”‚
â”‚  Load balanced across all instances                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**This visual architecture demonstrates the complete event-driven flow from Lab Service to Frontend with real-time notifications!** ğŸš€
