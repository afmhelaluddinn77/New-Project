generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrderPriority {
  ROUTINE
  URGENT
  STAT
}

enum LabOrderStatus {
  NEW
  IN_PROGRESS
  RESULT_READY
  VERIFIED
  CANCELLED
}

enum LabTestStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CRITICAL
}

enum AbnormalFlag {
  NORMAL
  LOW
  HIGH
  CRITICAL
}

model LabOrder {
  id            String          @id @default(uuid())
  orderNumber   String          @unique
  patientId     String
  providerId    String
  encounterId   String
  priority      OrderPriority
  status        LabOrderStatus  @default(NEW)
  clinicalNotes String?
  orderedAt     DateTime        @default(now())
  resultedAt    DateTime?
  verifiedAt    DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  tests         LabOrderTest[]

  @@index([patientId])
  @@index([providerId])
}

model LabOrderTest {
  id          String        @id @default(uuid())
  labOrderId  String
  loincCode   String
  testName    String
  specimenType String?
  status      LabTestStatus @default(PENDING)
  performedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  labOrder    LabOrder      @relation(fields: [labOrderId], references: [id], onDelete: Cascade)
  result      LabResult?

  @@index([labOrderId])
  @@index([loincCode])
}

model LabResult {
  id              String        @id @default(uuid())
  labOrderTestId  String        @unique
  value           String
  unit            String
  referenceRange  String?
  abnormalFlag    AbnormalFlag  @default(NORMAL)
  comment         String?
  verifiedBy      String?
  verifiedAt      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  test            LabOrderTest  @relation(fields: [labOrderTestId], references: [id], onDelete: Cascade)
  components      LabResultComponent[]
}

/// Detailed result components for each LabResult (e.g., individual analytes)
model LabResultComponent {
  id                  String   @id @default(uuid())
  labResultId         String
  code                String
  name                String
  displayName         String
  value               String
  numericValue        Float?
  unit                String
  referenceRangeLow   Float?
  referenceRangeHigh  Float?
  referenceRangeText  String?
  interpretation      String
  trend               String?
  criticalValue       Boolean  @default(false)
  comment             String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  labResult           LabResult @relation(fields: [labResultId], references: [id], onDelete: Cascade)

  @@index([labResultId])
  @@index([code])
}

/// Historical values to support trend analysis
model LabResultHistory {
  id             String   @id @default(uuid())
  patientId      String
  testCode       String
  componentCode  String
  value          String?
  numericValue   Float?
  unit           String?
  interpretation String?
  performedAt    DateTime
  orderId        String?
  createdAt      DateTime @default(now())

  @@index([patientId])
  @@index([componentCode])
  @@index([performedAt])
}

/// Standardized test templates with predefined component definitions
model LabTestTemplate {
  id        String                       @id @default(uuid())
  loincCode String                       @unique
  testName  String
  components LabTestTemplateComponent[]
}

model LabTestTemplateComponent {
  id                 String          @id @default(uuid())
  templateId         String
  code               String
  name               String
  displayName        String?
  unit               String?
  referenceRangeLow  Float?
  referenceRangeHigh Float?
  referenceRangeText String?
  sortOrder          Int             @default(0)

  template           LabTestTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([code])
}

/// Export jobs for lab results (stores parameters and output path)
model LabResultExport {
  id           String   @id @default(uuid())
  patientId    String
  orderIds     String[]
  format       String
  requestedBy  String
  parameters   Json?
  status       String
  filePath     String?
  errorMessage String?
  createdAt    DateTime @default(now())
  completedAt  DateTime?
}
